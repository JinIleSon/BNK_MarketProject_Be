<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.bnk_marketproject_be.mapper.MypageAllOrderMapper">

    <!-- ✅ 주문 + 상품 리스트를 한번에 매핑 -->
    <select id="findAllOrdersByUserId" resultMap="OrderWithItemsMap">
        SELECT
            o.id AS order_id,
            o.users_id,
            o.status,
            o.total_amount,
            TO_CHAR(o.created_at, 'YYYY-MM-DD') AS created_at,
            o.order_code AS order_code,

            u.user_id AS userId,
            u.name AS user_name,
            p.method AS method,

            -- ✅ 판매자 정보 조인 (SELLERS + USERS)
            s.brand_name AS company_name,
            s.seller_id AS seller_id,
            s.biz_registration_number AS seller_bizno,
            s.mail_order_number AS seller_mailnum,
            us.name AS seller_rep,
            us.email AS seller_email,
            us.phone AS seller_tel,
            (us.address || ' ' || us.detail_address) AS seller_addr,

            oi.id AS order_item_id,
            oi.products_id AS products_id,
            pr.product_name AS product_name,
            (CASE
                 WHEN NVL(oi.price, 0) != 0 THEN oi.price
                 ELSE pr.price
                END) AS price_fixed,
            oi.quantity AS quantity,
            pi.url AS url
        FROM ORDERS o
                 JOIN USERS u ON o.users_id = u.id
                 LEFT JOIN PAYMENTS p ON p.orders_id = o.id
                 LEFT JOIN ORDER_ITEMS oi ON oi.orders_id = o.id
                 LEFT JOIN PRODUCTS pr ON oi.products_id = pr.id
                 LEFT JOIN SELLERS s ON pr.sellers_id = s.id
                 LEFT JOIN USERS us ON s.users_id = us.id
                 LEFT JOIN PRODUCT_IMAGES pi ON pi.products_id = pr.id AND pi.is_main = 'Y'
        WHERE o.users_id = #{userId}
        ORDER BY o.created_at DESC, pr.product_name ASC,oi.id ASC
    </select>

    <!-- ✅ 매핑 정의 -->
    <resultMap id="OrderWithItemsMap" type="kr.co.bnk_marketproject_be.dto.OrdersDTO">
        <id property="id" column="order_id"/>
        <result property="users_id" column="users_id"/>
        <result property="status" column="status"/>
        <result property="total_amount" column="total_amount"/>
        <result property="created_at" column="created_at"/>
        <result property="order_code" column="order_code"/>
        <result property="userId" column="userId"/>
        <result property="user_name" column="user_name"/>
        <result property="method" column="method"/>

        <!-- ✅ 판매자 정보는 OrdersDTO 에 직접 매핑 -->
        <result property="company_name" column="company_name"/>
        <result property="seller_id" column="seller_id"/>
        <result property="seller_rep" column="seller_rep"/>
        <result property="seller_tel" column="seller_tel"/>
        <result property="seller_email" column="seller_email"/>
        <result property="seller_bizno" column="seller_bizno"/>
        <result property="seller_mailnum" column="seller_mailnum"/>
        <result property="seller_addr" column="seller_addr"/>

        <!-- ✅ 배송 정보 매핑 -->
        <result property="recipient" column="recipient"/>
        <result property="address" column="address"/>
        <result property="delivery_company" column="delivery_company"/>
        <result property="invoice" column="invoice"/>
        <result property="delivery_status" column="delivery_status"/>
        <result property="delivery_phone" column="delivery_phone"/>

        <result property="payment_amount" column="payment_amount"/>


        <collection property="orderItems" ofType="kr.co.bnk_marketproject_be.dto.OrderItemsDTO" autoMapping="true">
            <id property="id" column="order_item_id"/>
            <result property="products_id" column="products_id"/>
            <result property="productName" column="product_name"/>
            <result property="price" column="price_fixed"/>
            <result property="quantity" column="quantity"/>
            <result property="url" column="url"/>
        </collection>
    </resultMap>




    <!-- ✅ 단일 주문 상세 조회 -->
    <select id="findOrderDetailByCode" resultMap="OrderWithItemsMap">
        SELECT
            -- [ORDERS]
            o.id                     AS order_id,
            o.users_id               AS users_id,
            o.status                 AS status,
            o.total_amount           AS total_amount,
            TO_CHAR(o.created_at, 'YYYY-MM-DD HH24:MI:SS') AS created_at,
            o.order_code             AS order_code,

            -- [USERS]
            u.name                   AS user_name,
            u.phone                  AS user_phone,

            -- [DELIVERIES]
            d.recipient              AS recipient,
            d.hp                     AS delivery_phone,
            d.address                AS address,
            d.delicom                AS delivery_company,
            d.invoice                AS invoice,
            NVL(d.status, '배송정보 없음') AS delivery_status,

            -- [PAYMENTS]
            p.method                 AS method,

            -- [SELLERS + 대표자정보]
            s.brand_name             AS company_name,
            s.seller_id              AS seller_id,
            s.biz_registration_number AS seller_bizno,
            s.mail_order_number      AS seller_mailnum,
            us.name                  AS seller_rep,
            us.phone                 AS seller_tel,
            us.email                 AS seller_email,
            (us.address || ' ' || us.detail_address) AS seller_addr,

            -- [ORDER_ITEMS + PRODUCTS]
            oi.id                    AS order_item_id,
            oi.products_id           AS products_id,
            oi.quantity              AS quantity,
            NVL(oi.price, pr.price)  AS price_fixed,
            pr.product_name          AS product_name,

            -- [PRODUCT_IMAGES]
            pi.url                   AS url,

            -- ✅ 결제금액 계산식 추가
            (NVL(oi.price, pr.price) * oi.quantity) AS payment_amount

        FROM ORDERS o
                 JOIN USERS u ON o.users_id = u.id
                 LEFT JOIN PAYMENTS p ON p.orders_id = o.id
                 LEFT JOIN ORDER_ITEMS oi ON oi.orders_id = o.id
                 LEFT JOIN PRODUCTS pr ON oi.products_id = pr.id
                 LEFT JOIN PRODUCT_IMAGES pi ON pi.products_id = pr.id AND pi.IS_MAIN = 'Y'
                 LEFT JOIN SELLERS s ON pr.sellers_id = s.id
                 LEFT JOIN USERS us ON s.users_id = us.id
                 LEFT JOIN (
            SELECT *
            FROM (
                     SELECT d.*, ROW_NUMBER() OVER (PARTITION BY orders_id ORDER BY id DESC) AS rn
                     FROM DELIVERIES d
                 )
            WHERE rn = 1
        ) d ON d.orders_id = o.id

        WHERE o.order_code = #{orderCode}
    </select>



    <!-- 페이징된 주문 목록 -->
    <select id="findPagedOrders" resultType="kr.co.bnk_marketproject_be.dto.OrdersDTO">
        SELECT *
        FROM (
        SELECT
        o.id,
        o.users_id,
        o.status,
        o.total_amount,
        TO_CHAR(o.created_at, 'YYYY-MM-DD') AS created_at,
        o.order_code,

        u.user_id       AS userId,
        u.name          AS user_name,
        p.method        AS method,

        pr.product_name AS product_name,
        pr.price        AS price,
        s.brand_name    AS company_name,
        oi.quantity     AS quantity,
        pi.url          AS url,
        ROWNUM AS rn
        FROM ORDERS o
        JOIN USERS u ON o.users_id = u.id
        LEFT JOIN PAYMENTS p ON p.orders_id = o.id
        LEFT JOIN ORDER_ITEMS oi ON oi.orders_id = o.id
        LEFT JOIN PRODUCTS pr ON oi.products_id = pr.id
        LEFT JOIN SELLERS s ON pr.sellers_id = s.id
        LEFT JOIN PRODUCT_IMAGES pi
        ON pi.products_id = pr.id
        AND pi.is_main = 'Y'
        WHERE o.users_id = #{userId}
        AND ROWNUM &lt;= ( #{pageRequest.pg} * #{pageRequest.size} )
        ORDER BY o.created_at DESC
             )
        WHERE rn > ((#{pageRequest.pg} - 1) * #{pageRequest.size})
    </select>

    <!-- 전체 주문 개수 -->
    <select id="countOrdersByUserId" resultType="int">
        SELECT COUNT(*) FROM ORDERS WHERE users_id = #{userId}
    </select>

    <!-- ========================= -->
    <!--  [상품평 관련 기능 섹션]  -->
    <!-- ========================= -->

    <insert id="insertProductBoard" parameterType="kr.co.bnk_marketproject_be.dto.ProductBoardsDTO">
        INSERT INTO PRODUCT_BOARDS (
            PRODUCTS_ID, USERS_ID, TYPE, TITLE, CONTENT, RATING, CREATED_AT
        ) VALUES (
                     #{products_id},
                     #{users_id},
                     #{type},
                     #{title},
                     #{content},
                     #{rating},
                     SYSTIMESTAMP
                 )
    </insert>

    <select id="findProductBoardsByProductId" resultType="kr.co.bnk_marketproject_be.dto.ProductBoardsDTO">
        SELECT
            pb.id,
            pb.products_id,
            pb.users_id,
            pb.type,
            pb.title,
            pb.content,
            pb.rating,
            TO_CHAR(pb.created_at, 'YYYY-MM-DD HH24:MI:SS') AS created_at,
            u.user_id AS user_id
        FROM PRODUCT_BOARDS pb
                 JOIN USERS u ON pb.users_id = u.id
        WHERE pb.products_id = #{productId}
        ORDER BY pb.created_at DESC
    </select>

    <select id="findOrderItemsByOrderId" resultType="kr.co.bnk_marketproject_be.dto.OrderItemsDTO">
        SELECT
        oi.id,
        oi.orders_id,
        oi.products_id,
        oi.product_options_id,
        oi.quantity,
        oi.price,
        pr.product_name AS productName,
        pi.url AS url
        FROM ORDER_ITEMS oi
        JOIN PRODUCTS pr ON pr.id = oi.products_id
        LEFT JOIN PRODUCT_IMAGES pi
        ON pi.products_id = pr.id
        AND pi.IS_MAIN = 'Y'   <!-- ✅ 이 위치가 중요 -->
        WHERE oi.orders_id = #{orderId}
    </select>

    <select id="findRecentOrdersByUserId" resultMap="OrderWithItemsMap">
<![CDATA[
        SELECT *
        FROM (
                 SELECT
                     o.id AS order_id,
                     o.users_id,
                     o.status,
                     o.total_amount,
                     TO_CHAR(o.created_at, 'YYYY-MM-DD') AS created_at,
                     o.order_code,

                     s.brand_name AS company_name,
                     s.seller_id AS seller_id,
                     s.biz_registration_number AS seller_bizno,
                     s.mail_order_number AS seller_mailnum,
                     us.name AS seller_rep,
                     us.phone AS seller_tel,
                     us.email AS seller_email,
                     (us.address || ' ' || us.detail_address) AS seller_addr,

                     pr.product_name,
                     oi.id AS order_item_id,
                     oi.products_id AS products_id,
                     pi.url AS url,
                     oi.quantity,
                     NVL(oi.price, pr.price) AS price_fixed

                 FROM ORDERS o
                          JOIN USERS u ON o.users_id = u.id
                          JOIN ORDER_ITEMS oi ON oi.orders_id = o.id
                          JOIN PRODUCTS pr ON oi.products_id = pr.id
                          LEFT JOIN SELLERS s ON pr.sellers_id = s.id
                          LEFT JOIN USERS us ON s.users_id = us.id
                          LEFT JOIN PRODUCT_IMAGES pi ON pi.products_id = pr.id AND pi.IS_MAIN = 'Y'

                 -- ✅ 여기 중요: u.user_id (문자열) 대신 o.users_id를 서브쿼리로 비교
                 WHERE o.users_id = (
                     SELECT id FROM USERS WHERE user_id = #{userId}
                 )

                 ORDER BY o.created_at DESC
             )
        WHERE ROWNUM <= 3
        ]]>
</select>


</mapper>
