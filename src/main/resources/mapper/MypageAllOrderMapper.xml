<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.bnk_marketproject_be.mapper.MypageAllOrderMapper">

    <!-- 전체 주문 목록 -->
    <!-- 전체 주문 목록 + 대표 이미지 포함 -->
    <select id="findAllOrdersByUserId" resultType="kr.co.bnk_marketproject_be.dto.OrdersDTO">
        SELECT
        o.id,
        o.users_id,
        o.status,
        o.total_amount,
        TO_CHAR(o.created_at, 'YYYY-MM-DD HH24:MI:SS') AS created_at,
        o.order_code,

        u.user_id       AS userId,
        u.name          AS user_name,
        p.method        AS method,

        pr.product_name AS product_name,
        pr.price        AS price,
        s.brand_name AS company_name,
        oi.quantity     AS quantity,
        pi.url          AS url

        FROM ORDERS o
        JOIN USERS u ON o.users_id = u.id
        LEFT JOIN PAYMENTS p ON p.orders_id = o.id
        LEFT JOIN ORDER_ITEMS oi ON oi.orders_id = o.id
        LEFT JOIN PRODUCTS pr ON oi.products_id = pr.id
        LEFT JOIN SELLERS s ON pr.sellers_id = s.id
        LEFT JOIN PRODUCT_IMAGES pi
        ON pi.products_id = pr.id
        AND pi.is_main = 'Y'

        WHERE o.users_id = #{userId}

        GROUP BY
        o.id, o.users_id, o.status, o.total_amount, o.created_at,
        o.order_code, u.user_id, u.name, p.method,
        pr.product_name, pr.price, s.brand_name, oi.quantity, pi.url

        ORDER BY o.created_at DESC
    </select>

    <!-- 단일 주문 상세 -->
    <select id="findOrderDetailById" resultType="kr.co.bnk_marketproject_be.dto.OrdersDTO">
        SELECT
            o.id,
            o.users_id,
            o.status,
            o.total_amount,
            TO_CHAR(o.created_at, 'YYYY-MM-DD HH24:MI:SS') AS created_at,
            o.order_code,
            u.user_name,
            u.phone AS ruphone,
            d.recipient,
            d.address,
            d.postcode,
            d.detail_address,
            p.method,
            i.product_code,
            pr.name AS product_name,
            i.quantity,
            i.price,
            i.discount,
            i.delichar
        FROM ORDERS o
                 JOIN USERS u ON o.users_id = u.id
                 LEFT JOIN PAYMENTS p ON p.orders_id = o.id
                 LEFT JOIN ORDER_ITEMS i ON i.orders_id = o.id
                 LEFT JOIN PRODUCTS pr ON pr.code = i.product_code
                 LEFT JOIN DELIVERY d ON d.orders_id = o.id
        WHERE o.id = #{orderId}
    </select>

    <!-- 페이징된 주문 목록 -->
    <select id="findPagedOrders" resultType="kr.co.bnk_marketproject_be.dto.OrdersDTO">
        SELECT *
        FROM (
        SELECT
        o.id,
        o.users_id,
        o.status,
        o.total_amount,
        TO_CHAR(o.created_at, 'YYYY-MM-DD HH24:MI:SS') AS created_at,
        o.order_code,

        u.user_id       AS userId,
        u.name          AS user_name,
        p.method        AS method,

        pr.product_name AS product_name,
        pr.price        AS price,
        s.brand_name    AS company_name,
        oi.quantity     AS quantity,
        pi.url          AS url,
        ROWNUM AS rn
        FROM ORDERS o
        JOIN USERS u ON o.users_id = u.id
        LEFT JOIN PAYMENTS p ON p.orders_id = o.id
        LEFT JOIN ORDER_ITEMS oi ON oi.orders_id = o.id
        LEFT JOIN PRODUCTS pr ON oi.products_id = pr.id
        LEFT JOIN SELLERS s ON pr.sellers_id = s.id
        LEFT JOIN PRODUCT_IMAGES pi
        ON pi.products_id = pr.id
        AND pi.is_main = 'Y'
        WHERE o.users_id = #{userId}
        AND ROWNUM &lt;= ( #{pageRequest.pg} * #{pageRequest.size} )
        ORDER BY o.created_at DESC
             )
        WHERE rn > ((#{pageRequest.pg} - 1) * #{pageRequest.size})
    </select>

    <!-- 전체 주문 개수 -->
    <select id="countOrdersByUserId" resultType="int">
        SELECT COUNT(*) FROM ORDERS WHERE users_id = #{userId}
    </select>

</mapper>
