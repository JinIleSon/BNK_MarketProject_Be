<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.bnk_marketproject_be.mapper.OrdersMapper">

    <select id="selectCartLineRows" resultType="kr.co.bnk_marketproject_be.dto.OrderPageLineRowDTO">
        SELECT
        oi.id              AS order_item_id,
        p.id               AS id,
        p.product_code     AS product_code,
        p.product_name     AS product_name,
        po.option_name     AS option_name,
        oi.quantity        AS quantity,
        p.price            AS unitPrice,
        NVL(
        CASE
        WHEN p.discount BETWEEN 0 AND 100 THEN ROUND(p.discount)
        WHEN p.discount > 100 AND p.price > 0 THEN ROUND(p.discount / p.price * 100)
        ELSE 0
        END, 0
        )                    AS discountRate,
        img.url            AS url,
        p.delichar         AS delichar
        FROM order_items oi
        JOIN orders o               ON o.id = oi.orders_id
        JOIN products p             ON p.id = oi.products_id
        LEFT JOIN product_options po ON po.id = oi.product_options_id
        LEFT JOIN product_images img ON img.products_id = p.id AND img.is_main='Y'
        WHERE o.users_id = #{userId}
        AND o.status = '결제대기'
        ORDER BY oi.id DESC
    </select>

    <!-- 쿠폰/포인트/기본배송지 -->
    <select id="selectAvailableCoupons" resultType="kr.co.bnk_marketproject_be.dto.OrderPageCouponViewDTO">
        SELECT
        id,
        coupon_name,
        discount_type,
        discount_value,
        company,
        note,
        TO_CHAR(valid_from,'YYYY-MM-DD HH24:MI') AS valid_from,
        TO_CHAR(valid_to,'YYYY-MM-DD HH24:MI')   AS valid_to,
        status
        FROM coupons
        WHERE users_id = #{userId}
        AND status IN ('발급중')  <!-- 필요 상태만 남기세요 -->
        AND SYSDATE BETWEEN valid_from AND valid_to
        ORDER BY id DESC
    </select>

    <update id="markCouponUsed">
        UPDATE coupons
        SET status = '종료'
        <!-- , used_order_id = #{orderId}   -->
        <!-- , used_at = SYSTIMESTAMP       -->
        WHERE id = #{couponId}
        AND users_id = #{userId}
        AND status = '발급중'
    </update>

    <select id="selectAvailablePoint" resultType="int">
        SELECT NVL(balance, 0)
        FROM (
        SELECT balance
        FROM point_ledgers
        WHERE users_id = TO_CHAR(#{userId})
        OR users_id = (SELECT u.user_id FROM users u WHERE u.id = #{userId})
        ORDER BY created_at DESC, id DESC
        ) t
        WHERE ROWNUM = 1
    </select>

    <insert id="consumePoint">
        INSERT INTO point_ledgers (users_id, change_amount, balance, description, created_at, board_type)
        SELECT
        x.user_id_val,
        -#{amount},
        NVL((
        SELECT balance
        FROM (
        SELECT balance
        FROM point_ledgers
        WHERE users_id = x.user_id_val
        ORDER BY created_at DESC, id DESC
        ) t2
        WHERE ROWNUM = 1
        ), 0) - #{amount},
        #{orderId},
        SYSTIMESTAMP,
        'ORDER_USE'
        FROM (
        SELECT NVL(
        (SELECT u.user_id FROM users u WHERE u.id = #{userId}),
        TO_CHAR(#{userId})
        ) AS user_id_val
        FROM dual
        ) x
    </insert>

    <insert id="addRewardPoint">
        INSERT INTO point_ledgers (users_id, change_amount, balance, description, created_at, board_type)
        SELECT
        x.user_id_val,
        #{amount},
        NVL((
        SELECT balance
        FROM (
        SELECT balance
        FROM point_ledgers
        WHERE users_id = x.user_id_val
        ORDER BY created_at DESC, id DESC
        ) t2
        WHERE ROWNUM = 1
        ), 0) + #{amount},
        #{orderId},
        SYSTIMESTAMP,
        'ORDER_REWARD'
        FROM (
        SELECT NVL(
        (SELECT u.user_id FROM users u WHERE u.id = #{userId}),
        TO_CHAR(#{userId})
        ) AS user_id_val
        FROM dual
        ) x
    </insert>

    <select id="selectDefaultShipping"
            parameterType="int"
            resultType="kr.co.bnk_marketproject_be.dto.DeliveriesDTO">
        SELECT
        d.recipient,
        d.delicom,
        d.zipcode,
        d.address,
        d.address2,
        d.delichar,
        d.status,
        d.note
        FROM deliveries d
        JOIN orders o ON o.id = d.orders_id
        WHERE o.users_id = #{userId}
        ORDER BY d.id DESC
        FETCH FIRST 1 ROWS ONLY
    </select>

    <!-- 주문 생성 -->
    <insert id="insertOrder"
            parameterType="kr.co.bnk_marketproject_be.dto.OrdersDTO"
            useGeneratedKeys="true"
            keyProperty="id"
            keyColumn="ID">
        INSERT INTO orders (users_id, status, total_amount, order_code, created_at)
        VALUES (#{users_id}, #{status}, #{total_amount}, #{order_code}, SYSTIMESTAMP)
    </insert>

    <insert id="insertPayment" parameterType="kr.co.bnk_marketproject_be.dto.PaymentsDTO">
        INSERT INTO payments (orders_id, amount, method, status, paid_at)
        VALUES (#{orders_id}, #{amount}, #{method}, #{status}, SYSTIMESTAMP)
    </insert>

    <insert id="insertDelivery" parameterType="kr.co.bnk_marketproject_be.dto.DeliveriesDTO">
        INSERT INTO deliveries
        (orders_id, recipient, delicom, zipcode, address, address2, status, delichar, note)
        VALUES
        (#{orders_id}, #{recipient}, #{delicom}, #{zipcode}, #{address}, #{address2}, #{status}, #{delichar}, #{note})
    </insert>

    <update id="recalcOrderTotal" parameterType="int">
        UPDATE orders o
        SET o.total_amount = (
        SELECT NVL(SUM(NVL(oi.price,0) * NVL(oi.quantity,0)), 0)
        FROM order_items oi
        WHERE oi.orders_id = #{orderId}
        )
        WHERE o.id = #{orderId}
    </update>


    <insert id="insertOrderItemFromCart">
        INSERT INTO order_items (orders_id, products_id, product_options_id, quantity, price)
        SELECT #{orderId}, oi.products_id, oi.product_options_id, oi.quantity, p.price
        FROM order_items oi
        JOIN products p ON p.id = oi.products_id
        WHERE oi.id = #{orderItemId}
    </insert>


    <update id="decreaseStock">
        UPDATE products
        SET stock = stock - #{qty}
        WHERE id = #{productId}
        AND stock >= #{qty}
    </update>

    <delete id="clearCartByUser">
        DELETE FROM order_items
        WHERE orders_id IN (
        SELECT id FROM orders
        WHERE users_id=#{userId}
        AND status='결제대기'
        )
    </delete>

    <!-- 완료 화면 -->
    <select id="selectOrderLines" parameterType="int" resultType="kr.co.bnk_marketproject_be.dto.OrderPageLineRowDTO">
        SELECT
        pr.id           AS id,
        pr.product_code AS product_code,
        pr.product_name AS product_name,
        po.option_name  AS option_name,
        oi.quantity     AS quantity,
        pr.price        AS unitPrice,
        pr.discount     AS discountRate,
        img.url         AS url,
        pr.delichar     AS delichar
        FROM order_items oi
        JOIN products pr           ON pr.id = oi.products_id
        LEFT JOIN product_options po ON po.id = oi.product_options_id
        LEFT JOIN product_images img ON img.products_id = pr.id AND img.is_main = 'Y'
        WHERE oi.orders_id = #{orderId}
    </select>

    <!-- 완료 화면 헤더: 주문/결제/구매자 + 배송 스냅샷 -->
    <select id="selectOrderCompleteHeader"
            parameterType="int"
            resultType="kr.co.bnk_marketproject_be.dto.ProductCompleteDTO">
        SELECT
        /* 주문/결제/구매자 */
        o.id                                     AS orderId,
        p.method                                 AS payMethod,
        u.name                                   AS buyerName,
        u.phone                                  AS buyerPhone,
        TO_CHAR(o.created_at, 'YYYY-MM-DD HH24:MI:SS') AS completedAt,

        /* 배송지(orders_id에 저장된 스냅샷) — 실제 컬럼명으로 매핑 */
        d.recipient                              AS "deliveries.recipient",
        /* delicom이 수취인 연락처라면 그대로, 없을 수 있으니 보강(Optional) */
        NVL(d.delicom, u.phone)                  AS "deliveries.delicom",
        d.zipcode                                AS "deliveries.zipcode",
        d.address                                AS "deliveries.address",
        d.address2                               AS "deliveries.address2"

        FROM orders o
        JOIN users u           ON u.id = o.users_id
        LEFT JOIN payments p   ON p.orders_id = o.id
        LEFT JOIN deliveries d ON d.orders_id = o.id
        WHERE o.id = #{orderId}
    </select>

    <!-- ✅ 사용자의 "결제대기(장바구니)" 주문 id 조회 -->
    <select id="selectOpenCartId" resultType="int">
        SELECT id
        FROM orders
        WHERE users_id = #{userId}
        AND status = '결제대기'
        ORDER BY id DESC
        FETCH FIRST 1 ROWS ONLY
    </select>

    <!-- ✅ 장바구니 MERGE: 같은 상품(+옵션)은 수량 증가, 없으면 신규 insert -->
    <update id="mergeCartItem">
        MERGE INTO order_items t
        USING (
        SELECT
        #{orderId} AS orders_id,
        #{productId} AS products_id,
        #{optionId,jdbcType=INTEGER} AS product_options_id
        FROM dual
        ) s
        ON (
        t.orders_id = s.orders_id
        AND t.products_id = s.products_id
        AND (
        (t.product_options_id IS NULL AND s.product_options_id IS NULL)
        OR t.product_options_id = s.product_options_id
        )
        )
        WHEN MATCHED THEN
        UPDATE SET t.quantity = t.quantity + #{qty}
        WHEN NOT MATCHED THEN
        INSERT (orders_id, products_id, product_options_id, quantity, price)
        VALUES (
        #{orderId},
        #{productId},
        #{optionId,jdbcType=INTEGER},
        #{qty},
        (SELECT price FROM products WHERE id = #{productId})
        )
    </update>

    <delete id="deleteCartItems">
        DELETE FROM order_items
        WHERE orders_id = #{orderId}
        AND id IN
        <foreach collection="itemIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

    <select id="countItemsInOrder" resultType="int">
        SELECT COUNT(*) FROM order_items WHERE orders_id = #{orderId}
    </select>

    <!-- 선택: 아이템 0개면 장바구니 주문 레코드 제거 -->
    <delete id="deleteOrderIfEmpty">
        DELETE FROM orders o
        WHERE o.id = #{orderId}
        AND o.status = '결제대기'
        AND NOT EXISTS (SELECT 1 FROM order_items oi WHERE oi.orders_id = o.id)
    </delete>

    <select id="selectCouponForUser"
            resultType="kr.co.bnk_marketproject_be.dto.CouponsDTO">
        SELECT
        id,
        users_id,
        code,
        discount_type,
        discount_value,
        company,
        valid_from,
        valid_to,
        status,
        coupon_name,
        issuecount,
        usercount,
        created_at,
        note
        FROM coupons
        WHERE id = #{couponId}
        AND users_id = #{userId}
        AND status = '발급중'
        AND SYSDATE BETWEEN valid_from AND valid_to
    </select>

    <!-- 헤더 결제완료 승격 -->
    <update id="finalizeOrder">
        UPDATE orders
        SET status = '결제완료',
        total_amount = #{totalAmount},
        updated_at = SYSTIMESTAMP
        WHERE id = #{orderId}
        AND users_id = #{userId}
        AND status = '결제대기'
    </update>

</mapper>
