<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.bnk_marketproject_be.mapper.MyPageMapper">

    <select id="selectUserCouponsNow" resultType="kr.co.bnk_marketproject_be.dto.MyPageCouponsNowDTO">
        SELECT
        cn.id,
        c.COUPON_NAME AS coupon_name,
        c.discount_value AS discount_value,
        c.NOTE,
        cn.STATUS,
        c.VALID_TO AS valid_to,
        u.USER_ID AS user_id
        FROM coupons c
        JOIN coupons_now cn
        ON cn.COUPONS_ID = c.id
        JOIN users u
        ON cn.users_id = u.id
        WHERE u.USER_ID = #{user_id}
        ORDER BY c.VALID_TO desc
    </select>

    <select id="selectCountTotalUserCouponsNow" resultType="int">
        SELECT COUNT(*)
        FROM coupons c
        JOIN coupons_now cn
        ON cn.COUPONS_ID = c.id
        JOIN users u
        ON cn.users_id = u.id
        WHERE u.USER_ID = #{user_id}
    </select>

    <select id="selectCountTotalUserCouponsNowAround" resultType="int">
        SELECT COUNT(*)
        FROM coupons c
        JOIN coupons_now cn
        ON cn.COUPONS_ID = c.id
        JOIN users u
        ON cn.users_id = u.id
        WHERE u.USER_ID = #{user_id}
        AND cn.STATUS = '미사용'
    </select>

<!--    푸시용 주석-->
    <select id="selectUser" resultType="kr.co.bnk_marketproject_be.dto.UserDTO">
        SELECT
        id,  <!-- ✅ 이 줄 추가 -->
        user_id as user_id,
        email,
        password,
        name,
        phone,
        birth,
        email,
        postcode,
        address,
        detail_address as detailAddress
        FROM
        USERS
        WHERE user_id = #{user_id}
    </select>

<!--    푸시용 주석-->
    <select id="selectUserReview" resultType="kr.co.bnk_marketproject_be.dto.MyPageReviewDTO">
        SELECT
        pb.id,
        u.USER_ID AS user_id,
        p.PRODUCT_CODE AS product_code,
        p.PRODUCT_NAME AS product_name,
        pb.CONTENT,
        pb.RATING,
        pb.CREATED_AT AS created_at,
        p.ID AS pid
        FROM PRODUCT_BOARDS pb
        JOIN USERS u
        ON u.id = pb.USERS_ID
        JOIN PRODUCTS p
        ON p.id = pb.PRODUCTS_ID
        WHERE u.USER_ID  = #{user_id}
        ORDER BY pb.created_at DESC
        OFFSET #{pageRequestDTO.offset} ROWS
        FETCH NEXT #{pageRequestDTO.size} ROWS ONLY
    </select>

    <select id="selectCountTotalUserReview" resultType="int">
        SELECT COUNT(*)
        FROM PRODUCT_BOARDS pb
        JOIN USERS u
        ON u.id = pb.USERS_ID
        JOIN PRODUCTS p
        ON p.id = pb.PRODUCTS_ID
        WHERE u.USER_ID  = #{user_id}
    </select>

    <select id="selectAllInquiry" resultType="kr.co.bnk_marketproject_be.dto.AdminInquiryDTO">
        SELECT
        A.id                    AS id,
        A.board_type            AS board_type,
        A.board_type2           AS board_type2,
        A.board_type3           AS board_type3,
        A.title                 AS title,
        A.user_id               AS userId,
        A.content               AS content,
        A.hits                  AS hits,
        A.look                  AS look,
        A.created_at            AS createdAt
        FROM board A
        WHERE A.user_id = #{userId}
        ORDER BY A.created_at DESC
        OFFSET #{pageRequestDTO.offset} ROWS
        FETCH NEXT #{pageRequestDTO.size} ROWS ONLY
    </select>

    <select id="selectCountTotalInquiry" resultType="int">
        SELECT COUNT(*) FROM board A
        WHERE A.user_id = #{userId}
    </select>

    <select id="selectCountTotalInquiryAround" resultType="int">
        SELECT COUNT(*) FROM board A
        WHERE A.user_id = #{user_id}
    </select>

    <select id="selectUserPoint" resultType="kr.co.bnk_marketproject_be.dto.AdminPointDTO">
    SELECT
    id,
    users_id      AS user_id,
    created_at,
    SUM(change_amount) OVER (
    PARTITION BY users_id
    ORDER BY created_at, id        -- 동일 시각일 때 정렬 보정
    ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW
    ) AS sum_point,
    -- "현재 포인트" = 전체 합(모든 행에서 동일한 값)
    SUM(change_amount) OVER (PARTITION BY users_id) AS total_point,
    change_amount,
    description
    FROM point_ledgers
    WHERE users_id = #{user_id}
        <!-- 기간 필터 -->
        <if test="pageRequestDTO.startDate != null">
            AND created_at &gt;= #{pageRequestDTO.startDate}
        </if>
        <if test="pageRequestDTO.endDate != null">
            AND created_at &lt; #{pageRequestDTO.endExclusive}
        </if>
    ORDER BY created_at DESC, id DESC
    OFFSET #{pageRequestDTO.offset} ROWS
    FETCH NEXT #{pageRequestDTO.size} ROWS ONLY
    </select>

    <select id="selectCountTotalUserPoint" resultType="int">
        SELECT COUNT(*) FROM point_ledgers
        WHERE users_id = #{user_id}
        <if test="pageRequestDTO.startDate != null">
            AND created_at &gt;= #{pageRequestDTO.startDate}
        </if>
        <if test="pageRequestDTO.endDate != null">
            AND created_at &lt; #{pageRequestDTO.endExclusive}
        </if>
    </select>



</mapper>