<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.bnk_marketproject_be.mapper.MypageReturnExchangeMapper">

    <!-- ✅ 반품신청 등록 -->
    <insert id="insertReturnRequest" parameterType="kr.co.bnk_marketproject_be.dto.MypageReturnRequestDTO">
        INSERT INTO HTE_MY_PAGE_RETURN_REQUEST
        (ORDER_ITEM_ID, USER_ID, REASON_TEXT, EVIDENCE_URLS, PICKUP_ADDRESS, REASON_CODE, STATUS, CREATED_AT)
        VALUES (
                   #{orderItemId},
                   #{userId},
                   #{reasonText},
                   #{evidenceUrls, jdbcType=VARCHAR},
                   #{pickupAddress, jdbcType=VARCHAR},
                   #{reasonCode},
                   #{status},
                   SYSTIMESTAMP
               )
    </insert>

    <!-- ✅ 교환신청 등록 -->
    <insert id="insertExchangeRequest"
            parameterType="kr.co.bnk_marketproject_be.dto.MypageExchangeRequestDTO">
        INSERT INTO HTE_MY_PAGE_EXCHANGE_REQUEST
        (ORDER_ITEM_ID, USER_ID, REASON_TEXT, DESIRED_OPTION, EVIDENCE_URLS, REASON_CODE, STATUS, CREATED_AT)
        VALUES (
                   #{orderItemId},
                   #{userId},
                   #{reasonText},
                   #{desiredOption},
                   #{evidenceUrls, jdbcType=VARCHAR},
                   #{reasonCode},
                   #{status},
                   SYSTIMESTAMP
               )
    </insert>






    <!-- ✅ 반품신청 조회 -->
    <select id="findReturnList" resultType="kr.co.bnk_marketproject_be.dto.MypageReturnRequestDTO">
        SELECT *
        FROM HTE_MY_PAGE_RETURN_REQUEST
        WHERE USER_ID = #{userId}
        ORDER BY CREATED_AT DESC
    </select>

    <!-- ✅ 교환신청 조회 -->
    <select id="findExchangeList" resultType="kr.co.bnk_marketproject_be.dto.MypageExchangeRequestDTO">
        SELECT *
        FROM HTE_MY_PAGE_EXCHANGE_REQUEST
        WHERE USER_ID = #{userId}
        ORDER BY CREATED_AT DESC
    </select>

    <!-- ✅ 교환신청 모달용 상품 상세 조회 (DTO 없이 Map 리턴) -->
    <select id="findOrderItemDetail" resultType="map">
        SELECT
            o.id              AS order_id,
            o.order_code      AS order_code,
            TO_CHAR(o.created_at, 'YYYY-MM-DD') AS order_date,
            s.brand_name      AS company_name,
            pr.product_name   AS product_name,
            pr.price          AS original_price,
            NVL(oi.price, pr.price) AS paid_price,
            (NVL(oi.price, pr.price) - pr.price) AS discount_price,
            oi.quantity       AS quantity,
            pi.url            AS url,
            o.status          AS order_status
        FROM ORDER_ITEMS oi
                 JOIN ORDERS o ON oi.orders_id = o.id
                 JOIN PRODUCTS pr ON oi.products_id = pr.id
                 JOIN SELLERS s ON pr.sellers_id = s.id
                 LEFT JOIN PRODUCT_IMAGES pi ON pi.products_id = pr.id AND pi.is_main = 'Y'
        WHERE oi.id = #{orderItemId}
    </select>
</mapper>
