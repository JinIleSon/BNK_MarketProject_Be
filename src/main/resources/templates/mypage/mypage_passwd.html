<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>비밀번호 확인</title>
  <style>
      /*푸시용*/
    .inner{width:1270px; background:#fff;}
    .title-row{display:flex; justify-content:center; margin-top:40px;}
    .sec-title{font-weight:800; margin-right:auto; margin-left:73px; margin-bottom:10px;}
    /* 기존 페이지와 동일한 kv 테이블 */
    .kv{width:900px; border-collapse:collapse; font-size:14px; border-top:1px solid gray;}
    .kv td{border-bottom:1px solid #eee; padding:10px 13px; vertical-align:middle;}
    .kv td:first-child{height:45px; background:#f2f2f2; text-align:center; width:130px;}
    .btn{border:none; background:#000; color:#fff; width:95px; height:30px; cursor:pointer;}
    .btn-danger{background:#760c0c;}
    .btn-wide{width:190px; height:34px;}
    .pw-input{
      width:260px; height:34px; border:none; border-bottom:1px solid #dddddd; outline:none;
      padding:0 8px;
    }
    .guide{color:#555; font-size:13px; line-height:1.5; margin:6px 0 2px;}
    .error{color:#d00; font-size:12px; margin-top:6px; min-height:16px;}
    .actions{display:flex; gap:8px; margin-top:16px;}
    .right{display:flex; justify-content:flex-end; width:900px;}
    /* 접근성 */
    .sr-only{position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0;}
  </style>
</head>
<body>
  <main>
      <div th:replace="~{main/header.html}"></div>
    <div style="background-color: #f6f5f5; border-bottom: 1px solid #dddddd;">
            <div style="display: flex; justify-content: center; align-items: center;">
                <div style="width:1270px; font-size:15px; height:70px; display: flex; align-items: center; ">
                    <div style="font-weight: 800; margin-left:73px;">나의 쇼핑 정보</div>
                    <div style="display: flex; margin-left:auto; margin-right:40px;">
                        <div style="width:70px;border-right:1px solid #dddddd; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                            <div style="margin-bottom:8px;">주문</div>
                            <div>2</div>
                        </div>
                        <div style="width:70px; border-right:1px solid #dddddd; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                            <div style="margin-bottom:8px;">쿠폰</div>
                            <div>1</div>
                        </div>
                        <div style="width:70px;border-right:1px solid #dddddd; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                            <div style="margin-bottom:8px;">포인트</div>
                            <div>1,000</div>
                        </div>
                        <div style="width:70px;display: flex; flex-direction: column; align-items: center; justify-content: center;">
                            <div style="margin-bottom:8px;">문의</div>
                            <div>1</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div style="display: flex; justify-content: center; align-items: center;">
            <div style="width:1270px; font-size:15px; display: flex;">
                <div style=" width:200px; padding-left:70px; padding-top:30px; border-right:1px solid #dddddd;">
                    <div style="margin-bottom:15px;"><a th:href="@{/mypage/mypage/allorder}">전체주문내역</a></div>
                    <div style="margin-bottom:15px;"><a th:href="@{/mypage/mypage/point}">포인트내역</a></div>
                    <div style="margin-bottom:15px;"><a th:href="@{/mypage/mypage/coupon}">쿠폰</a></div>
                    <div style="margin-bottom:15px;"><a th:href="@{/mypage/mypage/review}">나의리뷰</a></div>
                    <div style="margin-bottom:15px;"><a th:href="@{/mypage/mypage/ask}">문의하기</a></div>
                    <div style="font-weight: 800;"><a th:href="@{/mypage/mypage/setup}">나의설정</a></div>
                </div>
                <div style="width: 100%;">
                    <div style="margin-top:30px; display: flex; justify-content: center;">
                        <div>
                          <img th:src="@{/images/mypage_mainBanner11.jpg}" alt="" style="width:400px;">
                          <div style="font-size:10px;">Image by <a href="https://www.freepik.com" target="_blank" style="color:inherit; text-decoration:none;">Freepik</a></div>
                        </div>
                    </div>
                    <div class="inner" style="width:900px; margin-left:100px; margin-top:100px;">
                    <div class="title-row">
                        <div class="sec-title" style="margin-left:0px;">비밀번호 확인</div>
                    </div>

                    <div style="display:flex; flex-direction:column; align-items:center;">
                        <!-- 안내 문구 -->
                        <table class="kv" style="margin-top:6px;">
                        <tr>
                            <td>안내</td>
                            <td>
                            <div id="action-title" style="font-weight:700; margin-bottom:6px;">정보 수정 전 확인</div>
                            <div id="action-desc" class="guide">수정 내용을 저장하기 전에 본인 확인을 위해 현재 비밀번호를 입력해 주세요.</div>
                            </td>
                        </tr>
                        <tr>
                            <td>사용자 ID</td>
                            <td id="masked-id"></td>
                        </tr>
                        <tr>
                            <td>현재 비밀번호</td>
                            <td style="padding-top:20px; display:flex;padding-bottom: 20px;">
                                <form id="pwForm" th:action="@{/mypage/mypage/passwd}" method="post">
                                    <input type="hidden" id="code" name="code" th:value="${code}">
                                    <input type="hidden" name="email" th:value="${userDTO.email}">
                                    <input type="hidden" name="phone" th:value="${userDTO.phone}">
                                    <input type="hidden" name="postcode" th:value="${userDTO.postcode}">
                                    <input type="hidden" name="address" th:value="${userDTO.address}">
                                    <input type="hidden" name="detailAddress" th:value="${userDTO.detailAddress}">
                                    <input id="password" type="password" class="pw-input" placeholder="현재 비밀번호 입력" autocomplete="current-password">
                                </form>
                                <div>
                                    <button type="button" id="toggle" class="btn" style="width:70px; height:30px; margin-left:6px;">보기</button>
                                </div>
                            <div class="error" id="err"></div>
                            </td>
                        </tr>
                        </table>
                    </div>
                    <div style="width: 900px; margin-left:0px;">
                        <div class="guide" style="margin-bottom:10px; margin-top:10px;">※ 공용 PC에서는 비밀번호 자동저장을 피해주세요.</div>
                        <!-- 하단 큰 버튼 (기존 페이지 톤 맞춤) -->
                        <div class="right" style="margin-top:20px; display: flex; flex-direction: column; margin-left: 515px;">
                            <div>
                                <button type="button" class="btn btn-wide" id="btn-confirm-bottom">확인</button>
                                <button type="button" th:onclick="|location.href='@{/mypage/mypage/setUp}'|" class="btn btn-wide" id="btn-cancel" style=" background:#666; border:none;">취소</button>
                            </div>
                        </div>
                    </div>
                    <div style="margin-bottom:60px;"></div>
                </div>
            </div>
        </div>
        </div>
    </main>

  <script th:inline="javascript">
      (() => {
          // ---- 앱 컨텍스트 (절대경로 보장) ----
          const APP_CTX = /*[[@{/}]]*/ ''; // 예: "/NICHIYA/"

          // ---- querystring / code 값 ----
          const qs = new URLSearchParams(location.search);    // <-- 전역 'params' 안 씀
          const codeFromUrl   = qs.get('code');
          const codeFromInput = document.getElementById('code')?.value || null;
          const CODE = Number(codeFromUrl ?? codeFromInput ?? NaN);

          // ---- action 결정 (code=2면 강제 withdraw) ----
          const actionFromUrl = qs.get('action') || 'edit';
          const action = (CODE === 2) ? 'withdraw' : actionFromUrl;

          const FLOW = {
              edit     : { title:'정보 수정 전 확인', desc:'수정 내용을 저장하기 전에 본인 확인을 위해 현재 비밀번호를 입력해 주세요.' },
              pw       : { title:'비밀번호 변경 전 확인', desc:'현재 비밀번호 확인 후 변경 페이지로 이동합니다.' },
              withdraw : { title:'회원 탈퇴 전 확인',   desc:'탈퇴 진행 전 본인 확인을 위해 비밀번호를 입력해 주세요.' }
          };
          const f = FLOW[action] || FLOW.edit;
          document.getElementById('action-title').textContent = f.title;
          document.getElementById('action-desc').textContent  = f.desc;

          // ---- 사용자 ID 마스킹 (null 안전) ----
          const realId = /*[[${userDTO.userId}]]*/ null;
          const masked =
              (typeof realId === 'string' && realId.length)
                  ? (realId.length > 3 ? realId.slice(0,3) + '*'.repeat(realId.length-3) : realId.replace(/.(?=.)/g,'*'))
                  : '';
          document.getElementById('masked-id').textContent = masked;

          // ---- 비밀번호 보기/숨기기 ----
          const pw = document.getElementById('password');
          document.getElementById('toggle')?.addEventListener('click', function(){
              const isPw = pw.type === 'password';
              pw.type = isPw ? 'text' : 'password';
              this.textContent = isPw ? '숨기기' : '보기';
              pw.focus();
          });

          // ---- 에러 표시 ----
          const err = document.getElementById('err');
          const showErr = (m='') => { if (err) err.textContent = m; };

          // ---- 서버 검증 ----
          async function verifyPassword(pwVal) {
              const url = APP_CTX + 'mypage/mypage/passwd-check?password=' + encodeURIComponent(pwVal);
              const res = await fetch(url, { method: 'GET' });
              if (!res.ok) throw new Error('HTTP ' + res.status);
              const ok = await res.json();
              return ok === true;
          }

          // ---- 제출 ----
          async function onSubmit(){
              const v = pw.value.trim();
              showErr('');
              if(!v){ showErr('비밀번호를 입력해 주세요.'); pw.focus(); return; }
              if(v.length < 4){ showErr('비밀번호가 너무 짧습니다.'); pw.focus(); return; }

              const btns = Array.from(document.querySelectorAll('#btn-confirm, #btn-confirm-bottom'));
              btns.forEach(b => { b.disabled = true; b.textContent = '확인 중...'; });

              try{
                  const ok = await verifyPassword(v);
                  if(!ok){ showErr('비밀번호가 일치하지 않습니다.'); return; }

                  if (CODE === 2) {
                      const go = confirm('정말로 탈퇴하시겠습니까?\n탈퇴 시 보유 포인트/쿠폰이 소멸되며, 복구가 불가합니다.');
                      if (!go) return;
                  }else if (CODE === 3) {
                      const go = confirm('정말로 수정하시겠습니까?');
                      if (!go) return;
                  }

                  const form = document.getElementById('pwForm');
                  if(!form) throw new Error('pwForm not found');
                  form.submit(); // POST /mypage/mypage/passwd
              }catch(e){
                  showErr('일시적인 오류가 발생했습니다. 잠시 후 다시 시도해 주세요.');
                  console.error(e);
              }finally{
                  btns.forEach(b => { b.disabled = false; b.textContent = '확인'; });
              }
          }

          // ---- 이벤트 바인딩 ----
          document.getElementById('btn-confirm-bottom')?.addEventListener('click', onSubmit);
          document.getElementById('btn-confirm')?.addEventListener('click', onSubmit);
          document.getElementById('btn-cancel')?.addEventListener('click', () => history.back());
          pw.addEventListener('keydown', e => { if(e.key === 'Enter') onSubmit(); });

      })();
  </script>
    <div style="margin-top:100px;"></div>
  <div th:replace="~{main/footer.html}"></div>
</body>
</html>
