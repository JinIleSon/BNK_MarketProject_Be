<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mypage_allOrder</title>
    <!-- ëª¨ë‹¬ ì „ìš© ìŠ¤íƒ€ì¼ -->
<style>
    /* ì „ì²´ ì˜¤ë²„ë ˆì´ */
    .modal-backdrop {
        position: fixed; inset: 0;
        background: rgba(0,0,0,.45);
        display: none;
        z-index: 9998;
    }
    .modal-backdrop.is-open { display: block; }

    /* ëª¨ë‹¬ ë°•ìŠ¤ */
    .modal {
        position: fixed; inset: 0;
        display: none;
        place-items: center;
        z-index: 9999;
    }
    .modal.is-open { display: grid; }

    .modal-dialog {
        width: 860px; max-width: calc(100% - 40px);
        background: #fff; border-radius: 10px;
        box-shadow: 0 20px 60px rgba(0,0,0,.25);
        overflow: hidden;
        font-family: sans-serif;
    }
    /* ìƒë‹¨ ë°” */
    .modal-header {
        background: #000000; color:#fff;
        padding: 4px 16px; font-weight: 700;
        display: flex; align-items: center; justify-content: space-between;
    }
    .modal-header .date { font-weight: 400; opacity:.9; margin-left: 12px; }
    .modal-close {
        appearance: none; border: 0; background: transparent;
        color:#fff; font-size: 20px; cursor: pointer; padding: 4px 8px;
    }
    /* ë³¸ë¬¸ */
    .modal-body { padding: 0; }
    .section {
        padding: 14px 18px;
    }
    .section-title {
        font-weight: 700; margin-bottom: 8px;
    }
    table.order-info {
        width: 100%; border-collapse: collapse; font-size: 14px;
    }
    .order-info th, .order-info td {
        border-bottom: 1px solid #eee; padding: 10px; vertical-align: middle;
    }
    .order-info thead th {
        background: #dedede; color:#fff; font-size: 12px; height: 38px;
    }
    .thumb { width: 120px; }
    .price {
        font-size: 18px; font-weight: 800; margin-top: 8px;
    }
    .right { text-align: right; white-space: nowrap; }
    /* ë°°ì†¡ì •ë³´ í‘œ */
    .kv { width: 100%; border-collapse: collapse; font-size: 14px; }
    .kv td { border-bottom: 1px solid #eee; padding: 10px; padding-left: 13px; }
    .kv td:first-child {height: 45px; background-color: #f2f2f2; text-align: center; width: 130px; }
    /* ì ‘ê·¼ì„± í¬ì»¤ìŠ¤ íŠ¸ë©ìš© */
    .sr-only { position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0; }

    /* ===== ë¦¬ë·° ëª¨ë‹¬ ë³´ê°• ===== */
    .review-form { padding: 18px; }
    .review-grid { width:100%; border-collapse: collapse; font-size:14px; }
    .review-grid td { border-bottom:1px solid #eee; padding:10px; }
    .review-grid td:first-child { width:120px; text-align:center; background:#f2f2f2; }
    .review-title {
        border:none; border-bottom:1px solid gray; width:270px; outline:none;
        height:34px; padding:6px 8px; box-sizing:border-box;
    }
    .review-textarea {
        width:100%; resize:none; outline:none; padding:8px; box-sizing:border-box; height:160px;
    }
    .review-actions { display:flex; justify-content:center; gap:10px; margin-top:16px; }
    .char-count { font-size:12px; color:#666; text-align:right; margin-top:6px; }

    /* ë³„ì : ê¸°ë³¸ì€ ë¹ˆ ë³„(â˜†), ì„ íƒ/í˜¸ë²„ ì‹œ ì±„ì›€(â˜…) */
    .rating { display:inline-flex; flex-direction: row-reverse; gap:4px; }
    .rating input { position:absolute; opacity:0; }
    .rating label { cursor:pointer; font-size:22px; line-height:1; }

    /* ê¸°ë³¸ì€ ë¹ˆ ë³„ */
    .rating label::before { content: 'â˜†'; }

    /* ì„ íƒëœ ê°’ê³¼ ê·¸ ì™¼ìª½(ì‹œê°ì  ê¸°ì¤€)ê¹Œì§€ ì±„ì›€ */
    .rating input:checked ~ label::before { content: 'â˜…'; }

    /* ë§ˆìš°ìŠ¤ ì˜¬ë ¸ì„ ë•Œ ë¯¸ë¦¬ë³´ê¸°(í˜¸ë²„ êµ¬ê°„ê¹Œì§€ ì±„ì›€) */
    .rating label:hover::before,
    .rating label:hover ~ label::before { content: 'â˜…'; }
    /* í˜ì´ì§€ë„¤ì´ì…˜ */
    /* ê²Œì‹œíŒ ì•„ë˜ë²„íŠ¼ ë¶€ë¶„ */
    .prev-page{
        background-color: white;
        border: none;
        margin-right: 15px;
        width: 50px;
        height: 30px;
        cursor: pointer;
    }
    .next-page{
        background-color: white;
        border: none;
        margin-left: 15px;
        width: 50px;
        height: 30px;
        margin-right:3px;
        cursor: pointer;
    }

    /* ê²Œì‹œíŒ ì•„ë˜ë²„íŠ¼ ë¶€ë¶„ ë */
</style>
</head>
<body>
<div id="userData" th:data-user-id="${userId}"></div>
<main>
    <div th:replace="~{main/header.html}"></div>
    <div style="background-color: #f6f5f5; border-bottom: 1px solid #dddddd;">
        <div style="display: flex; justify-content: center; align-items: center;">
            <div style="width:1270px; font-size:15px; height:70px; display: flex; align-items: center; ">
                <div style="font-weight: 800; margin-left:73px;">ë‚˜ì˜ ì‡¼í•‘ ì •ë³´</div>
                <div style="display: flex; margin-left:auto; margin-right:40px;">
                    <div style="width:70px;border-right:1px solid #dddddd; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                        <div style="margin-bottom:8px;">ì£¼ë¬¸</div>
                        <div>2</div>
                    </div>
                    <div style="width:70px; border-right:1px solid #dddddd; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                        <div style="margin-bottom:8px;">ì¿ í°</div>
                        <div><span th:text="${couponCount}"></span></div>
                    </div>
                    <div style="width:70px;border-right:1px solid #dddddd; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                        <div style="margin-bottom:8px;">í¬ì¸íŠ¸</div>
                        <div><span th:text="${#numbers.formatInteger(balance, 3, 'COMMA')} + 'P'">0P</span></div>
                    </div>
                    <div style="width:70px;display: flex; flex-direction: column; align-items: center; justify-content: center;">
                        <div style="margin-bottom:8px;">ë¬¸ì˜</div>
                        <div><span th:text="${count}"></span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div style="display: flex; justify-content: center; align-items: center;">
        <div style="width:1270px; font-size:15px; display: flex;">
            <div style=" width:200px; padding-left:70px; padding-top:30px; border-right:1px solid #dddddd;">
                <div style="margin-bottom:15px; font-weight: 800;"><a th:href="@{/mypage/mypage/allorder}">ì „ì²´ì£¼ë¬¸ë‚´ì—­</a></div>
                <div style="margin-bottom:15px;"><a th:href="@{/mypage/mypage/point}">í¬ì¸íŠ¸ë‚´ì—­</a></div>
                <div style="margin-bottom:15px;"><a th:href="@{/mypage/mypage/coupon}">ì¿ í°</a></div>
                <div style="margin-bottom:15px;"><a th:href="@{/mypage/mypage/review}">ë‚˜ì˜ë¦¬ë·°</a></div>
                <div style="margin-bottom:15px;"><a th:href="@{/mypage/mypage/ask}">ë¬¸ì˜í•˜ê¸°</a></div>
                <div style="margin-bottom:15px;"><a th:href="@{/mypage/mypage/setup}">ë‚˜ì˜ì„¤ì •</a></div>
            </div>
            <div style="width: 100%;">
                <div style="margin-top:30px; display: flex; justify-content: center;">
                    <div>
                        <img th:src="@{/images/mypage_mainBanner5.jpg}" alt="" style="width:400px;">
                        <div style="font-size:10px;">Image by <a href="https://www.freepik.com" target="_blank" style="color:inherit; text-decoration:none;">Freepik</a></div>
                    </div>
                </div>
                <div style="display: flex; flex-direction: column; justify-content: center; align-items: center; margin-top:40px;">
                    <div style="display: flex; margin-top:30px;">
                        <div style="font-weight: 800; margin-right:813px; margin-bottom:10px;">ì „ì²´ì£¼ë¬¸ë‚´ì—­</div>
                    </div>
                    <div style="display: flex; border:1px solid; width:900px; height:60px; align-items: center; justify-content: center; background-color: #222; border:none; margin-bottom:10px; color: white;">
                        <div style="margin-right:10px;">ê¸°ê°„ë³„ ì¡°íšŒ</div>
                        <!-- ë¹ ë¥¸ë²”ìœ„ -->
                        <div id="quickRanges" style="display:flex; color:white; border:1px solid white; margin-right:15px;">
                            <div class="range-btn" data-days="7"  style="margin:0 10px; cursor:pointer;">1ì£¼ì¼</div> |
                            <div class="range-btn" data-days="15" style="margin:0 10px; cursor:pointer;">15ì¼</div> |
                            <div class="range-btn" data-days="30" style="margin:0 10px; cursor:pointer;">1ê°œì›”</div>
                        </div>

                        <!-- 6~10ì›” (ê¸°ì¡´ ê·¸ëŒ€ë¡œ, idë§Œ ì¶”ê°€) -->
                        <div id="fixedMonthRanges" style="display:flex; color:white; border:1px solid white; margin-right:15px;">
                            <div style="margin:0 10px; cursor:pointer;">6ì›”</div> |
                            <div style="margin:0 10px; cursor:pointer;">7ì›”</div> |
                            <div style="margin:0 10px; cursor:pointer;">8ì›”</div> |
                            <div style="margin:0 10px; cursor:pointer;">9ì›”</div> |
                            <div style="margin:0 10px; cursor:pointer;">10ì›”</div>
                        </div>

                        <!-- ì‚¬ìš©ì ì§€ì • ê¸°ê°„ (date ì¸í’‹) -->
                        <div style="display:flex; color:white; border:1px solid white;">
                            <input id="startDate" type="date" style="background:transparent; border:0; color:#fff; margin:0 10px; width:110px;">
                            ~
                            <input id="endDate" type="date" style="background:transparent; border:0; color:#fff; margin:0 10px; width:110px;">
                        </div>
                        <div style="margin-left: 15px;">
                            <button id="applyFilter" style="background:#000; border:none; color:#fff; font-weight:300; margin-left:15px; width:45px; height:26px;">ì¡°íšŒ</button>
                        </div>
                        <style>
                            .range-active{text-decoration:underline}
                            #startDate, #endDate{
                                width:118px; padding:0 6px; margin:0 6px;
                            }
                            #startDate::-webkit-calendar-picker-indicator,
                            #endDate::-webkit-calendar-picker-indicator{ margin-left:4px; }
                            #applyFilter{ margin-left:0!important; }
                        </style>

                        <script>
                            // ===== ê¸°ê°„ë³„ ì¡°íšŒ ê¸°ëŠ¥ =====
                            const startOfDay = d => new Date(d.getFullYear(), d.getMonth(), d.getDate());
                            const endOfDay   = d => new Date(d.getFullYear(), d.getMonth(), d.getDate(), 23,59,59,999);
                            const fmt = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
                            const parse = s => { const m=/^(\d{4})-(\d{2})-(\d{2})$/.exec(s||''); return m?new Date(+m[1],+m[2]-1,+m[3]):new Date(NaN); };

                            document.addEventListener('DOMContentLoaded', function(){
                                const listTable = document.getElementById('orderListTable');
                                if(!listTable) return;
                                const rows = Array.from(listTable.querySelectorAll('tr')).slice(1);

                                function getRowDate(tr){
                                    const t = (tr.querySelector('td:first-child')?.textContent || '').trim();
                                    // ë‚ ì§œ + ì‹œê°„(ì˜µì…˜) ëª¨ë‘ ì¸ì‹
                                    const m = t.match(/^(\d{4})-(\d{2})-(\d{2})(?:\s+(\d{2}):(\d{2}):(\d{2}))?$/);
                                    if (!m) return null;
                                    // ì‹œê°„ ì •ë³´ê°€ ìˆìœ¼ë©´ í¬í•¨, ì—†ìœ¼ë©´ 0ì‹œë¡œ ì²˜ë¦¬
                                    return new Date(+m[1], +m[2]-1, +m[3], m[4] || 0, m[5] || 0, m[6] || 0);
                                }


                                const startInput=document.getElementById('startDate');
                                const endInput=document.getElementById('endDate');
                                const applyBtn=document.getElementById('applyFilter');
                                const quickWrap=document.getElementById('quickRanges');
                                const monthWrap=document.getElementById('fixedMonthRanges');

                                const MS=86400000;
                                const now=new Date();
                                const today=new Date(now.getFullYear(),now.getMonth(),now.getDate());
                                const yearAgo=new Date(today); yearAgo.setDate(today.getDate()-364);

                                startInput.min=fmt(yearAgo); startInput.max=fmt(today);
                                endInput.min=fmt(yearAgo); endInput.max=fmt(today);

                                function clampRange(){
                                    let s=parse(startInput.value), e=parse(endInput.value);
                                    if(isNaN(+s)) s=new Date(yearAgo); if(isNaN(+e)) e=new Date(today);
                                    if(s<yearAgo)s=new Date(yearAgo); if(s>today)s=new Date(today);
                                    if(e<yearAgo)e=new Date(yearAgo); if(e>today)e=new Date(today);
                                    if(s>e)e=new Date(s);
                                    const diff=Math.floor((endOfDay(e)-startOfDay(s))/MS)+1;
                                    if(diff>365){ const candStart=new Date(e); candStart.setDate(e.getDate()-364); s=candStart<yearAgo?new Date(yearAgo):candStart; }
                                    startInput.value=fmt(s); endInput.value=fmt(e);
                                    return {s,e};
                                }

                                (function initDefault(){
                                    const s=new Date(today); s.setDate(today.getDate()-6);
                                    startInput.value=fmt(s); endInput.value=fmt(today); clampRange();
                                })();

                                function clearActive(){
                                    quickWrap?.querySelectorAll('.range-btn')?.forEach(el=>el.classList.remove('range-active'));
                                    monthWrap?.querySelectorAll('div')?.forEach(el=>el.classList.remove('range-active'));
                                }

                                quickWrap?.addEventListener('click', e=>{
                                    const btn=e.target.closest('.range-btn'); if(!btn)return;
                                    clearActive(); btn.classList.add('range-active');
                                    const days=Number(btn.dataset.days||0);
                                    let s,ed;
                                    if(days===30){ const prevSame=new Date(today.getFullYear(),today.getMonth()-1,today.getDate());
                                        s=startOfDay(new Date(prevSame.getFullYear(),prevSame.getMonth(),prevSame.getDate()-1)); ed=endOfDay(today);
                                    } else { s=startOfDay(new Date(today.getFullYear(),today.getMonth(),today.getDate()-(days-1))); ed=endOfDay(today);}
                                    filter(s,ed);
                                });

                                monthWrap?.addEventListener('click', e=>{
                                    const el=e.target.closest('div'); if(!el)return;
                                    const m=parseInt(el.textContent.replace(/[^\d]/g,''),10);
                                    if(!(m>=1&&m<=12))return;
                                    clearActive(); el.classList.add('range-active');
                                    const y=today.getFullYear();
                                    const s=new Date(y,m-1,1); const ed=new Date(y,m,0);
                                    filter(s,ed);
                                });

                                startInput.addEventListener('change',clampRange);
                                endInput.addEventListener('change',clampRange);

                                function validateRange(){
                                    const {s,e}=clampRange();
                                    const diff=Math.floor((endOfDay(e)-startOfDay(s))/MS)+1;
                                    if(diff>365){ alert('ìµœëŒ€ 1ë…„(365ì¼)ê¹Œì§€ë§Œ ì¡°íšŒ ê°€ëŠ¥í•©ë‹ˆë‹¤.'); return null;}
                                    return {s,e};
                                }

                                function filter(s,e){
                                    const S=startOfDay(s), E=endOfDay(e);
                                    rows.forEach(tr=>{
                                        const d=getRowDate(tr);
                                        tr.style.display=(d&&d>=S&&d<=E)?'':'none';
                                    });
                                }
                                function showAll(){ rows.forEach(tr=>tr.style.display=''); }

                                applyBtn.addEventListener('click', ()=>{
                                    const rng=validateRange(); if(!rng)return;
                                    clearActive(); filter(rng.s,rng.e);
                                });

                                showAll();
                            });
                        </script>

                    </div>
                    <table id="orderListTable" style="text-align:center; border-collapse:collapse; border-top:1px solid; width:900px;">
                        <tr style="background-color:#dedede; font-size:12px; color:white; font-weight:800; height:40px;">
                            <th style="width:120px;">ë‚ ì§œ</th>
                            <th style="width:500px;">ìƒí’ˆì •ë³´</th>
                            <th style="width:160px;">ì‹ ì²­</th>
                            <th style="width:100px;">ìƒíƒœ</th>
                            <th style="width:120px;">í™•ì¸</th>
                        </tr>

                        <!-- ì£¼ë¬¸ ë‚´ì—­ì´ ì—†ì„ ë•Œ -->
                        <tr th:if="${#lists.isEmpty(orders)}" style="border-bottom:1px solid #dddddd; height:180px;">
                            <td colspan="4" style="padding:50px; color:#888;">ì£¼ë¬¸ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td>
                        </tr>

                        <!-- âœ… ì£¼ë¬¸ë³„ ë°˜ë³µ -->
                        <th:block th:each="o : ${orders}">
                            <tr style="border-bottom: 1px solid #dddddd;">
                                <!-- ì£¼ë¬¸ì¼ì -->
                                <td th:text="${o.created_at}" style="vertical-align: top; padding-top:20px; white-space:nowrap;"></td>

                                <!-- ìƒí’ˆì •ë³´ -->
                                <td style="text-align:left; padding:15px 10px;">
                                    <th:block th:each="item, itemStat : ${o.orderItems}">
                                        <div style="display:flex; align-items:flex-start; gap:15px; margin-bottom:15px; border-bottom:1px solid #f1f1f1; padding-bottom:10px;">

                                            <!-- ì´ë¯¸ì§€ -->
                                            <div>
                                                <img th:if="${item.url != null}"
                                                     th:src="@{'/' + ${item.url}}"
                                                     onerror="this.onerror=null; this.src='/NICHIYA/images/no_image.jpg'"
                                                     alt="ìƒí’ˆ ì´ë¯¸ì§€"
                                                     style="width:90px; height:90px; object-fit:cover; border:1px solid #eee; border-radius:6px;">

                                                <img th:if="${item.url == null}"
                                                     src="/NICHIYA/images/no_image.jpg"
                                                     onerror="this.onerror=null; this.src='/NICHIYA/images/no_image.jpg'"
                                                     alt="ìƒí’ˆ ì´ë¯¸ì§€"
                                                     style="width:90px; height:90px; object-fit:cover; border:1px solid #eee; border-radius:6px;">
                                            </div>


                                            <!-- ìƒí’ˆ ì •ë³´ -->
                                            <div style="flex:1;">
                                                <!-- ì²« ìƒí’ˆì—ë§Œ ì£¼ë¬¸ë²ˆí˜¸ & íŒë§¤ì -->
                                                <div th:if="${itemStat.index == 0}" style="margin-bottom:5px; color:#888; font-size:13px;">
                                                    ì£¼ë¬¸ë²ˆí˜¸ : <span th:text="${o.order_code}"></span>
                                                </div>
                                                <div style="margin-bottom:5px; color:#888; font-size:13px;">
                                                    íŒë§¤ì : <span th:text="${item.company_name != null ? item.company_name : '(ì£¼) ìƒí˜¸ëª…'}"></span>
                                                </div>

                                                <!-- ìƒí’ˆëª… / ìˆ˜ëŸ‰ / ê°€ê²© -->
                                                <div style="font-weight:600; color:#222;" th:text="${item.productName}"></div>
                                                <div style="font-size:13px; color:#666;">ìˆ˜ëŸ‰: <span th:text="${item.quantity}"></span>ê°œ</div>
                                                <div style="font-size:15px; font-weight:700; color:#000;" th:text="${#numbers.formatInteger(item.price, 0, 'COMMA')} + 'ì›'"></div>
                                            </div>
                                        </div>
                                    </th:block>
                                </td>

                                <!-- ì‹ ì²­ -->
                                <td style="vertical-align:top; padding:15px 0;">
                                    <th:block th:each="item : ${o.orderItems}">
                                        <div style="display:flex; flex-direction:column; align-items:center; gap:6px; margin-bottom:10px;">
                                            <button class="review-btn"
                                                    th:attr="data-product-id=${item.products_id},data-product-name=${item.productName}"
                                                    style="background-color:#000; color:#fff; border:none; width:90px; height:32px; font-size:12px; cursor:pointer;">
                                                ìƒí’ˆí‰ì“°ê¸°
                                            </button>

                                            <button class="exchange-btn"
                                                    th:attr="data-order-item-id=${item.id},
                                                    data-product-id=${item.products_id},
                 data-product-name=${item.productName},
                 data-product-img=|/NICHIYA/${item.url}|"
                                                    style="background-color:#fff; color:#000; border:1px solid #ddd; width:90px; height:32px; font-size:12px; cursor:pointer;">
                                                êµí™˜ì‹ ì²­
                                            </button>

                                            <button class="return-btn"
                                                    th:attr="data-order-item-id=${item.id},
                 data-product-name=${item.productName},
                 data-product-img=|/NICHIYA/${item.url}|"
                                                    style="background-color:#fff; color:#000; border:1px solid #ddd; width:90px; height:32px; font-size:12px; cursor:pointer;">
                                                ë°˜í’ˆì‹ ì²­
                                            </button>


                                        </div>
                                    </th:block>
                                </td>

                                <!-- ìƒíƒœ -->
                                <td th:text="${o.status}" style="vertical-align:top; padding-top:20px; font-weight:600; color:#000000;"></td>

                                <!-- í™•ì¸ -->
                                <td style="vertical-align:top; padding-top:20px;">
                                    <button class="confirm-purchase"
                                            style="background-color:#000; color:#fff; width:100px; height:34px; border:none; cursor:pointer;">
                                        êµ¬ë§¤í™•ì •
                                    </button>
                                </td>
                            </tr>
                        </th:block>
                    </table>
                    <div style=" height: 100px; margin-top:40px; display: flex; justify-content: center;">
                        <form action="" method="" style="">
                            <input type="button" class="prev-page" value="< ì´ì „">

                            <input type="button" value="1" style="border:1px solid #333; background-color: #333; color: white; height: 30px; width: 30px; margin-right:2px; line-height:1;">
                            <input type="button" value="2" style="cursor: pointer; border:1px solid #ddd; color: #555; height: 30px; width: 30px; margin-right:2px; line-height:1;">
                            <input type="button" value="3" style="cursor: pointer; border:1px solid #ddd; color: #555; height: 30px; width: 30px; line-height:1;">

                            <input type="button" class="next-page" value="ë‹¤ìŒ >" style="">
                        </form>
                    </div>
                </div>

                <div style="margin-bottom:50px;"></div>
            </div>
        </div>

    </div>

    <div style="margin-top:100px;"></div>
    <div id="footer"></div>
</main>
<!-- ì£¼ë¬¸ ìƒì„¸ ë§ˆì´í˜ì´ì§€_ë©”ì¸#2-->
<!-- ===== ëª¨ë‹¬ ë§ˆí¬ì—… ===== -->
<div class="modal-backdrop" id="orderModalBackdrop" aria-hidden="true"></div>
<div class="modal" id="orderModal" role="dialog" aria-modal="true" aria-labelledby="orderModalTitle" aria-hidden="true">
    <div class="modal-dialog" tabindex="-1" style="border-radius: 0px !important;">
        <div class="modal-header" style="border-radius: 0px !important;">
            <div>
                <span id="orderModalTitle">ì£¼ë¬¸ìƒì„¸</span>
                <span class="date" id="orderDate">2022-12-13</span>
            </div>
            <button class="modal-close" type="button" aria-label="ë‹«ê¸°" id="orderModalClose">âœ•</button>
        </div>

        <div class="modal-body">
            <!-- ì£¼ë¬¸ì •ë³´ -->
            <div class="section" style="padding-top:16px;">
                <div class="section-title">ì£¼ë¬¸ì •ë³´</div>
                <table class="order-info" style="border-top:1px solid; text-align: center; vertical-align: middle;">
                    <thead >
                    <tr style="background-color: #dedede !important;">
                        <th style="width:120px;">ë‚ ì§œ</th>
                        <th style="width:400px">ìƒí’ˆì •ë³´</th>
                        <th style="width:165px;">ê²°ì œê¸ˆì•¡</th>
                        <th style="">ìƒíƒœ</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr style="border-bottom: 1px solid #dddddd; height:180px; ">
                        <td style="">
                            2022-12-13
                        </td>
                        <td style="text-align: left; padding-left:10px;">
                            <div style="display: flex; align-items: center;">
                                <div>
                                    <img src="/images/product_list1.jpg" alt="" style="height:121px;">
                                </div>
                                <div style="padding-left:30px; letter-spacing: -1px;">
                                    <div style="margin-bottom:5px;"><a href="#" class="order-link" data-order-id="1012211341" style="color:gray;">ì£¼ë¬¸ë²ˆí˜¸ : 1012211341</a></div>
                                    <div style="margin-bottom:5px;"><a href="#" style="color:gray;">(ì£¼) ìƒí˜¸ëª…</a></div>
                                    <div style="margin-bottom:5px;"><a href="#" style="color:gray;">ìƒí’ˆëª…</a></div>
                                    <div style="margin-bottom:7px;">ìˆ˜ëŸ‰ : 1ê°œ</div>
                                    <div style="margin-bottom:5px; font-size: 20px; font-weight: 800;">34,000ì›</div>
                                </div>
                            </div>
                        </td>
                        <td style="">
                            <div style=" display: flex; margin-bottom: 5px;">
                                <div>íŒë§¤ê°€</div>
                                <div style="margin-left: auto;">34,000ì›</div>
                            </div>
                            <div style=" display: flex; margin-bottom: 28px;">
                                <div>í• ì¸</div>
                                <div style="margin-left: auto;">-3,000ì›</div>
                            </div>
                            <div style=" display: flex;">
                                <div>ê²°ì œê¸ˆì•¡</div>
                                <div style="margin-left: auto; font-weight: 800;">31,000ì›</div>
                            </div>
                        </td>
                        <td>
                            ë°°ì†¡ì™„ë£Œ
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <!-- ë°°ì†¡ì •ë³´ -->
            <div class="section" style="margin-bottom:45px; padding-top:2px;">
                <div class="section-title">ë°°ì†¡ì •ë³´</div>
                <table class="kv">
                    <tr style="border-top:1px solid #eee;"><td>ì´ë¦„</td><td id="shipName">í™ê¸¸ë™</td></tr>
                    <tr><td>ì—°ë½ì²˜</td><td id="shipPhone">010-1234-1001</td></tr>
                    <tr><td>ì£¼ì†Œ</td><td id="shipAddr">[210**] ë¶€ì‚°ê´‘ì—­ì‹œ ë¶€**êµ¬ **ë™ 121 10ì¸µ 1004í˜¸</td></tr>
                    <tr><td>ë°°ì†¡ìš”ì²­ì‚¬í•­</td><td id="shipMemo">ì—†ìŒ</td></tr>
                </table>
            </div>
        </div>
        <button class="sr-only" id="modalSentinel">ë</button>
    </div>
</div>

<!-- ===== ëª¨ë‹¬ ë™ì‘ ìŠ¤í¬ë¦½íŠ¸ ===== -->
<script>
    const modal = document.getElementById('orderModal');
    const backdrop = document.getElementById('orderModalBackdrop');
    const btnClose = document.getElementById('orderModalClose');
    const sentinel = document.getElementById('modalSentinel');

    function setText(id, value){ const el=document.getElementById(id); if(el) el.textContent=value; }
    function setSrc(id, value){ const el=document.getElementById(id); if(el) el.src=value; }

    function openOrderModal(data) {
        // ì¡´ì¬í•˜ëŠ” ìš”ì†Œë§Œ ì£¼ì…
        setText('orderDate', data.headerDate || '20xx-12-13');

        setText('shipName',  data.shipName  || 'í™ê¸¸ë™');
        setText('shipPhone', data.shipPhone || '010-1234-1001');
        setText('shipAddr',  data.shipAddr  || '[210**] ë¶€ì‚°ê´‘ì—­ì‹œ ë¶€**êµ¬ **ë™ 121 10ì¸µ 1004í˜¸');
        setText('shipMemo',  data.shipMemo  || 'ì—†ìŒ');
        // setText('infoDate' â€¦) ë“± ì—†ëŠ” ID ì ‘ê·¼ì€ ëª¨ë‘ ì‚­ì œ
        // setSrc('infoThumb', data.thumb); // í˜„ì¬ëŠ” í•´ë‹¹ ID ì—†ìŒ â†’ ì£¼ì„

        modal.classList.add('is-open');
        backdrop.classList.add('is-open');
        modal.querySelector('.modal-dialog').focus();
        document.body.style.overflow = 'hidden';
    }

    function closeOrderModal() {
        modal.classList.remove('is-open');
        backdrop.classList.remove('is-open');
        document.body.style.overflow = '';
    }

    // ì£¼ë¬¸ë²ˆí˜¸ ë§í¬ í´ë¦­ -> ëª¨ë‹¬ ì˜¤í”ˆ
    document.addEventListener('click', (e) => {
        const a = e.target.closest('.order-link');
        if (!a) return;
        console.log("ğŸ§© í´ë¦­í•œ ë²„íŠ¼:", btn);
        console.log("ğŸ‘‰ dataset.productName:", btn.dataset.productName);
        console.log("ğŸ‘‰ dataset.productImg:", btn.dataset.productImg);
        e.preventDefault();

        // ì‹¤ì œ ì„œë¹„ìŠ¤ì—ì„  ì—¬ê¸°ì—ì„œ ì£¼ë¬¸ë²ˆí˜¸(a.dataset.orderId)ë¡œ API í˜¸ì¶œí•´ ë°ì´í„° ì±„ì›€
        openOrderModal({
            headerDate: '2022-12-13',
            infoDate: '2022-12-13',
            orderNo: a.dataset.orderId,
            qty: '1',
            pay: '34,000',
            price: '34,000',
            discount: '-3,000',
            total: '34,000',
            status: 'ë°°ì†¡ì™„ë£Œ',
            thumb: '/images/product_list1.jpg',
            shipName: 'í™ê¸¸ë™',
            shipPhone: '010-1234-1001',
            shipAddr: '[210**] ë¶€ì‚°ê´‘ì—­ì‹œ ë¶€**êµ¬ **ë™ 121 10ì¸µ 1004í˜¸',
            shipMemo: 'ì—†ìŒ'
        });
    });

    // ë‹«ê¸°(ë²„íŠ¼/ë°°ê²½/Esc)
    btnClose.addEventListener('click', closeOrderModal);
    backdrop.addEventListener('click', closeOrderModal);
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal.classList.contains('is-open')) closeOrderModal();
        // í¬ì»¤ìŠ¤ íŠ¸ë©
        if (e.key === 'Tab' && modal.classList.contains('is-open')) {
            const focusables = modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
            const first = focusables[0], last = focusables[focusables.length - 1];
            if (e.shiftKey && document.activeElement === first) { last.focus(); e.preventDefault(); }
            else if (!e.shiftKey && document.activeElement === last) { first.focus(); e.preventDefault(); }
        }
    });
    sentinel.addEventListener('focus', () => modal.querySelector('.modal-close').focus());
</script>
<!-- ì£¼ë¬¸ ìƒì„¸ ë§ˆì´í˜ì´ì§€_ë©”ì¸#2-->
<!-- ì£¼ë¬¸ ìƒì„¸ ë§ˆì´í˜ì´ì§€_ë©”ì¸#3-->
<!-- ===== íŒë§¤ìì •ë³´ ëª¨ë‹¬ ===== -->
<div class="modal-backdrop" id="sellerModalBackdrop" aria-hidden="true"></div>
<div class="modal" id="sellerModal" role="dialog" aria-modal="true" aria-labelledby="sellerModalTitle" aria-hidden="true">
    <div class="modal-dialog" tabindex="-1" style="border-radius:0 !important;">
        <div class="modal-header" style="border-radius:0 !important;">
            <div>
                <span id="sellerModalTitle">íŒë§¤ìì •ë³´</span>
            </div>
            <button class="modal-close" type="button" aria-label="ë‹«ê¸°" id="sellerModalClose">âœ•</button>
        </div>

        <div class="modal-body">
            <div class="section" style="padding:25px;">
                <table class="kv" style="border-top:1px solid #eee;">
                    <tr><td>íŒë§¤ì ë“±ê¸‰</td><td>íŒŒì›Œë”œëŸ¬</td></tr>
                    <tr><td>ìƒí˜¸</td><td id="s-name"></td></tr>
                    <tr><td>ëŒ€í‘œì</td><td id="s-rep"></td></tr>
                    <tr><td>ì „í™”ë²ˆí˜¸</td><td id="s-tel"></td></tr>
                    <tr><td>FAX</td><td id="s-fax"></td></tr>
                    <tr><td>Email</td><td id="s-email"></td></tr>
                    <tr><td>ì‚¬ì—…ìë²ˆí˜¸</td><td id="s-bizno"></td></tr>
                    <tr><td>ì˜ì—…ì†Œì¬ì§€</td><td id="s-addr"></td></tr>
                </table>
                <div style="font-size:12px; color:#666; margin-top:10px;">
                    â€» ìœ„ ì •ë³´ëŠ” ì „ììƒê±°ë˜ë²• ì œ20ì¡° ì œ2í•­ ë° ì‹œí–‰ë ¹ ì œ25ì¡° ì œ2í•­ì— ì˜ê±°í•˜ì—¬ ì†Œë¹„ìë³´í˜¸ì— ì˜ê±° ê³µê°œí•©ë‹ˆë‹¤.
                </div>
                <div style="display:flex; justify-content:center; margin-top:14px;">
                    <button type="button" id="openInquiryBtn" style="width:120px; height:36px; border:0; background:#000000; color:#fff; font-weight:300;">ë¬¸ì˜í•˜ê¸°</button>
                </div>
            </div>
        </div>
        <button class="sr-only" id="sellerSentinel"></button>
    </div>
</div>
<script>
    // ====== íŒë§¤ì ëª¨ë‹¬ ì œì–´ ======
    const sModal     = document.getElementById('sellerModal');
    const sBackdrop  = document.getElementById('sellerModalBackdrop');
    const sBtnClose  = document.getElementById('sellerModalClose');
    const sSentinel  = document.getElementById('sellerSentinel');

    // íŒë§¤ìëª¨ë‹¬ ì¬ì˜¤í”ˆì„ ìœ„í•´ ë§ˆì§€ë§‰ ë°ì´í„°ì™€ í”Œë˜ê·¸ ì €ì¥
    let __lastSellerData = null;
    let __sellerWasOpenBeforeInquiry = false;

    function sSet(id, v){ const el=document.getElementById(id); if(el) el.textContent = v || ''; }

    function openSellerModal(data){
        __lastSellerData = data; // ë§ˆì§€ë§‰ íŒë§¤ìì •ë³´ ê¸°ì–µ
        sSet('s-name',  data.name);
        sSet('s-rep',   data.rep);
        sSet('s-tel',   data.tel);
        sSet('s-fax',   data.fax);
        sSet('s-email', data.email);
        sSet('s-bizno', data.bizno);
        sSet('s-addr',  data.addr);

        sModal.classList.add('is-open');
        sBackdrop.classList.add('is-open');
        sModal.querySelector('.modal-dialog').focus();
        document.body.style.overflow = 'hidden';
    }
    function closeSellerModal(){
        sModal.classList.remove('is-open');
        sBackdrop.classList.remove('is-open');
        document.body.style.overflow = '';
    }

    // â€œ(ì£¼) ìƒí˜¸ëª…â€ í´ë¦­ â†’ íŒë§¤ì ëª¨ë‹¬ ì˜¤í”ˆ
    document.addEventListener('click', (e) => {
        const a = e.target.closest('.seller-link');
        if(!a) return;

        e.preventDefault();
        openSellerModal({
            name:  a.dataset.sellerName  || '(ì£¼) ìƒí˜¸ëª…',
            rep:   a.dataset.sellerRep   || 'í™ê¸¸ë™',
            tel:   a.dataset.sellerTel   || '051-123-1000',
            fax:   a.dataset.sellerFax   || '051-123-1001',
            email: a.dataset.sellerEmail || 'company@abc.com',
            bizno: a.dataset.sellerBizno || '123-12-123457',
            addr:  a.dataset.sellerAddr  || '[210**] ë¶€ì‚°ê´‘ì—­ì‹œ ë¶€ì‚°ì§„êµ¬ ëŒ€ì—°ë™ 121 10ì¸µ 1004í˜¸'
        });
    });

    // ë‹«ê¸°(ë²„íŠ¼/ë°°ê²½/Esc) + í¬ì»¤ìŠ¤ íŠ¸ë©
    sBtnClose.addEventListener('click', closeSellerModal);
    sBackdrop.addEventListener('click', closeSellerModal);
    document.addEventListener('keydown', (e)=>{
        if(e.key==='Escape' && sModal.classList.contains('is-open')) closeSellerModal();

        if(e.key==='Tab' && sModal.classList.contains('is-open')){
            const focusables = sModal.querySelectorAll('button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"])');
            const first = focusables[0], last = focusables[focusables.length-1];
            if(e.shiftKey && document.activeElement===first){ last.focus(); e.preventDefault(); }
            else if(!e.shiftKey && document.activeElement===last){ first.focus(); e.preventDefault(); }
        }
    });
    sSentinel.addEventListener('focus', ()=> sModal.querySelector('.modal-close').focus());
</script>

<!-- ì£¼ë¬¸ ìƒì„¸ ë§ˆì´í˜ì´ì§€_ë©”ì¸#3-->
<!-- ì£¼ë¬¸ ìƒì„¸ ë§ˆì´í˜ì´ì§€_ë©”ì¸#4-->
<!-- ===== ë¬¸ì˜í•˜ê¸° ëª¨ë‹¬ ===== -->
<div class="modal-backdrop" id="inquiryModalBackdrop" aria-hidden="true"></div>
<div class="modal" id="inquiryModal" role="dialog" aria-modal="true" aria-labelledby="inquiryModalTitle" aria-hidden="true">
    <div class="modal-dialog" tabindex="-1" style="border-radius:0 !important; width:720px; max-width:calc(100% - 40px);">
        <div class="modal-header" style="border-radius:0 !important;">
            <div><span id="inquiryModalTitle">ë¬¸ì˜í•˜ê¸°</span></div>
            <button class="modal-close" type="button" aria-label="ë‹«ê¸°" id="inquiryModalClose">âœ•</button>
        </div>

        <form id="inquiryForm" class="modal-body" style="padding:18px;">
            <!-- ë¬¸ì˜ìœ í˜• -->
            <div class="section" style="padding:0; margin-bottom:12px;">
                <table class="kv" style="border-top:1px solid #eee;">
                    <tr>
                        <td style="width:100px; text-align:center; background:#f2f2f2;">ë¬¸ì˜ì¢…ë¥˜</td>
                        <td>
                            <label style="margin-right:14px;"><input type="radio" name="qtype" value="ìƒí’ˆ" checked> ìƒí’ˆ</label>
                            <label style="margin-right:14px;"><input type="radio" name="qtype" value="ë°°ì†¡"> ë°°ì†¡</label>
                            <label style="margin-right:14px;"><input type="radio" name="qtype" value="ë°˜í’ˆ/ì·¨ì†Œ"> ë°˜í’ˆ/ì·¨ì†Œ</label>
                            <label style="margin-right:14px;"><input type="radio" name="qtype" value="êµí™˜"> êµí™˜</label>
                            <label><input type="radio" name="qtype" value="ê¸°íƒ€"> ê¸°íƒ€</label>
                        </td>
                    </tr>
                    <tr>
                        <td style="text-align:center; background:#f2f2f2;">Email</td>
                        <td><input id="inqEmail" name="email" type="email" placeholder="you@example.com"
                                   style="border: none; border-bottom: 1px solid gray;width:270px; outline: none; height:34px; padding:6px 8px; box-sizing:border-box;"></td>
                    </tr>
                    <tr>
                        <td style="text-align:center; background:#f2f2f2;">ì œëª©</td>
                        <td><input id="inqSubject" name="subject" type="text"
                                   style="border: none; border-bottom: 1px solid gray; width:270px; outline: none; height:34px; padding:6px 8px; box-sizing:border-box;"></td>
                    </tr>
                    <tr>
                        <td style="text-align:center; background:#f2f2f2;">ë‚´ìš©</td>
                        <td>
              <textarea id="inqBody" name="body" rows="12"
                        style="outline: none; width:100%; resize: none; padding:8px; box-sizing:border-box;"></textarea>
                        </td>
                    </tr>
                </table>

                <div style="display:flex; justify-content:center; gap:10px; margin-top:16px;">
                    <button type="submit"
                            style="min-width:120px; height:38px; border:0; background:#000000; color:#fff; font-weight:300;">
                        ë“±ë¡í•˜ê¸°
                    </button>
                    <button type="button" id="inquiryCancelBtn"
                            style="min-width:120px; height:38px; border:0; background:#ccc; color:#fff;">
                        ì·¨ì†Œ
                    </button>
                </div>
            </div>
            <button class="sr-only" id="inquirySentinel">ë</button>
        </form>
    </div>
</div>
<script>
    // ===== ë¬¸ì˜í•˜ê¸° ëª¨ë‹¬ ì œì–´ =====
    const iModal     = document.getElementById('inquiryModal');
    const iBackdrop  = document.getElementById('inquiryModalBackdrop');
    const iBtnClose  = document.getElementById('inquiryModalClose');
    const iCancel    = document.getElementById('inquiryCancelBtn');
    const iForm      = document.getElementById('inquiryForm');
    const iSentinel  = document.getElementById('inquirySentinel');

    function openInquiryModal(prefill){
        // ì´ë©”ì¼ ìë™ ì±„ì›€(íŒë§¤ìëª¨ë‹¬ì˜ Email ì…€ì—ì„œ ê°€ì ¸ì˜´)
        const emailInput = document.getElementById('inqEmail');
        emailInput.value = (prefill && prefill.email) || document.getElementById('s-email')?.textContent?.trim() || '';

        iModal.classList.add('is-open');
        iBackdrop.classList.add('is-open');
        iModal.querySelector('.modal-dialog').focus();
        document.body.style.overflow = 'hidden';
    }
    function closeInquiryModal(){
        iModal.classList.remove('is-open');
        iBackdrop.classList.remove('is-open');
        document.body.style.overflow = '';
    }

    // íŒë§¤ìëª¨ë‹¬ì˜ [ë¬¸ì˜í•˜ê¸°] í´ë¦­ â†’ ë¬¸ì˜ì‘ì„± ëª¨ë‹¬ ì˜¤í”ˆ
    document.getElementById('openInquiryBtn')?.addEventListener('click', () => {
        __sellerWasOpenBeforeInquiry = true;   // ë¬¸ì˜ì°½ì„ ë„ìš°ê¸° ì§ì „ íŒë§¤ìëª¨ë‹¬ì´ ì—´ë ¤ìˆì—ˆìŒ
        // (ì„ íƒ) íŒë§¤ìëª¨ë‹¬ì€ ë‹«ê³  ë¬¸ì˜ëª¨ë‹¬ë§Œ ë„ìš°ê³  ì‹¶ë‹¤ë©´ ì•„ë˜ ë‘ ì¤„ì„ ìœ ì§€
        closeSellerModal && closeSellerModal();
        openInquiryModal({});
    });

    // ë‹«ê¸°/ì·¨ì†Œ/Esc/ë°±ë“œë¡­
    iBtnClose.addEventListener('click', closeInquiryModal);
    iCancel.addEventListener('click', () => {
        closeInquiryModal();
        // ë°”ë¡œ ì´ì „ì— íŒë§¤ìëª¨ë‹¬ì—ì„œ ë„˜ì–´ì˜¨ ê²½ìš°ì—ë§Œ ë‹¤ì‹œ ì—´ê¸°
        if (__sellerWasOpenBeforeInquiry && __lastSellerData) {
            openSellerModal(__lastSellerData);
        }
        __sellerWasOpenBeforeInquiry = false; // í”Œë˜ê·¸ ì´ˆê¸°í™”
    });
    iBackdrop.addEventListener('click', closeInquiryModal);
    document.addEventListener('keydown', (e)=>{
        if(e.key==='Escape' && iModal.classList.contains('is-open')) closeInquiryModal();

        // í¬ì»¤ìŠ¤ íŠ¸ë©
        if(e.key==='Tab' && iModal.classList.contains('is-open')){
            const focusables = iModal.querySelectorAll('button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"])');
            const first = focusables[0], last = focusables[focusables.length-1];
            if(e.shiftKey && document.activeElement===first){ last.focus(); e.preventDefault(); }
            else if(!e.shiftKey && document.activeElement===last){ first.focus(); e.preventDefault(); }
        }
    });
    iSentinel.addEventListener('focus', ()=> iModal.querySelector('.modal-close').focus());

    // ì œì¶œ(ë°ëª¨) â€” ì‹¤ì œ ì—°ë™ ì‹œ fetchë¡œ ì„œë²„ì— ì „ì†¡
    iForm.addEventListener('submit', (e)=>{
        e.preventDefault();
        const data = {
            qtype:   iForm.qtype.value,
            email:   iForm.email.value.trim(),
            subject: iForm.subject.value.trim(),
            body:    iForm.body.value.trim(),
        };
        console.log('ë¬¸ì˜ ë“±ë¡:', data); // TODO: fetch('/api/inquiry', {method:'POST', body:JSON.stringify(data)})
        alert('ë¬¸ì˜ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤. (ë°ëª¨)');
        closeInquiryModal();
    });
</script>
<!-- ì£¼ë¬¸ ìƒì„¸ ë§ˆì´í˜ì´ì§€_ë©”ì¸#4-->
<!-- ì£¼ë¬¸ ìƒì„¸ ë§ˆì´í˜ì´ì§€_ë©”ì¸#5-->
<!-- ===== êµ¬ë§¤í™•ì • ëª¨ë‹¬ ===== -->
<div class="modal-backdrop" id="buyModalBackdrop" aria-hidden="true"></div>
<div class="modal" id="buyModal" role="dialog" aria-modal="true" aria-labelledby="buyModalTitle" aria-hidden="true">
    <div class="modal-dialog" tabindex="-1" style="border-radius:0 !important; width:420px; max-width:calc(100% - 40px);">
        <div class="modal-header" style="border-radius:0 !important;">
            <div><span id="buyModalTitle">êµ¬ë§¤í™•ì •</span></div>
            <button class="modal-close" type="button" aria-label="ë‹«ê¸°" id="buyClose">âœ•</button>
        </div>

        <div class="modal-body" style="padding:57px 37px 30px">
            <p style="margin:0 0 3px 0; font-size:16px; line-height:1.6;">ìƒí’ˆì„ ë°›ìœ¼ì…¨ë‚˜ìš”?</p>
            <p style="margin:0 0 55px 0; color:#555; line-height:1.6;">ìƒí’ˆì„ ë°›ìœ¼ì‹  ë¶„ë§Œ êµ¬ë§¤í™•ì •ì„ í•´ì£¼ì„¸ìš”.</p>

            <div style="display:flex; justify-content:center; gap:10px; margin-top:18px;">
                <button type="button" id="buyOk"
                        style="min-width:120px; height:38px; border:0; background:#000000; color:#fff; font-weight:300;">
                    í™•ì¸
                </button>
                <button type="button" id="buyCancel"
                        style="min-width:120px; height:38px; border:0; background:#ccc; color:#fff;">
                    ì·¨ì†Œ
                </button>
            </div>
            <button class="sr-only" id="buySentinel"></button>
        </div>
    </div>
</div>
<script>
    // ===== êµ¬ë§¤í™•ì • ëª¨ë‹¬ ì œì–´ =====
    const buyModal     = document.getElementById('buyModal');
    const buyBackdrop  = document.getElementById('buyModalBackdrop');
    const buyCloseBtn  = document.getElementById('buyClose');
    const buyOk        = document.getElementById('buyOk');
    const buyCancel    = document.getElementById('buyCancel');
    const buySentinel  = document.getElementById('buySentinel');

    let __currentOrderId = null;   // ì–´ë–¤ ì£¼ë¬¸ì„ í™•ì •í•˜ëŠ”ì§€ ë³´ê´€

    function openBuyModal(orderId){
        __currentOrderId = orderId || null;
        buyModal.classList.add('is-open');
        buyBackdrop.classList.add('is-open');
        buyModal.querySelector('.modal-dialog').focus();
        document.body.style.overflow = 'hidden';
    }
    function closeBuyModal(){
        buyModal.classList.remove('is-open');
        buyBackdrop.classList.remove('is-open');
        document.body.style.overflow = '';
    }

    // â€œêµ¬ë§¤í™•ì •â€ ë²„íŠ¼ í´ë¦­ â†’ ëª¨ë‹¬ ì˜¤í”ˆ (ì´ë²¤íŠ¸ ìœ„ì„)
    document.addEventListener('click', (e)=>{
        const btn = e.target.closest('.confirm-purchase');
        if(!btn) return;

        // ê°™ì€ í–‰ì˜ ì£¼ë¬¸ë²ˆí˜¸(ì£¼ë¬¸ë²ˆí˜¸ : xxxx)ì—ì„œ idë¥¼ ì°¾ì•„ë´„
        const row = btn.closest('tr');
        const orderLink = row?.querySelector('.order-link');
        const orderId = orderLink?.dataset.orderId || null;

        e.preventDefault();
        openBuyModal(orderId);
    });

    // í™•ì¸/ì·¨ì†Œ/ë‹«ê¸°/ë°±ë“œë¡­/Esc
    buyOk.addEventListener('click', ()=>{
        // TODO: ì‹¤ì œ êµ¬ë§¤í™•ì • API í˜¸ì¶œ(fetch) ìœ„ì¹˜
        console.log('êµ¬ë§¤í™•ì • ì²˜ë¦¬ - ì£¼ë¬¸ë²ˆí˜¸:', __currentOrderId);

        // ë°ëª¨ë¡œ ë²„íŠ¼ ìƒíƒœë§Œ ë³€ê²½
        if (__currentOrderId){
            const btn = document.querySelector(`.order-link[data-order-id="${__currentOrderId}"]`)

                    ?.closest('tr')?.querySelector('.confirm-purchase');
            if (btn){
                btn.style.border = 'none';
                btn.textContent = 'êµ¬ë§¤í™•ì •ì™„ë£Œ';
                btn.disabled = true;
                btn.style.background = '#ccc';
                btn.style.color = '#fff';
                btn.style.cursor = 'default';
            }
        }
        closeBuyModal();
    });
    buyCancel.addEventListener('click', closeBuyModal);
    buyCloseBtn.addEventListener('click', closeBuyModal);
    buyBackdrop.addEventListener('click', closeBuyModal);
    document.addEventListener('keydown', (e)=>{
        if (e.key === 'Escape' && buyModal.classList.contains('is-open')) closeBuyModal();

        // í¬ì»¤ìŠ¤ íŠ¸ë©
        if (e.key === 'Tab' && buyModal.classList.contains('is-open')){
            const focusables = buyModal.querySelectorAll('button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"])');
            const first = focusables[0], last = focusables[focusables.length-1];
            if (e.shiftKey && document.activeElement===first) { last.focus(); e.preventDefault(); }
            else if (!e.shiftKey && document.activeElement===last) { first.focus(); e.preventDefault(); }
        }
    });
    buySentinel.addEventListener('focus', ()=> buyModal.querySelector('.modal-close').focus());
</script>
<!-- ì£¼ë¬¸ ìƒì„¸ ë§ˆì´í˜ì´ì§€_ë©”ì¸#5-->
<!-- ì£¼ë¬¸ ìƒì„¸ ë§ˆì´í˜ì´ì§€_ë©”ì¸#6-->
<!-- ===== ìƒí’ˆí‰ ëª¨ë‹¬ ===== -->
<div class="modal-backdrop" id="reviewModalBackdrop" aria-hidden="true"></div>
<div class="modal" id="reviewModal" role="dialog" aria-modal="true"
     aria-labelledby="reviewModalTitle" aria-hidden="true">
    <div class="modal-dialog" tabindex="-1" style="border-radius:0 !important; width:720px; max-width:calc(100% - 40px);">
        <div class="modal-header" style="border-radius:0 !important;">
            <div><span id="reviewModalTitle">ìƒí’ˆí‰ì‘ì„±í•˜ê¸°</span></div>
            <button class="modal-close" type="button" aria-label="ë‹«ê¸°" id="reviewClose">âœ•</button>
        </div>

        <form id="reviewForm" class="modal-body review-form">
            <table class="review-grid" style="border-top:1px solid #eee;">
                <tr>
                    <td>ìƒí’ˆëª…</td>
                    <td>
                        <span id="rvProductName">ìƒí’ˆëª… ì¶œë ¥</span>
                    </td>
                </tr>
                <tr>
                    <td>ë§Œì¡±ë„</td>
                    <td>
                        <div class="rating" role="radiogroup" aria-label="ë§Œì¡±ë„">
                            <input type="radio" id="star5" name="rating" value="5"><label for="star5" title="5ì "></label>
                            <input type="radio" id="star4" name="rating" value="4"><label for="star4" title="4ì "></label>
                            <input type="radio" id="star3" name="rating" value="3"><label for="star3" title="3ì "></label>
                            <input type="radio" id="star2" name="rating" value="2"><label for="star2" title="2ì "></label>
                            <input type="radio" id="star1" name="rating" value="1"><label for="star1" title="1ì "></label>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>ë‚´ìš©</td>
                    <td>
              <textarea id="rvBody" name="body" class="review-textarea"
                        placeholder="ìµœì†Œ 10ì ì´ìƒ, 200ì ë‚´ì™¸ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”."></textarea>
                        <div class="char-count"><span id="rvCount">0</span>/200</div>
                    </td>
                </tr>
                <tr>
                    <td>ì‚¬ì§„</td>
                    <td>
                        <input type="file" name="photo1" accept="image/*" style="display:block; margin-bottom:8px;">
                        <input type="file" name="photo2" accept="image/*" style="display:block; margin-bottom:8px;">
                        <input type="file" name="photo3" accept="image/*" style="display:block;">
                    </td>
                </tr>
            </table>

            <div class="review-actions">
                <button type="submit"
                        style="min-width:120px; height:38px; border:0; background:#000000; color:#fff; font-weight:300;">
                    ì‘ì„±ì™„ë£Œ
                </button>
                <button type="button" id="reviewCancel"
                        style="min-width:120px; height:38px; border:0; background:#ccc; color:#fff;">
                    ì·¨ì†Œ
                </button>
            </div>

            <button class="sr-only" id="reviewSentinel">ë</button>
        </form>
    </div>
</div>
<script>
    // ===== ìƒí’ˆí‰ ëª¨ë‹¬ ì œì–´ =====
    const ctxPath = window.location.pathname.startsWith('/NICHIYA') ? '/NICHIYA' : '';
    const rModal    = document.getElementById('reviewModal');
    const rBackdrop = document.getElementById('reviewModalBackdrop');
    const rCloseBtn = document.getElementById('reviewClose');
    const rCancel   = document.getElementById('reviewCancel');
    const rForm     = document.getElementById('reviewForm');
    const rSentinel = document.getElementById('reviewSentinel');

    // âœ… rvTitle ëŒ€ì‹  ìƒí’ˆëª… ì¶œë ¥ìš© span
    const rvProductName = document.getElementById('rvProductName');

    const rvBody  = document.getElementById('rvBody');
    const rvCount = document.getElementById('rvCount');

    // âœ… ì „ì—­ ë³€ìˆ˜ë¡œ í˜„ì¬ ìƒí’ˆ ID ì €ì¥
    let currentProductId = null;

    // í–‰ì˜ ìƒí’ˆëª… í…ìŠ¤íŠ¸ë¥¼ ì°¾ê¸°
    function getRowProductName(btn){
        const row = btn.closest('tr');
        const nameEl = row?.querySelector('td:nth-child(2) a[href="#"]:not(.order-link):not(.seller-link)');
        return nameEl?.textContent?.trim() || 'ìƒí’ˆëª…';
    }

    function openReviewModal(prefill){
        // âœ… ìƒí’ˆëª… ì„¸íŒ…
        if (rvProductName) rvProductName.textContent = prefill?.productName || 'ìƒí’ˆëª…';

        // ë³¸ë¬¸/ë³„ì  í”„ë¦¬ì…‹
        rvBody.value  = prefill?.body || '';

        // ê¸€ììˆ˜ ì´ˆê¸°í™”
        rvCount.textContent = String(rvBody.value.length);

        // ëª¨ë‹¬ ì˜¤í”ˆ
        rModal.classList.add('is-open');
        rBackdrop.classList.add('is-open');
        rModal.querySelector('.modal-dialog').focus();
        document.body.style.overflow = 'hidden';
    }

    function closeReviewModal(){
        rModal.classList.remove('is-open');
        rBackdrop.classList.remove('is-open');
        document.body.style.overflow = '';
    }

    // ë³¸ë¬¸ 200ì ì œí•œ
    rvBody.addEventListener('input', () => {
        if (rvBody.value.length > 200) rvBody.value = rvBody.value.slice(0,200);
        rvCount.textContent = String(rvBody.value.length);
    });

    // â€œìƒí’ˆí‰ì“°ê¸°â€ ë²„íŠ¼ â†’ ì˜¤í”ˆ
    document.addEventListener('click', (e) => {
        const btn = e.target.closest('.review-btn');
        if (!btn) return;
        e.preventDefault();

        // ë²„íŠ¼ì— ì €ì¥ëœ ìƒí’ˆ ID/ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
        currentProductId = btn.dataset.productId;
        const productName = btn.dataset.productName;

        // âœ…
        console.log("ğŸ§© ë²„íŠ¼ dataset.productId:", currentProductId);
        console.log("ğŸ§© ë²„íŠ¼ dataset.productName:", productName);

        // ëª¨ë‹¬ ì˜¤í”ˆ ì‹œ ìƒí’ˆëª… í‘œì‹œ
        openReviewModal({ productName });
    });

    // ë‹«ê¸°/ì·¨ì†Œ/ë°±ë“œë¡­/Esc
    rCloseBtn.addEventListener('click', closeReviewModal);
    rCancel.addEventListener('click', closeReviewModal);
    rBackdrop.addEventListener('click', closeReviewModal);
    document.addEventListener('keydown', (e)=>{
        if(e.key==='Escape' && rModal.classList.contains('is-open')) closeReviewModal();

        // í¬ì»¤ìŠ¤ íŠ¸ë©
        if(e.key==='Tab' && rModal.classList.contains('is-open')){
            const focusables = rModal.querySelectorAll('button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"])');
            const first = focusables[0], last = focusables[focusables.length-1];
            if(e.shiftKey && document.activeElement===first){ last.focus(); e.preventDefault(); }
            else if(!e.shiftKey && document.activeElement===last){ first.focus(); e.preventDefault(); }
        }
    });
    rSentinel.addEventListener('focus', ()=> rModal.querySelector('.modal-close').focus());

    // ì œì¶œ
    rForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const selected = rForm.querySelector('input[name="rating"]:checked');
        const rating = selected ? Number(selected.value) : 0;

        if (rating === 0) {
            alert('ë§Œì¡±ë„ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }
        if (rForm.body.value.trim().length < 10) {
            alert('ë‚´ìš©ì€ ìµœì†Œ 10ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        // âœ… ì„œë²„ì— ë³´ë‚¼ ë°ì´í„° êµ¬ì„±
        const formData = new FormData();
        formData.append("productId", currentProductId);
        formData.append("rating", rating);
        formData.append("body", rForm.body.value.trim());

        // âœ… ì „ì†¡ ì „ productId í™•ì¸ ë¡œê·¸
        console.log("ğŸ§© ì „ì†¡ë˜ëŠ” productId:", currentProductId);
        console.log("â­ rating:", rating);
        console.log("ğŸ“ body:", rForm.body.value.trim());

        try {
            const res = await fetch(`${ctxPath}/api/mypage/review`, {
                method: 'POST',
                body: formData
            });

            if (!res.ok) throw new Error('ë¦¬ë·° ë“±ë¡ ì‹¤íŒ¨');

            alert('ìƒí’ˆí‰ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
            closeReviewModal();

        } catch (err) {
            console.error('âŒ ìƒí’ˆí‰ ì „ì†¡ ì˜¤ë¥˜:', err);
            alert('ìƒí’ˆí‰ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    });



</script>
<!-- ì£¼ë¬¸ ìƒì„¸ ë§ˆì´í˜ì´ì§€_ë©”ì¸#6-->
<!-- ì£¼ë¬¸ ìƒì„¸ ë§ˆì´í˜ì´ì§€_ë©”ì¸#7-->
<!-- ===== ë°˜í’ˆì‹ ì²­ ëª¨ë‹¬ ===== -->
<div class="modal-backdrop" id="returnModalBackdrop" aria-hidden="true"></div>
<div class="modal" id="returnModal" role="dialog" aria-modal="true" aria-labelledby="returnModalTitle" aria-hidden="true">
    <div class="modal-dialog" tabindex="-1" style="border-radius:0 !important; width:860px; max-width:calc(100% - 40px);">
        <div class="modal-header" style="border-radius:0 !important;">
            <div>
                <span id="returnModalTitle">ë°˜í’ˆì‹ ì²­</span>
            </div>
            <button class="modal-close" type="button" aria-label="ë‹«ê¸°" id="returnClose">âœ•</button>
        </div>

        <div class="modal-body">
            <!-- ìƒí’ˆì •ë³´(ìš”ì•½) -->
            <div class="section" style="padding-top:16px;">
                <div class="section-title">ìƒí’ˆì •ë³´</div>
                <table class="order-info" style="border-top:1px solid; text-align:center; vertical-align:middle;">
                    <thead>
                    <tr style="background:#dedede !important;">
                        <th style="width:120px;">ë‚ ì§œ</th>
                        <th style="width:400px;">ìƒí’ˆì •ë³´</th>
                        <th style="width:165px;">ê²°ì œê¸ˆì•¡</th>
                        <th>ìƒíƒœ</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr style="border-bottom:1px solid #ddd; height:160px;">
                        <td id="rtDate">0000-00-00</td>
                        <td style="text-align:left; padding-left:10px;">
                            <div style="display:flex; align-items:center;">
                                <div><img id="rtThumb" src="/images/product_list1.jpg" alt="" style="height:100px;"></div>
                                <div style="padding-left:20px; letter-spacing:-1px;">
                                    <div style="margin-bottom:4px; color:gray;">ì£¼ë¬¸ë²ˆí˜¸ : <span id="rtOrderNo">-</span></div>
                                    <div style="margin-bottom:4px; color:gray;" id="rtSeller">(ì£¼) ìƒí˜¸ëª…</div>
                                    <div style="margin-bottom:6px; color:gray;" id="rtName">ìƒí’ˆëª…</div>
                                    <div style="margin-bottom:6px;" id="rtQty">ìˆ˜ëŸ‰ : 1ê°œ</div>
                                    <div style="font-size:18px; font-weight:800;" id="rtPrice">34,000ì›</div>
                                </div>
                            </div>
                        </td>
                        <td id="rtPay">
                            <div style=" display: flex; margin-bottom: 5px;">
                                <div>íŒë§¤ê°€</div>
                                <div style="margin-left: auto;">34,000ì›</div>
                            </div>
                            <div style=" display: flex; margin-bottom: 28px;">
                                <div>í• ì¸</div>
                                <div style="margin-left: auto;">-3,000ì›</div>
                            </div>
                            <div style=" display: flex;">
                                <div>ê²°ì œê¸ˆì•¡</div>
                                <div style="margin-left: auto; font-weight: 800;">31,000ì›</div>
                            </div>
                        </td>
                        <td id="rtStatus">ë°°ì†¡ì™„ë£Œ</td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <!-- ë°˜í’ˆì •ë³´ ì…ë ¥ -->
            <div class="section" style="padding-top:2px;">
                <div class="section-title">ë°˜í’ˆì •ë³´ ì…ë ¥</div>
                <table class="kv" style="border-top:1px solid #eee;">
                    <tr>
                        <td>ë°˜í’ˆìœ í˜•</td>
                        <td>
                            <label style="margin-right:14px;"><input type="radio" name="rtType" value="ë‹¨ìˆœ ë³€ì‹¬"> ë‹¨ìˆœ ë³€ì‹¬</label>
                            <label style="margin-right:14px;"><input type="radio" name="rtType" value="íŒŒì† ë° ë¶ˆëŸ‰"> íŒŒì† ë° ë¶ˆëŸ‰</label>
                            <label style="margin-right:14px;"><input type="radio" name="rtType" value="ì£¼ë¬¸ ì‹¤ìˆ˜"> ì£¼ë¬¸ ì‹¤ìˆ˜</label>
                            <label><input type="radio" name="rtType" value="ê¸°íƒ€"> ê¸°íƒ€</label>
                        </td>
                    </tr>
                    <tr>
                        <td>ì‚¬ìœ ì…ë ¥</td>
                        <td>
              <textarea id="rtReason" rows="7" style="width:100%; resize:none; outline:none; padding:8px; box-sizing:border-box;"
                        placeholder="ë°˜í’ˆ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”. (ìµœì†Œ 10ì)"></textarea>
                        </td>
                    </tr>
                    <tr>
                        <td>ì‚¬ì§„ì²¨ë¶€(ì„ íƒ)</td>
                        <td >
                            <input type="file" id="rtFile1" class="visually-hidden">
                            <label for="rtFile1" class="btn-file">íŒŒì¼ ì„ íƒ</label>
                            <span id="rtFile1Name">ì„ íƒëœ íŒŒì¼ ì—†ìŒ</span>
                        </td>
                    </tr>
                    <style>
                        /* í™”ë©´ì—ì„œë§Œ ìˆ¨ê¹€(ì ‘ê·¼ì„± OK) */
                        .visually-hidden{
                            position:absolute; width:1px; height:1px; padding:0; margin:-1px;
                            overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0;
                        }

                        /* ìš°ë¦¬ ì‚¬ì´íŠ¸ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
                        .btn-file{
                            display:inline-block;
                            min-width:96px;
                            padding:8px 14px;
                            background:#dedede;
                            color:#fff;
                            border:0;
                            font-weight:300;
                            text-align:center;
                            cursor:pointer;
                        }

                        .btn-file:hover{ filter:brightness(0.95); }
                        .btn-file:focus-visible{ outline:2px solid #000000; outline-offset:2px; }

                        #rtFile1Name{ margin-left:8px; color:#666; }

                    </style>
                    <script>
                        // íŒŒì¼ëª… í‘œì‹œ
                        document.getElementById('rtFile1').addEventListener('change', function(){
                            const nameSpan = document.getElementById('rtFile1Name');
                            nameSpan.textContent = this.files?.length ? this.files[0].name : 'ì„ íƒëœ íŒŒì¼ ì—†ìŒ';
                        });
                    </script>
                </table>

                <div style="display:flex; justify-content:center; gap:10px; margin-top:16px;">
                    <button type="button" id="rtSubmit"
                            style="min-width:120px; height:38px; border:0; background:#000000; color:#fff; font-weight:300;">ë°˜í’ˆì‹ ì²­</button>
                    <button type="button" id="rtCancel"
                            style="min-width:120px; height:38px; border:0; background:#ccc; color:#fff;">ì·¨ì†Œ</button>
                </div>
            </div>
        </div>

        <button class="sr-only" id="returnSentinel"></button>
    </div>
</div>

<!-- ===== êµí™˜ì‹ ì²­ ëª¨ë‹¬ ===== -->
<div class="modal-backdrop" id="exchangeModalBackdrop" aria-hidden="true"></div>
<div class="modal" id="exchangeModal" role="dialog" aria-modal="true" aria-labelledby="exchangeModalTitle" aria-hidden="true">
    <div class="modal-dialog" tabindex="-1" style="border-radius:0 !important; width:860px; max-width:calc(100% - 40px);">
        <div class="modal-header" style="border-radius:0 !important;">
            <div><span id="exchangeModalTitle">êµí™˜ì‹ ì²­</span></div>
            <button class="modal-close" type="button" aria-label="ë‹«ê¸°" id="exClose">âœ•</button>
        </div>

        <div class="modal-body">
            <!-- ìƒí’ˆì •ë³´(ìš”ì•½) -->
            <div class="section" style="padding-top:16px;">
                <div class="section-title">ìƒí’ˆì •ë³´</div>
                <table class="order-info" style="border-top:1px solid; text-align:center; vertical-align:middle;">
                    <thead>
                    <tr style="background:#dedede !important;">
                        <th style="width:120px;">ë‚ ì§œ</th>
                        <th style="width:400px;">ìƒí’ˆì •ë³´</th>
                        <th style="width:165px;">ê²°ì œê¸ˆì•¡</th>
                        <th>ìƒíƒœ</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr style="border-bottom:1px solid #ddd; height:160px;">
                        <td id="exDate">0000-00-00</td>
                        <td style="text-align:left; padding-left:10px;">
                            <div style="display:flex; align-items:center;">
                                <div><img id="exThumb" src="/images/product_list1.jpg" alt="" style="height:100px;"></div>
                                <div style="padding-left:20px; letter-spacing:-1px;">
                                    <div style="margin-bottom:4px; color:gray;">ì£¼ë¬¸ë²ˆí˜¸ : <span id="exOrderNo">-</span></div>
                                    <div style="margin-bottom:4px; color:gray;" id="exSeller">(ì£¼) ìƒí˜¸ëª…</div>
                                    <div style="margin-bottom:6px; color:gray;" id="exName">ìƒí’ˆëª…</div>
                                    <div style="margin-bottom:6px;" id="exQty">ìˆ˜ëŸ‰ : 1ê°œ</div>
                                    <div style="font-size:18px; font-weight:800;" id="exPrice">34,000ì›</div>
                                </div>
                            </div>
                        </td>
                        <td id="exPay">
                            <div style="display:flex; margin-bottom:5px;">
                                <div>íŒë§¤ê°€</div>
                                <div style="margin-left:auto;">34,000ì›</div>
                            </div>
                            <div style="display:flex; margin-bottom:28px;">
                                <div>í• ì¸</div>
                                <div style="margin-left:auto;">-3,000ì›</div>
                            </div>
                            <div style="display:flex;">
                                <div>ê²°ì œê¸ˆì•¡</div>
                                <div style="margin-left:auto; font-weight:800;">31,000ì›</div>
                            </div>
                        </td>
                        <td id="exStatus">ë°°ì†¡ì™„ë£Œ</td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <!-- êµí™˜ì •ë³´ ì…ë ¥ -->
            <div class="section" style="padding-top:2px;">
                <div class="section-title">êµí™˜ì •ë³´ ì…ë ¥</div>
                <table class="kv" style="border-top:1px solid #eee;">
                    <tr>
                        <td>êµí™˜ìœ í˜•</td>
                        <td>
                            <label style="margin-right:14px;"><input type="radio" name="exType" value="ë‹¨ìˆœ êµí™˜"> ë‹¨ìˆœ êµí™˜</label>
                            <label style="margin-right:14px;"><input type="radio" name="exType" value="íŒŒì† ë° ë¶ˆëŸ‰"> íŒŒì† ë° ë¶ˆëŸ‰</label>
                            <label style="margin-right:14px;"><input type="radio" name="exType" value="ì£¼ë¬¸ ì‹¤ìˆ˜"> ì£¼ë¬¸ ì‹¤ìˆ˜</label>
                            <label><input type="radio" name="exType" value="ê¸°íƒ€"> ê¸°íƒ€</label>
                        </td>
                    </tr>
                    <tr>
                        <td>ì‚¬ìœ ì…ë ¥</td>
                        <td>
              <textarea id="exReason" rows="7" style="width:100%; resize:none; outline:none; padding:8px; box-sizing:border-box;"
                        placeholder="êµí™˜ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”. (ìµœì†Œ 10ì)"></textarea>
                        </td>
                    </tr>
                    <tr>
                        <td>ì‚¬ì§„ì²¨ë¶€(ì„ íƒ)</td>
                        <td style="vertical-align:middle;">
                            <input type="file" id="exFile1" class="visually-hidden" accept="image/*">
                            <label for="exFile1" class="btn-file">íŒŒì¼ ì„ íƒ</label>
                            <span id="exFile1Name">ì„ íƒëœ íŒŒì¼ ì—†ìŒ</span>
                        </td>
                    </tr>
                </table>

                <div style="display:flex; justify-content:center; gap:10px; margin-top:16px;">
                    <button type="button" id="exSubmit"
                            style="min-width:120px; height:38px; border:0; background:#000000; color:#fff; font-weight:300;">êµí™˜ì‹ ì²­</button>
                    <button type="button" id="exCancel"
                            style="min-width:120px; height:38px; border:0; background:#ccc; color:#fff;">ì·¨ì†Œ</button>
                </div>
            </div>
        </div>

        <button class="sr-only" id="exchangeSentinel">ë</button>
    </div>
</div>
</body>
<script>
    // ===== ë°˜í’ˆì‹ ì²­ ëª¨ë‹¬ ì œì–´ =====
    const rtModal     = document.getElementById('returnModal');
    const rtBackdrop  = document.getElementById('returnModalBackdrop');
    const rtClose     = document.getElementById('returnClose');
    const rtCancel    = document.getElementById('rtCancel');
    const rtSubmit    = document.getElementById('rtSubmit');
    const rtSentinel  = document.getElementById('returnSentinel');

    function setText(id, v){ const el=document.getElementById(id); if(el) el.textContent = v; }
    function setSrc(id, v){ const el=document.getElementById(id); if(el) el.src = v; }
    // === ê³µí†µ ì´ë¯¸ì§€ ê²½ë¡œ ì²˜ë¦¬ ===
    function resolveImageUrl(imgPath) {
        if (!imgPath) return `${ctxPath}/images/no_image.jpg`;
        if (imgPath.startsWith('http')) return imgPath;
        return `${ctxPath}/${imgPath.replace(/^\/+/, '')}`;
    }


    // âœ… DBì—ì„œ ë°˜í’ˆ ìƒí’ˆ ìƒì„¸ ë¶ˆëŸ¬ì˜¤ê¸°
    async function openReturnModal(fromBtn){
        const productBlock = fromBtn.closest('div');
        const orderItemId = fromBtn.dataset.orderItemId;
        const userId = document.getElementById('userData')?.dataset.userId || null;
        // âœ… ë²„íŠ¼ì—ì„œ ì§ì ‘ img ì¶”ì 
        const thumb = productBlock?.querySelector('img')?.getAttribute('src') ||
            fromBtn.dataset.productImg ||
            '/NICHIYA/images/no_image.jpg';


        setSrc('rtThumb', thumb);


        console.log("ğŸ“¦ [DEBUG] ë°˜í’ˆ ë²„íŠ¼ í´ë¦­ë¨:", orderItemId, "í˜„ì¬ userId:", userId);

        try {
            const res = await fetch(`${ctxPath}/api/mypage/exchange/item/${orderItemId}`);
            if (!res.ok) throw new Error('ìƒí’ˆ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
            const data = await res.json();

            console.log("ğŸ“¦ [DEBUG] DBì¡°íšŒ ê²°ê³¼:", data);

            // âœ… ëª¨ë‹¬ ë°ì´í„° ì„¸íŒ…
            setText('rtDate', data.ORDER_DATE);
            setText('rtOrderNo', data.ORDER_CODE);
            setText('rtSeller', `(ì£¼) ${data.COMPANY_NAME}`);
            setText('rtName', data.PRODUCT_NAME);
            setText('rtQty', `ìˆ˜ëŸ‰ : ${data.QUANTITY}ê°œ`);
            setText('rtPrice', `${Number(data.ORIGINAL_PRICE).toLocaleString()}ì›`);
            setText('rtStatus', data.ORDER_STATUS);
            setSrc('rtThumb', resolveImageUrl(data.url) || '/NICHIYA/images/no_image.jpg'); // âœ… ìˆ˜ì •ë¨

            // âœ… ê°€ê²©í‘œì‹œ
            const rtPayEl = document.getElementById('rtPay');
            const discount = Number(data.DISCOUNT_PRICE) < 0 ? data.DISCOUNT_PRICE : `-${data.DISCOUNT_PRICE}`;
            const total = Number(data.PAID_PRICE).toLocaleString();

            rtPayEl.innerHTML = `
                <div style="display:flex; margin-bottom:5px;">
                    <div>íŒë§¤ê°€</div><div style="margin-left:auto;">${Number(data.ORIGINAL_PRICE).toLocaleString()}ì›</div>
                </div>
                <div style="display:flex; margin-bottom:28px;">
                    <div>í• ì¸</div><div style="margin-left:auto;">${discount}ì›</div>
                </div>
                <div style="display:flex;">
                    <div>ê²°ì œê¸ˆì•¡</div><div style="margin-left:auto; font-weight:800;">${total}ì›</div>
                </div>
            `;

            // ì…ë ¥ ì´ˆê¸°í™”
            document.querySelectorAll('input[name="rtType"]').forEach(r=> r.checked=false);
            document.getElementById('rtReason').value = '';
            document.getElementById('rtFile1').value = '';
            document.getElementById('rtFile1Name').textContent = 'ì„ íƒëœ íŒŒì¼ ì—†ìŒ';

            // âœ… ëª¨ë‹¬ ì˜¤í”ˆ
            rtModal.classList.add('is-open');
            rtBackdrop.classList.add('is-open');
            rtModal.querySelector('.modal-dialog').focus();
            document.body.style.overflow = 'hidden';

            const rtNameEl = document.getElementById('rtName');
            if (rtNameEl) rtNameEl.dataset.orderItemId = orderItemId;

        } catch (err) {
            console.error("âŒ [DEBUG] ë°˜í’ˆ ëª¨ë‹¬ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err);
            alert("ìƒí’ˆ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }
    }

    function closeReturnModal(){
        rtModal.classList.remove('is-open');
        rtBackdrop.classList.remove('is-open');
        document.body.style.overflow = '';
    }

    document.getElementById('rtFile1').addEventListener('change', function(){
        const nameSpan = document.getElementById('rtFile1Name');
        nameSpan.textContent = this.files?.length ? this.files[0].name : 'ì„ íƒëœ íŒŒì¼ ì—†ìŒ';
    });

    document.addEventListener('click', (e)=>{
        const btn = e.target.closest('.return-btn');
        if(!btn) return;
        e.preventDefault();
        openReturnModal(btn);
    });

    rtClose.addEventListener('click', closeReturnModal);
    rtCancel.addEventListener('click', closeReturnModal);
    rtBackdrop.addEventListener('click', closeReturnModal);

    // ===== ë°˜í’ˆì‹ ì²­ ì „ì†¡ =====
    rtSubmit.addEventListener('click', async ()=>{
        const type = document.querySelector('input[name="rtType"]:checked')?.value || '';
        const reason = document.getElementById('rtReason').value.trim();
        const userId = document.getElementById('userData')?.dataset.userId || null;
        const orderItemId = document.getElementById('rtName')?.dataset.orderItemId;
        const fileInput = document.getElementById('rtFile1');

        if (!type) return alert('ë°˜í’ˆìœ í˜•ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        if (reason.length < 10) return alert('ì‚¬ìœ ë¥¼ ìµœì†Œ 10ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        if (!userId) return alert('ë¡œê·¸ì¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
        if (!orderItemId) return alert('ìƒí’ˆ IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

        const formData = new FormData();
        formData.append("order_item_id", orderItemId);
        formData.append("user_id", userId);
        formData.append("reason_text", reason);
        formData.append("reason_code", type);
        formData.append("status", "REQUESTED");
        formData.append("pickupAddress", "");

        if (fileInput.files.length > 0) {
            formData.append("evidence_urls", fileInput.files[0]);
        }

        try {
            const res = await fetch(`${ctxPath}/api/mypage/return`, {
                method: 'POST',
                body: formData
            });
            if (!res.ok) throw new Error('ì„œë²„ ì˜¤ë¥˜');
            alert('ë°˜í’ˆì‹ ì²­ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.');
            closeReturnModal();
        } catch (err) {
            console.error('âŒ ë°˜í’ˆì‹ ì²­ ì‹¤íŒ¨:', err);
            alert('ë°˜í’ˆì‹ ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    });
</script>


<script>
    let userId = null;

    // ===== êµí™˜ì‹ ì²­ ëª¨ë‹¬ ì œì–´ =====

        const exModal     = document.getElementById('exchangeModal');
        const exBackdrop  = document.getElementById('exchangeModalBackdrop');
        const exClose     = document.getElementById('exClose');
        const exCancel    = document.getElementById('exCancel');
        const exSubmit    = document.getElementById('exSubmit');
        const exSentinel  = document.getElementById('exchangeSentinel');

        function exSetText(id, v){ const el=document.getElementById(id); if(el) el.textContent=v; }
        function exSetSrc(id, v){ const el=document.getElementById(id); if(el) el.src=v; }
    // === ê³µí†µ ì´ë¯¸ì§€ ê²½ë¡œ ì²˜ë¦¬ ===
    function resolveImageUrl(imgPath) {
        if (!imgPath) return `${ctxPath}/images/no_image.jpg`;
        if (imgPath.startsWith('http')) return imgPath;
        return `${ctxPath}/${imgPath.replace(/^\/+/, '')}`;
    }




    async function openExchangeModal(fromBtn){
        const productBlock = fromBtn.closest('div');
        const orderItemId = fromBtn.dataset.orderItemId;
        const userId = document.getElementById('userData')?.dataset.userId || null;
        // âœ… ë²„íŠ¼ì—ì„œ ì§ì ‘ img ì¶”ì 
        const thumb = productBlock?.querySelector('img')?.getAttribute('src') ||
            fromBtn.dataset.productImg ||
            '/NICHIYA/images/no_image.jpg';

        exSetSrc('exThumb', thumb);

        console.log("ğŸ§© êµí™˜ ë²„íŠ¼ í´ë¦­ë¨:", orderItemId, "í˜„ì¬ userId:", userId);

        try {
        // âœ… ë°±ì—”ë“œì—ì„œ ìƒí’ˆ ìƒì„¸ ì¡°íšŒ
        const res = await fetch(`${ctxPath}/api/mypage/exchange/item/${orderItemId}`);
        if (!res.ok) throw new Error('ìƒí’ˆ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
        const data = await res.json();

        console.log("ğŸ“¦ [DEBUG] DBì¡°íšŒ ê²°ê³¼:", data);

        // âœ… ëª¨ë‹¬ ë°ì´í„° ë°”ì¸ë”©
        exSetText('exDate', data.ORDER_DATE);
        exSetText('exOrderNo', data.ORDER_CODE);
        exSetText('exSeller', `(ì£¼) ${data.COMPANY_NAME}`);
        exSetText('exName', data.PRODUCT_NAME);
        exSetText('exQty', `ìˆ˜ëŸ‰ : ${data.QUANTITY}ê°œ`);
        exSetText('exPrice', `${Number(data.ORIGINAL_PRICE).toLocaleString()}ì›`);
        exSetText('exStatus', data.ORDER_STATUS);
        exSetSrc('exThumb', resolveImageUrl(data.url) || '/NICHIYA/images/no_image.jpg');


            const exPayEl = document.getElementById('exPay');
        const discount = Number(data.DISCOUNT_PRICE) < 0 ? data.DISCOUNT_PRICE : `-${data.DISCOUNT_PRICE}`;
        const total = Number(data.PAID_PRICE).toLocaleString();

        exPayEl.innerHTML = `
            <div style="display:flex; margin-bottom:5px;">
                <div>íŒë§¤ê°€</div><div style="margin-left:auto;">${Number(data.ORIGINAL_PRICE).toLocaleString()}ì›</div>
            </div>
            <div style="display:flex; margin-bottom:28px;">
                <div>í• ì¸</div><div style="margin-left:auto;">${discount}ì›</div>
            </div>
            <div style="display:flex;">
                <div>ê²°ì œê¸ˆì•¡</div><div style="margin-left:auto; font-weight:800;">${total}ì›</div>
            </div>
        `;

        // ì…ë ¥ ì´ˆê¸°í™”
        document.querySelectorAll('input[name="exType"]').forEach(r=> r.checked=false);
        document.getElementById('exReason').value = '';
        document.getElementById('exFile1').value = '';
        document.getElementById('exFile1Name').textContent = 'ì„ íƒëœ íŒŒì¼ ì—†ìŒ';

        // âœ… ëª¨ë‹¬ ì˜¤í”ˆ
        exModal.classList.add('is-open');
        exBackdrop.classList.add('is-open');
        exModal.setAttribute('aria-hidden', 'false');
        exModal.querySelector('.modal-dialog').focus();
        document.body.style.overflow = 'hidden';

        // âœ… dataset ì €ì¥
        const exNameEl = document.getElementById('exName');
        if (exNameEl) exNameEl.dataset.orderItemId = orderItemId;

    } catch (err) {
        console.error("âŒ [DEBUG] êµí™˜ ëª¨ë‹¬ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err);
        alert("ìƒí’ˆ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    }
    }

        // ====== ë‹«ê¸° ======
        function closeExchangeModal(){
        exModal.classList.remove('is-open');
        exBackdrop.classList.remove('is-open');
        exModal.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
    }

        // ====== ì´ë²¤íŠ¸ ======
        document.addEventListener('click', (e)=>{
        const btn = e.target.closest('.exchange-btn');
        if(!btn) return;
        e.preventDefault();
        openExchangeModal(btn);
    });
        exClose.addEventListener('click', closeExchangeModal);
        exCancel.addEventListener('click', closeExchangeModal);
        exBackdrop.addEventListener('click', closeExchangeModal);
        document.addEventListener('keydown', (e)=>{
        if (e.key === 'Escape' && exModal.classList.contains('is-open')) closeExchangeModal();
    });

        // íŒŒì¼ëª… í‘œì‹œ
        document.getElementById('exFile1').addEventListener('change', function(){
        const nameSpan = document.getElementById('exFile1Name');
        nameSpan.textContent = this.files?.length ? this.files[0].name : 'ì„ íƒëœ íŒŒì¼ ì—†ìŒ';
    });

        // ====== ì œì¶œ ======
        exSubmit.addEventListener('click', async () => {
        const type = document.querySelector('input[name="exType"]:checked')?.value || '';
        const reason = document.getElementById('exReason').value.trim();
        if (!type) return alert('êµí™˜ìœ í˜•ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        if (reason.length < 10) return alert('ì‚¬ìœ ë¥¼ ìµœì†Œ 10ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.');

        const userId = document.getElementById('userData')?.dataset.userId || null;
        const orderItemId = document.getElementById('exName')?.dataset.orderItemId;
        if (!orderItemId) return alert('ìƒí’ˆ IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

        const formData = new FormData();
        formData.append("user_id", Number(userId));
        formData.append("order_item_id", orderItemId);
        formData.append("reason_text", reason);
        formData.append("desired_option", type);
        formData.append("reason_code", "ETC");
        formData.append("status", "REQUESTED");

        const fileInput = document.getElementById('exFile1');
        if (fileInput.files.length > 0) {
        formData.append("evidence_urls", fileInput.files[0]);
    }

        console.log("ğŸ“¤ [DEBUG] FormData ë‚´ìš©:", Array.from(formData.entries()));

        try {
        const res = await fetch(`${ctxPath}/api/mypage/exchange`, { method: 'POST', body: formData });
        if (!res.ok) throw new Error('ì„œë²„ ì˜¤ë¥˜');
        alert('êµí™˜ì‹ ì²­ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.');
        closeExchangeModal();
    } catch (err) {
        console.error("âŒ [DEBUG] êµí™˜ì‹ ì²­ ì‹¤íŒ¨:", err);
        alert("êµí™˜ì‹ ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
    });
</script>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const rowsPerPage = 5; // í•œ í˜ì´ì§€ë‹¹ ë³´ì—¬ì¤„ ì£¼ë¬¸ ìˆ˜
        const table = document.getElementById("orderListTable");
        if (!table) return;

        const rows = Array.from(table.querySelectorAll("tr")).slice(1); // í—¤ë” ì œì™¸
        const totalRows = rows.length;
        const totalPages = Math.ceil(totalRows / rowsPerPage);

        // í˜ì´ì§€ í‘œì‹œ ë²„íŠ¼ë“¤ (form ì•ˆì˜ input[type=button])
        const prevBtn = document.querySelector(".prev-page");
        const nextBtn = document.querySelector(".next-page");
        const pageBtns = Array.from(document.querySelectorAll('input[type="button"]'))
            .filter(btn => !btn.classList.contains("prev-page") && !btn.classList.contains("next-page"));

        let currentPage = 1;

        // í˜„ì¬ í˜ì´ì§€ì— í•´ë‹¹í•˜ëŠ” í–‰ë§Œ í‘œì‹œ
        function showPage(page) {
            const start = (page - 1) * rowsPerPage;
            const end = start + rowsPerPage;

            rows.forEach((row, idx) => {
                row.style.display = idx >= start && idx < end ? "" : "none";
            });

            // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
            pageBtns.forEach((btn, i) => {
                if (i + 1 === page) {
                    btn.style.backgroundColor = "#333";
                    btn.style.color = "white";
                    btn.style.border = "1px solid #333";
                } else {
                    btn.style.backgroundColor = "white";
                    btn.style.color = "#555";
                    btn.style.border = "1px solid #ddd";
                }
            });

            // ì´ì „/ë‹¤ìŒ ë²„íŠ¼ í™œì„±/ë¹„í™œì„±
            prevBtn.disabled = page === 1;
            nextBtn.disabled = page === totalPages;
            currentPage = page;
        }

        // í˜ì´ì§€ ë²„íŠ¼ í´ë¦­
        pageBtns.forEach((btn, i) => {
            btn.addEventListener("click", () => showPage(i + 1));
        });

        // ì´ì „/ë‹¤ìŒ ë²„íŠ¼ í´ë¦­
        prevBtn.addEventListener("click", () => {
            if (currentPage > 1) showPage(currentPage - 1);
        });
        nextBtn.addEventListener("click", () => {
            if (currentPage < totalPages) showPage(currentPage + 1);
        });

        // ì´ˆê¸° í‘œì‹œ
        showPage(1);
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        document.addEventListener('click', (e) => {
            const btn = e.target.closest('.confirm-purchase');
            if (!btn) return;

            const orderId = btn.dataset.orderId;
            if (!orderId) {
                console.warn('âš ï¸ data-order-id ì†ì„± ì—†ìŒ');
                return;
            }

            // âœ… ê°™ì€ ì£¼ë¬¸ë²ˆí˜¸ë¥¼ ê°€ì§„ ëª¨ë“  êµ¬ë§¤í™•ì • ë²„íŠ¼ ì°¾ê¸°
            const sameOrderConfirmBtns = document.querySelectorAll(`.confirm-purchase[data-order-id="${orderId}"]`);

            sameOrderConfirmBtns.forEach(confirmBtn => {
                // âœ… í•´ë‹¹ í–‰(tr) ì°¾ê¸°
                const row = confirmBtn.closest('tr');

                // âœ… êµí™˜/ë°˜í’ˆ ë²„íŠ¼ ì°¾ê¸°
                const exchangeBtns = row.querySelectorAll('.exchange-btn');
                const returnBtns = row.querySelectorAll('.return-btn');

                // âœ… êµ¬ë§¤í™•ì • ë²„íŠ¼ ìƒíƒœ ë³€ê²½
                confirmBtn.textContent = 'êµ¬ë§¤í™•ì •ì™„ë£Œ';
                confirmBtn.style.backgroundColor = '#ccc';
                confirmBtn.style.color = '#fff';
                confirmBtn.style.cursor = 'default';
                confirmBtn.disabled = true;

                // âœ… êµí™˜/ë°˜í’ˆ ë²„íŠ¼ ë¹„í™œì„±í™”
                [...exchangeBtns, ...returnBtns].forEach(x => {
                    if (x) {
                        x.disabled = true;
                        x.style.opacity = '0.4';
                        x.style.cursor = 'not-allowed';
                    }
                });
            });

            console.log(`âœ… ì£¼ë¬¸ë²ˆí˜¸ ${orderId}ì˜ ëª¨ë“  ìƒí’ˆì´ êµ¬ë§¤í™•ì • ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        });
    });
</script>
<div th:replace="~{admin/_footer.html}"></div>