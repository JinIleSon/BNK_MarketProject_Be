<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta name="_csrf" th:content="${_csrf != null ? _csrf.token : ''}">
    <meta name="_csrf_header" th:content="${_csrf != null ? _csrf.headerName : ''}">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>product_views</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bodoni+Moda:opsz,wght@6..96,400;500&family=Noto+Serif+KR:wght@300;400&display=swap" rel="stylesheet">

    <style>
        html{ scrollbar-gutter: stable; }
        .icon-btn{ background:none; border:1px solid #000; cursor:pointer; width:40px; height:40px; display:grid; place-items:center; }

        .overlay{ position:fixed; inset:0; background:rgba(255,255,255,.28); backdrop-filter:blur(1px); -webkit-backdrop-filter:blur(1px); opacity:0; pointer-events:none; transition:opacity .25s ease; z-index:1000; }
        .overlay.open{ opacity:1; pointer-events:auto; }

        .overlay__panel{ position:absolute; top:0; left:0; width:50vw; max-width:900px; height:100%; background:#fff; transform:translateX(-100%); transition:transform .35s ease; will-change:transform; display:flex; flex-direction:column; }
        .overlay.open .overlay__panel{ transform:translateX(0); }

        .overlay__top{ display:flex; align-items:center; gap:24px; padding:20px; }
        .overlay__close{ background:none; width:100px; height:50px; cursor:pointer; position:relative; border:none; margin-left:.3%; }
        .overlay__close::before,.overlay__close::after{ content:""; position:absolute; left:15px; right:10px; top:25px; height:2px; background:#000; }
        .overlay__close::before{ transform:rotate(45deg); } .overlay__close::after{ transform:rotate(-45deg); }

        .overlay__menu{ display:grid; grid-template-columns:180px auto; gap:24px; padding:40px 20px; font-size:16px; }
        .overlay__menu a{ text-decoration:none; color:#000; display:block; padding:8px 0; }
        .overlay__menu a[data-cat].is-active{ font-weight:700; text-decoration:underline; }

        :root{ --glass-bg:rgba(255,255,255,.55); --glass-blur:8px; }
        *{ box-sizing:border-box; }
        body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
        a{ color:inherit; text-decoration:none; }
        ul{ margin:0; padding:0; list-style:none; }

        .site-header{ position:sticky; top:0; z-index:900; }
        .site-header::before{ content:""; position:absolute; inset:0; background:rgba(255,255,255,0); transition:background .4s ease; z-index:-1; pointer-events:none; }
        .site-header:hover::before{ background:rgba(255,255,255,.7); }
        .site-header .inner{ position:relative; z-index:1; display:flex; align-items:center; gap:24px; padding:16px 24px; border-bottom:1px solid #000; }

        footer a{ text-decoration:none; font-weight:300; color:#000; }

        .prev-page,.next-page{ background:#fff; border:none; width:50px; height:30px; cursor:pointer; }
        .prev-page{ margin-right:15px; }
        .next-page{ margin-left:15px; margin-right:3px; }

        .title-didone{ text-align:center; font-family:'Bodoni Moda','Didot','Bodoni 72','Times New Roman',serif; margin-left:45px; font-weight:400; letter-spacing:.02em; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
        .title-didone.ko{ font-family:'Noto Serif KR','Bodoni Moda',serif; font-weight:300; }

        .select-box{ position:relative; display:block; width:100%; }
        .select-wrap{ position:relative; display:inline-block; width:155px; height:27px; }
        .select-wrap select{ appearance:none; -webkit-appearance:none; -moz-appearance:none; padding:0 25px 0 10px; width:100%; height:100%; box-sizing:border-box; }
        .select-wrap select::-ms-expand{ display:none; }
        .select-wrap::after{ content:"â–¼"; position:absolute; right:8px; top:50%; transform:translateY(-50%); font-size:12px; color:#000; pointer-events:none; }

        #subcol{ grid-row:span 2; height:900px; position:relative; padding:0; }
        #subcol .panel{ position:absolute; inset:0; padding:20px; overflow:auto; opacity:0; transform:translateY(6px); transition:opacity .35s ease, transform .35s ease; visibility:hidden; pointer-events:none; }
        #subcol .panel.show{ opacity:1; transform:none; visibility:visible; pointer-events:auto; }
        .menu-grid{ display:grid; grid-template-columns:repeat(2,auto); column-gap:50px; row-gap:6px; padding:0; margin:0; justify-content:start; }
        .menu-grid li{ list-style:none; }
        /* í† ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆëŠ” ê¸°ì¡´ ê·¸ëŒ€ë¡œ ì‚¬ìš© */
        .toast-container{
            position: fixed;
            right: 16px;
            bottom: 16px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }

        /* í† ìŠ¤íŠ¸ ë°•ìŠ¤ */
        .toast{
            min-width: 180px;   /* í¬ê¸° â†“ */
            max-width: 300px;   /* í¬ê¸° â†“ */
            padding: 12px 16px; /* ì—¬ë°± â†‘ */
            border-radius: 12px;/* ë‘¥ê¸€ê²Œ */
            color: #fff;
            box-shadow: 0 12px 28px rgba(0,0,0,.20);
            font-size: 14px;
            line-height: 1.45;
            opacity: 0;
            transform: translateY(8px);
            backdrop-filter: blur(2px);
            animation: toast-in .28s ease forwards, toast-out .28s ease forwards var(--leave, 1.8s);
            pointer-events: auto; /* í˜¸ë²„ ì¼ì‹œì •ì§€ìš© */
        }
        .toast.toast--info   { background: #3e3e3e; }
        .toast.toast--success{ background: #2e7d32; }
        .toast.toast--error  { background: #b63b3b; } /* í†¤ ì•½ê°„ ë‹¤ìš´ */
        .toast.toast--warn   { background: #b26a00; }

        @keyframes toast-in{
            from{ opacity:0; transform: translateY(8px); }
            to  { opacity:1; transform: translateY(0); }
        }
        @keyframes toast-out{
            to{ opacity:0; transform: translateY(8px); }
        }
    </style>
</head>

<body th:object="${product}">
<div th:replace="~{main/header.html}"></div>

<!-- í—¤ë” ì¥ë°”êµ¬ë‹ˆ ë§í¬ì—ë„ uid ë¶™ì—¬ì£¼ê¸° -->
<script th:inline="javascript">
    const CART_PAGE_URL_TPL = /*[[@{/product/cart(uid=${uid})}]]*/ '/NICHIYA/product/cart';
    document.addEventListener('DOMContentLoaded', () => {
        const link = document.getElementById('basketCountLink');
        if (link) link.setAttribute('href', CART_PAGE_URL_TPL);
    });
</script>

<!-- ë³¸ë¬¸ -->
<div style="height:100%; display:flex; flex-direction:column; justify-content:center; align-items:center; margin:0 auto;">
    <div style="display:flex; width:100%; max-width:1270px;">
        <div style="font-size:18px; margin-right:auto;"><b>ìƒí’ˆëª©ë¡</b></div>
        <div>HOME > <span
                th:utext="${categoryId == 4 ? 'íŒ¨ì…˜ > <b>ì—¬ì„±ì˜ë¥˜</b>' :
                            (categoryId == 3 ? 'íŒ¨ì…˜ > <b>ë‚¨ì„±ì˜ë¥˜</b>' :
                            (categoryId == 2 ? 'íŒ¨ì…˜ > <b>í‚¤ì¦ˆì˜ë¥˜</b>' :
                            (categoryId == 5 ? 'íŒ¨ì…˜ > <b>ìŠ¤í¬ì¸ ì˜ë¥˜</b>' :
                            (categoryId == 7 ? 'ë·°í‹° > <b>í™”ì¥í’ˆ</b>' :
                            (categoryId == 8 ? 'ë·°í‹° > <b>í–¥ìˆ˜</b>' :
                            (categoryId == 10 ? 'ì „ìì œí’ˆ > <b>ìƒí™œê¸°ê¸°</b>' :
                            (categoryId == 11 ? 'ì „ìì œí’ˆ > <b>ìŒí–¥ê¸°ê¸°</b>' :
                            (categoryId == 13 ? 'í™ˆ > <b>ëŒ€í˜•ê°€êµ¬</b>' :
                            (categoryId == 14 ? 'í™ˆ > <b>ì†Œí˜•ê°€êµ¬</b>' :
                            (categoryId == 16 ? 'ë ˆì € > <b>ìŠ¤í„°í”„</b>' :
                            (categoryId == 17 ? 'ë ˆì € > <b>íƒˆê²ƒ</b>' : '<b>ì „ì²´ìƒí’ˆ</b>')))))))))))}"></span></div>
    </div>
    <hr style="border:none; border-top:1px solid #000; margin-bottom:40px; width:100%; max-width:1270px;">

    <div style="display:flex; gap:100px; width:1270px;">
        <!-- ë©”ì¸ ì´ë¯¸ì§€ -->
        <img id="mainImage"
             style="width:700px; height:700px; object-fit:cover;"
             alt="ë©”ì¸ ì´ë¯¸ì§€"
             th:with="mi=*{mainImage}"
             th:src="${mi} != null ? @{|/${mi}|} : @{/images/placeholder.png}"/>

        <!-- ìš°ì¸¡ íŒ¨ë„ -->
        <div style="width:500px; margin-top:100px;">
            <div style="margin-top:10px;">
        <span style="font-size:14px; font-weight:800; letter-spacing:-1px; color:gray;"
              th:text="|ìƒí’ˆë²ˆí˜¸ : *{product_code}|">ìƒí’ˆë²ˆí˜¸</span>

                <span style="float:right; font-weight:800;"
                      th:with="bn=*{brand_name}"
                      th:text="${bn != null ? bn : '(ì£¼)ìƒí˜¸ëª…'}">(ì£¼)ìƒí˜¸ëª…</span>
            </div>

            <hr style="border:none; border-top:1px solid #ddd;">
            <div>
                <span style="font-weight:800;" th:text="*{product_name}">ìƒí’ˆëª…</span>
                <span style="float:right;">
          <span th:with="avg=${product.rating_avg} ?: 0.0"
                th:text="${#numbers.formatDecimal(avg,1,1)}">0.0</span>
          <a href="#reviews" id="reviewLink" class="review-link"
             th:text="'ìƒí’ˆí‰ë³´ê¸°'">ìƒí’ˆí‰ë³´ê¸°</a>
        </span>
                <style>
                    .review-link {
                        position: relative;
                        font-weight: 500;
                        color: #555;
                        text-decoration: none;
                        transition: color 0.3s ease;
                    }

                    .review-link::after {
                        content: "";
                        position: absolute;
                        bottom: -2px;
                        left: 0;
                        width: 0;
                        height: 2px;
                        background: linear-gradient(90deg, #2c3e50, #34495e); /* ì–´ë‘ìš´ ë„¤ì´ë¹„ ê·¸ë¼ë°ì´ì…˜ */
                        transition: width 0.3s ease;
                    }

                    .review-link:hover {
                        color: #2c3e50; /* hover ì‹œ ì–´ë‘ìš´ ë„¤ì´ë¹„ë¡œ */
                    }

                    .review-link:hover::after {
                        width: 100%;
                    }
                </style>
            </div>

            <hr style="border:none; border-top:1px solid #ddd;">
            <div style="display:flex; align-items:center;">
        <span style="color:gray;" th:with="p=*{price}">
          <s th:text="|â‚© ${#numbers.formatInteger(p != null ? p : 0,3,'COMMA')}|">â‚© 150,000</s>
        </span>
                <font color="red" th:if="*{discount_rate} > 0"
                      th:text="|&nbsp;&nbsp;*{discount_rate}%â†“|">&nbsp;&nbsp;10%â†“</font>
                <button type="button" id="claimCouponBtn"
                        style="cursor:pointer;border:1px red solid; color:red; margin-left:23px; margin-right:28px; font-size:12px;">
                    ì¿ í°ë°›ê¸°
                </button>
                <span>ğŸ’³ë¬´ì´ìí• ë¶€ ğŸ’³ì¹´ë“œì¶”ê°€í˜œíƒ</span>
            </div>

            <!-- ë‹¨ê°€ í‘œì‹œ -->
            <span id="priceLabel"
                  th:with="sp=*{sale_price}, pp=*{price}, unit=${sp != null ? sp : (pp != null ? pp : 0)}"
                  th:attr="data-unit=${unit}"
                  style="font-size:18px;"
                  th:text="|â‚© ${#numbers.formatInteger(unit,3,'COMMA')}|">â‚© 135,000</span>

            <hr style="border:none; border-top:1px solid #ddd;">
            <div>
                <span style="color:#84a9e2;" th:if="*{delichar} == 0">ë¬´ë£Œë°°ì†¡</span>
                <span style="color:#84a9e2;" th:if="*{delichar} != 0"
                      th:with="dc=*{delichar}"
                      th:text="|ë°°ì†¡ë¹„ â‚© ${#numbers.formatInteger(dc != null ? dc : 0,3,'COMMA')}|">ë°°ì†¡ë¹„</span>
                <span id="etaText" style="font-weight:600;">ë„ì°© ì˜ˆì •ì¼ ê³„ì‚°ì¤‘â€¦</span>
                <br>
                <span style="display:block; padding-top:4px; font-size:14px; font-weight:600; color:gray; letter-spacing:-1px;">ë³¸ìƒí’ˆì€ êµ­ë‚´ë°°ì†¡ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.</span>
            </div>
            <script>
                // KST(í•œêµ­) ê¸°ì¤€ìœ¼ë¡œ +offsetDaysì˜ ë‚ ì§œë¥¼ "ëª¨ë ˆ (ê¸ˆ) 7/8 ë„ì°©ì˜ˆì •" í˜•ì‹ìœ¼ë¡œ ë Œë”
                function renderEtaLabel(offsetDays = 2) {
                    const el = document.getElementById('etaText');
                    if (!el) return;

                    const now = new Date();
                    const target = new Date(now.getTime() + offsetDays * 24 * 60 * 60 * 1000);

                    // KSTë¡œ ì•ˆì „í•˜ê²Œ íŒŒì¸  ì¶”ì¶œ (KSTëŠ” DST ì—†ìŒ)
                    const dtf = new Intl.DateTimeFormat('ko-KR', {
                        timeZone: 'Asia/Seoul',
                        month: 'numeric',
                        day: 'numeric',
                        weekday: 'short'
                    });
                    const parts = dtf.formatToParts(target);
                    const month = parts.find(p => p.type === 'month').value;   // "7"
                    const day   = parts.find(p => p.type === 'day').value;     // "8"
                    const wday  = parts.find(p => p.type === 'weekday').value; // "ê¸ˆ"

                    const rel = offsetDays === 0 ? 'ì˜¤ëŠ˜'
                        : offsetDays === 1 ? 'ë‚´ì¼'
                            : offsetDays === 2 ? 'ëª¨ë ˆ'
                                : `${offsetDays}ì¼ ë’¤`;

                    el.textContent = `${rel} (${wday}) ${month}/${day} ë„ì°©ì˜ˆì •`;
                }

                document.addEventListener('DOMContentLoaded', () => renderEtaLabel(2));
            </script>

            <hr style="border:none; border-top:1px solid #ddd;">
            <span style="letter-spacing:-1px;">ì›ì‚°ì§€ - ìƒì„¸ì„¤ëª… ì°¸ê³ </span>
            <hr style="border:none; border-top:1px solid #ddd;">

            <!-- ì˜µì…˜/ìˆ˜ëŸ‰ -->
            <div class="select-box">
                <form action="" method="" onsubmit="return false;">
                    <input type="hidden" name="productId" th:value="*{id}"/>
                    <input type="hidden" id="uidHidden" th:value="${uid}"/>

                    <div class="select-wrap">
                        <select name="optionId" id="optionSelect" style="width:155px; height:27px; border:1px solid #ddd;"
                                th:with="opts=*{options}">
                            <option value="">ì„ íƒí•˜ê¸°</option>
                            <option th:each="op : ${opts != null ? opts : #lists.list()}"
                                    th:if="${op != null}"
                                    th:value="${op.id}"
                                    th:text="${op.optionName}">ì˜µì…˜</option>
                        </select>
                    </div>

                    <hr style="border:none; border-top:1px solid #ddd;">
                    <span style="display:block; margin-bottom:5px; font-size:12px;" th:text="*{product_name}">ì„ íƒí•œ ìƒí’ˆëª…</span>

                    <div style="display:flex;">
                        <button type="button" onclick="decrease()" style="width:23px; height:25px; background:#f1f2f4; border:1px solid #f1f2f4;">-</button>
                        <div id="number" style="font-weight:800; font-size:10px; display:flex; width:30px; height:25px; border:1px solid #f1f2f4; justify-content:center; align-items:center;">1</div>
                        <button type="button" onclick="increase()" style="width:23px; height:25px; background:#f1f2f4; border:1px solid #f1f2f4;">+</button>

                        <div id="linePrice" style="display:flex; align-items:center; margin-left:auto; font-size:12px;"
                             th:with="sp=*{sale_price}, pp=*{price}, unit=${sp != null ? sp : (pp != null ? pp : 0)}"
                             th:text="${#numbers.formatInteger(unit,3,'COMMA')}">135,000</div>
                        <button type="button" style="border:none; background:#fff;">X</button>
                    </div>

                    <div id="totalPrice" style="float:right; font-size:14px; font-weight:600; margin-top:7px;"
                         th:with="sp=*{sale_price}, pp=*{price}, unit=${sp != null ? sp : (pp != null ? pp : 0)}"
                         th:text="|ì´ ìƒí’ˆê¸ˆì•¡ â‚© ${#numbers.formatInteger(unit,3,'COMMA')}|">ì´ ìƒí’ˆê¸ˆì•¡ â‚© 135,000</div>

                    <br>
                    <div style="display:flex; width:100%; gap:10px; margin-top:10px; margin-bottom:97px;">
                        <button type="button" onclick="addToCart()"
                                style="cursor:pointer;color:#fff; height:35px; background:#bfbfbf; border:none; font-size:13px; font-weight:300; width:47%;">ì¥ë°”êµ¬ë‹ˆ</button>
                        <button type="button" onclick="buyNow()"
                                style="cursor:pointer;margin-left:auto; color:#fff; background:#5e8fd7; border:none; font-size:13px; font-weight:300; width:47%;">êµ¬ë§¤í•˜ê¸°</button>
                    </div>

                    <div class="banner-box" id="bannerBox" style="height:100px !important;">
                        <img th:src="@{/images/product_view1.jpg}"
                        alt="ë°°ë„ˆê´‘ê³ "
                        style="width:487px; height:100px;">
                    </div>
                    <div style="font-size: 11px;">Image by <a href="https://www.freepik.com/">Freepik</a></div>
                </form>
            </div>
            <style>
                .banner-box{
                    width:100%;
                    height:100px;
                    overflow:hidden;        /* íŠ€ì–´ë‚˜ê°€ëŠ” ë¶€ë¶„ ìë¥´ê¸° */
                    background:#000;        /* ë°°ë„ˆê°€ ì–´ë‘ìš´ í†¤ì´ë©´ ë¸”ë™, í•„ìš”ì‹œ ë°”ê¾¸ì„¸ìš” */
                    border-radius:4px;
                }
                .banner-box img{
                    width:100%;
                    height:100%;
                    object-fit:cover;       /* ê°€ë“ ì±„ìš°ê³  ë„˜ì¹˜ëŠ” ê±´ ì˜ë¼ëƒ„ */
                    display:block;
                }
            </style>

            <script th:inline="javascript">
                const CLAIM_COUPON_URL = /*[[@{/product/coupons/claim}]]*/ '/NICHIYA/product/coupons/claim';

                async function claimCoupon(){
                    const btn = document.getElementById('claimCouponBtn');
                    const { headerName, token } = getCsrf();

                    // ì„œë²„ê°€ í¼ ì „ì†¡ì„ ê¸°ëŒ€í•˜ëŠ” ê²½ìš° ëŒ€ë¹„ (íŒŒë¼ë¯¸í„°ê°€ ì—†ì–´ë„ ë°”ë””ëŠ” ë¹ˆ ê°’ìœ¼ë¡œ ë³´ëƒ„)
                    const body = new URLSearchParams(); // í•„ìš”í•˜ë©´ body.append('couponId', '...');

                    try{
                        const res = await fetch(CLAIM_COUPON_URL, {
                            method: 'POST',
                            credentials: 'same-origin',  // ì¿ í‚¤(ì„¸ì…˜) í™•ì‹¤íˆ í¬í•¨
                            headers: {
                                'Accept': 'application/json, text/plain, */*',
                                'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
                                'X-Requested-With': 'XMLHttpRequest',
                                ...(token ? { [headerName]: token } : {})
                            },
                            body
                        });

                        // ìƒíƒœì½”ë“œë³„ ì‚¬ìš©ì ë©”ì‹œì§€
                        if (res.status === 401){ toast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error'); return; }
                        if (res.status === 403){ toast('ë³´ì•ˆ í† í°ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.', 'error'); return; }
                        if (res.status === 404){ toast('ì¿ í° ë°œê¸‰ ê²½ë¡œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•´ ì£¼ì„¸ìš”.', 'error'); return; }
                        if (res.status === 409){ toast('ì´ë¯¸ ë°œê¸‰ëœ ì¿ í°ì…ë‹ˆë‹¤.', 'warn'); return; }
                        if (!res.ok){ toast('ì¿ í° ë°œê¸‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (' + res.status + ')', 'error'); return; }

                        // ì‘ë‹µì´ JSONì¼ ìˆ˜ë„/ì•„ë‹ ìˆ˜ë„ ìˆìœ¼ë‹ˆ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
                        let data = null, text = null;
                        const ctype = res.headers.get('content-type') || '';
                        if (ctype.includes('application/json')) data = await res.json();
                        else text = await res.text();

                        // ì„œë²„ í‘œì¤€ ì‘ë‹µ ì¼€ì´ìŠ¤
                        if (data && data.ok === false){ toast(data.message || 'ì´ë¯¸ ë°œê¸‰ë˜ì—ˆê±°ë‚˜ ì¡°ê±´ ë¯¸ì¶©ì¡±ì…ë‹ˆë‹¤.', 'warn'); return; }

                        toast('ì¿ í°ì´ ë°œê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                        if (btn) btn.disabled = true;
                    }catch(err){
                        console.error('claimCoupon error:', err);
                        toast('ì¿ í° ë°œê¸‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                    }
                }


                document.addEventListener('DOMContentLoaded', () => {
                    const btn = document.getElementById('claimCouponBtn');
                    if (btn) btn.addEventListener('click', claimCoupon);
                });
                <!-- ì»¨íŠ¸ë¡¤ëŸ¬ ì—°ë™ (URLì€ ì „ë¶€ íƒ€ì„ë¦¬í”„ê°€ ìƒì„±) -->
                // ì—”ë“œí¬ì¸íŠ¸ (ì»¨í…ìŠ¤íŠ¸/uid ìë™ í¬í•¨)
                const ADD_TO_CART_URL = /*[[@{/product/cart(uid=${uid})}]]*/ '/NICHIYA/product/cart';
                const ADD_AND_GO_URL  = /*[[@{/product/cart/add-and-go(uid=${uid})}]]*/ '/NICHIYA/product/cart/add-and-go';
                const CART_PAGE_URL   = /*[[@{/product/cart(uid=${uid})}]]*/ '/NICHIYA/product/cart';

                // CSRF
                function readMeta(name){
                    const el = document.querySelector(`meta[name="${name}"]`);
                    return el ? el.content : null;
                }
                function readCookie(name){
                    const m = document.cookie.match(new RegExp('(?:^|; )' + name + '=([^;]*)'));
                    return m ? decodeURIComponent(m[1]) : null;
                }
                function getCsrf(){
                    const headerName = readMeta('_csrf_header') || 'X-CSRF-TOKEN';
                    const token      = readMeta('_csrf')        || readCookie('XSRF-TOKEN');
                    return { headerName, token };
                }

                // ê°’
                function readQty(){ const t = document.getElementById('number')?.innerText?.trim(); const n = Number(t); return Number.isFinite(n)&&n>0?n:1; }
                function readOptionId(){ const sel = document.getElementById('optionSelect'); return sel ? (sel.value || '') : ''; }
                function hasOptions(){ const sel = document.getElementById('optionSelect'); return !!sel && sel.options && sel.options.length > 1; }
                function readProductId(){ const el = document.querySelector('input[name="productId"]'); return el ? el.value : ''; }
                function readUid(){ return document.getElementById('uidHidden')?.value || ''; }

                // â”€â”€â”€â”€â”€ í† ìŠ¤íŠ¸: X ì—†ì´ ìë™ì†Œë©¸ â”€â”€â”€â”€â”€
                function getToastContainer(){
                    let c = document.querySelector('.toast-container');
                    if(!c){
                        c = document.createElement('div');
                        c.className = 'toast-container';
                        c.setAttribute('aria-live','polite');
                        c.setAttribute('aria-atomic','true');
                        document.body.appendChild(c);
                    }
                    return c;
                }

                /**
                 * toast(message, typeOrDanger?, durationMs?)
                 * type: 'info' | 'success' | 'error' | 'warn'
                 * ê¸°ì¡´ì²˜ëŸ¼ boolean(true=error)ë„ ì§€ì›
                 */
                function toast(msg, typeOrDanger, duration){
                    let type = 'info';
                    if (typeof typeOrDanger === 'string') type = typeOrDanger;
                    if (typeof typeOrDanger === 'boolean') type = typeOrDanger ? 'error' : 'info';

                    const dur = Number.isFinite(duration) ? duration : 1600;

                    const wrap = getToastContainer();
                    const t = document.createElement('div');
                    t.className = `toast toast--${type}`;
                    t.style.setProperty('--leave', `${dur/1000}s`);
                    t.textContent = String(msg);

                    const closeEl = t.querySelector('.toast__close');
                    if (closeEl) closeEl.addEventListener('click', () => removeToast(t));

                    let timer = setTimeout(() => removeToast(t), dur + 250);
                    t.addEventListener('mouseenter', () => { t.style.animationPlayState = 'paused'; clearTimeout(timer); });
                    t.addEventListener('mouseleave', () => { t.style.animationPlayState = 'running'; timer = setTimeout(() => removeToast(t), 600); });

                    wrap.appendChild(t);
                }

                function removeToast(el){
                    if(!el) return;
                    el.style.animation = 'toast-out .25s ease forwards';
                    el.addEventListener('animationend', () => el.remove(), { once:true });
                }
                // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ìƒˆ í† ìŠ¤íŠ¸ êµ¬í˜„ ë â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

                // íŒŒë¼ë¯¸í„°
                function buildParams(){
                    const p = new URLSearchParams();
                    p.append('productId', readProductId());
                    const opt = readOptionId(); if (opt) p.append('optionId', opt);
                    p.append('qty', String(readQty()));
                    const u = readUid(); if (u) p.append('uid', String(u));
                    return p;
                }

                // ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸° (AJAX)
                async function addToCart(){
                    if (hasOptions() && !readOptionId()){
                        toast('ì˜µì…˜ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.', true);
                        document.getElementById('optionSelect')?.focus();
                        return;
                    }
                    const { headerName, token } = getCsrf();
                    try{
                        const res = await fetch(ADD_TO_CART_URL, {
                            method: 'POST',
                            headers: {
                                'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8',
                                ...(token ? { [headerName]: token } : {})
                            },
                            body: buildParams().toString()
                        });
                        if (!res.ok) throw new Error('HTTP ' + res.status);
                        const json = await res.json();
                        const link = document.getElementById('basketCountLink');
                        if (link && typeof json.itemCount === 'number'){
                            link.textContent = `ë°”ìŠ¤ì¼“ë°± [${json.itemCount}]`;
                        }
                        toast('ì¥ë°”êµ¬ë‹ˆì— ë‹´ì•˜ìŠµë‹ˆë‹¤.');
                    }catch(e){
                        console.error(e); toast('ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸° ì‹¤íŒ¨', true);
                    }
                }

                // êµ¬ë§¤í•˜ê¸° (POST â†’ redirect)
                function buyNow(){
                    if (hasOptions() && !readOptionId()){
                        toast('ì˜µì…˜ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.', true);
                        document.getElementById('optionSelect')?.focus();
                        return;
                    }
                    const { token } = getCsrf();
                    const params = buildParams();

                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = ADD_AND_GO_URL;

                    if (token){
                        const input = document.createElement('input');
                        input.type='hidden'; input.name='_csrf'; input.value=token;
                        form.appendChild(input);
                    }
                    for (const [k,v] of params.entries()){
                        const el = document.createElement('input');
                        el.type='hidden'; el.name=k; el.value=v; form.appendChild(el);
                    }
                    document.body.appendChild(form);
                    form.submit();
                }

                // ìˆ˜ëŸ‰/ì´ë¯¸ì§€ êµì²´
                const unitPrice = (() => { const el=document.getElementById('priceLabel'); const raw=el?.dataset?.unit ?? '0'; return Number(raw)||0; })();
                let count=1; const min=1, max=100;
                const formatKRW=n=>n.toLocaleString('ko-KR');
                function render(){ const q=document.getElementById('number'), l=document.getElementById('linePrice'), t=document.getElementById('totalPrice'); const sub=unitPrice*count; if(q) q.innerText=String(count); if(l) l.textContent=formatKRW(sub); if(t) t.textContent=`ì´ ìƒí’ˆê¸ˆì•¡ â‚© ${formatKRW(sub)}`; }
                function increase(){ if(count<max){ count++; render(); } }
                function decrease(){ if(count>min){ count--; render(); } }
                function swapMain(th){ const main=document.getElementById('mainImage'); if(main && th && th.src){ main.src=th.src; } }

                window.increase=increase; window.decrease=decrease;
                window.swapMain=swapMain; window.addToCart=addToCart; window.buyNow=buyNow;
                render();
                (function(){
                    const GAP = 100; // ë” ì•„ë˜ë¡œ ë‚´ë¦´ í”½ì…€ (ì›í•˜ëŠ” ë§Œí¼ ì¡°ì •)

                    function scrollToReviews(extra = GAP) {
                        const target = document.getElementById('reviews-start');
                        const header = document.querySelector('.site-header');
                        if (!target) return;

                        const headerOffset = (header?.offsetHeight || 0) + 10;
                        const y = target.getBoundingClientRect().top + window.pageYOffset
                            - headerOffset + extra;   // â† ì¶”ê°€ ì—¬ë°±
                        window.scrollTo({ top: y, behavior: 'smooth' });
                    }

                    // "ìƒí’ˆí‰ë³´ê¸°" í´ë¦­ (ì´ë²¤íŠ¸ í•œ ë²ˆë§Œ ë“±ë¡)
                    document.addEventListener('click', (e) => {
                        const a = e.target.closest('#reviewLink');
                        if (!a) return;
                        e.preventDefault();
                        scrollToReviews();
                    });

                    // í•´ì‹œ/ì¿¼ë¦¬ë¡œ ì§„ì… ì‹œ ìë™ ìŠ¤í¬ë¡¤
                    function needScroll() {
                        const h = location.hash;
                        const q = new URLSearchParams(location.search);
                        return h === '#reviews' || h === '#reviews-start' || q.get('scroll') === 'reviews';
                    }

                    function kickoffScroll() {
                        if (!needScroll()) return;
                        // ë ˆì´ì•„ì›ƒ/ì´ë¯¸ì§€ ë¡œë”© ì§€ì—° ëŒ€ë¹„ ì—¬ëŸ¬ ë²ˆ ì‹œë„
                        [0, 120, 350, 800].forEach(ms => setTimeout(scrollToReviews, ms));
                    }

                    document.addEventListener('DOMContentLoaded', kickoffScroll);
                })();
            </script>

            <!-- ì¸ë„¤ì¼ -->
            <div style="display:flex; gap:8px; margin-top:12px;" th:with="imgs=*{subImages}">
                <img th:each="img : ${imgs != null ? imgs : #lists.list()}"
                     th:src="${img} != null ? @{|/${img}|} : @{/images/placeholder.png}"
                     alt="" style="width:80px; height:80px; object-fit:cover; border:1px solid #ddd; cursor:pointer;"
                     onclick="swapMain(this)">
            </div>
        </div>
    </div>

    <!-- ì „í­ ìƒí’ˆì •ë³´/ë¦¬ë·° ì„¹ì…˜ -->
    <div id="reviews" style="width:1265px; margin-top:5px; margin-bottom:5px;">
        <style>
            html { scroll-behavior: smooth; }
            #reviews { scroll-margin-top: 120px; } /* í—¤ë” ë†’ì´ì— ë§ì¶° ìˆ«ì ì¡°ì ˆ */
            #reviews-start{ scroll-margin-top: 120px; }
        </style>
        <div style="display:flex; margin-top:5px; margin-bottom:5px;">
            <div style="letter-spacing:-1px; font-size:16px; font-weight:600;">ìƒí’ˆì •ë³´ ì œê³µê³ ì‹œ</div>
            <div style="letter-spacing:-1px; font-size:14px; color:gray; margin-left:20px; padding-top:4px;">[ì „ììƒê±°ë˜ì— ê´€í•œ ìƒí’ˆì •ë³´ ì œê³µì— ê´€í•œ ê³ ì‹œ] í•­ëª©ì— ì˜ê±° ë“±ë¡ëœ ì •ë³´ì…ë‹ˆë‹¤.</div>
        </div>

        <hr style="border:none; border-top:1px solid #ddd;">
        <table style="border-collapse:collapse; border:1px solid; width:1252px; font-size:14px; margin-left:7px;">
            <tr style="border:1px solid; height:35px;">
                <td style="border-right:1px solid; width:250px; padding-left:11px;">ìƒí’ˆë²ˆí˜¸</td>
                <td style="padding-left:11px;" th:text="*{product_code}">10010118412</td>
            </tr>
            <tr style="border:1px solid; height:35px;"><td style="border-right:1px solid; padding-left:11px;">ìƒí’ˆìƒíƒœ</td><td style="padding-left:11px;">ìƒˆìƒí’ˆ</td></tr>
            <tr style="border:1px solid; height:35px;"><td style="border-right:1px solid; padding-left:11px;">ë¶€ê°€ì„¸ë©´ì„¸ì—¬ë¶€</td><td style="padding-left:11px;">ê³¼ì„¸ìƒí’ˆ</td></tr>
            <tr style="border:1px solid; height:35px;"><td style="border-right:1px solid; padding-left:11px;">ì˜ìˆ˜ì¦ë°œí–‰</td><td style="padding-left:11px;">ë°œí–‰ê°€ëŠ¥ì‹ ìš©ì¹´ë“œì „í‘œ, ì˜¨ë¼ì¸í˜„ê¸ˆì˜ìˆ˜ì¦</td></tr>
            <tr style="border:1px solid; height:35px;"><td style="border-right:1px solid; padding-left:11px;">ì‚¬ì—…ìêµ¬ë¶„</td><td style="padding-left:11px;">í†µì‹ íŒë§¤ì—…ì</td></tr>
            <tr style="border:1px solid; height:35px;"><td style="border-right:1px solid; padding-left:11px;">ë¸Œëœë“œ</td><td style="padding-left:11px;" th:text="*{brand_name}">ë¸Œëœë“œëª…</td></tr>
            <tr style="border:1px solid; height:35px;"><td style="border-right:1px solid; padding-left:11px;">ì›ì‚°ì§€</td><td style="padding-left:11px;">êµ­ë‚´ìƒì‚°</td></tr>
        </table>

        <hr style="border:none; border-top:1px solid #ddd; margin-top:2px; margin-bottom:2px;">
        <table style="border-collapse:collapse; border:1px solid; width:1252px; font-size:14px; margin-left:7px;">
            <tr style="border:1px solid;"><td style="border-right:1px solid; width:250px; height:35px; padding-left:11px;">ì œì¡°ì / ìˆ˜ì…êµ­</td><td style="padding-left:11px;"><span th:text="${seller.name}"></span> / ëŒ€í•œë¯¼êµ­</td></tr>
            <tr style="border:1px solid; height:35px;"><td style="border-right:1px solid; padding-left:11px;">ì œì¡°êµ­</td><td style="padding-left:11px;"><span th:text="${product.origin}"></span></td></tr>
            <tr style="border:1px solid; height:35px;"><td style="border-right:1px solid; padding-left:11px;">ì·¨ê¸‰ ì‹œ ì£¼ì˜ì‚¬í•­</td><td style="padding-left:11px;"><span th:text="${product.prodcondition}"></span></td></tr>
            <tr style="border:1px solid; height:35px;"><td style="border-right:1px solid; padding-left:11px;">ì œì¡°ì—°ì›”</td><td style="padding-left:11px;"><span th:text="${#strings.substring(product.created_at, 0, 7)}"></span></td></tr>
            <tr style="border:1px solid; height:35px;"><td style="border-right:1px solid; padding-left:11px;">í’ˆì§ˆë³´ì¦ê¸°ì¤€</td><td style="padding-left:11px;">ë³¸ ì œí’ˆì˜ í’ˆì§ˆë³´ì¦ê¸°ì¤€ì€ ê³µì •ê±°ë˜ìœ„ì›íšŒ ê³ ì‹œ ì†Œë¹„ìë¶„ìŸí•´ê²°ê¸°ì¤€ì— ë”°ë¦…ë‹ˆë‹¤.</td></tr>
            <tr style="border:1px solid; height:35px;"><td style="border-right:1px solid; padding-left:11px;">A/S ì±…ì„ì</td><td style="padding-left:11px;">NICHIYA</td></tr>
            <tr style="border:1px solid; height:35px;"><td style="border-right:1px solid; padding-left:11px;">ì „í™”ë²ˆí˜¸</td><td style="padding-left:11px;">080-123-4567</td></tr>
        </table>
        <div id="reviews-start"></div>

        <div th:with="rp=${reviewPage}" style="margin-top: 30px;">
            <!-- ë¦¬ë·° ì—†ìŒ -->
            <div th:if="${rp == null or #lists.isEmpty(rp.dtoList)}"
                 class="empty-review empty--highlight">
                <div class="empty-review__icon">ğŸ“</div>
                <div>
                    <div class="empty-review__title">í•´ë‹¹ ìƒí’ˆì— ë“±ë¡ëœ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
                    <div class="empty-review__desc">
                        ì²« ë¦¬ë·°ì˜ ì£¼ì¸ê³µì´ ë˜ì–´ ì£¼ì„¸ìš”! <span>êµ¬ë§¤í•˜ì‹  í›„ í›„ê¸°ë¥¼ ë‚¨ê¸°ì‹œë©´ í˜œíƒì´ ì œê³µë  ìˆ˜ ìˆì–´ìš”.</span>
                    </div>
                </div>
            </div>

            <style>
                .empty-review{
                    position:relative;
                    display:flex; align-items:center; gap:18px;
                    padding:26px 28px;
                    border:1.5px solid #e1e3e6;
                    border-radius:6px;
                    background:#fff;
                    box-shadow:0 2px 6px rgba(0,0,0,.04);
                    margin:10px 0 30px 0;
                }
                .empty--highlight::before{
                    content:""; position:absolute; inset:0 0 0 0;
                    border-left:6px solid #3b5bdb;   /* ğŸ’™ ê°•ì¡° í¬ì¸íŠ¸ (ì§„í•œ ë„¤ì´ë¹„ ë¸”ë£¨) */
                    border-radius:6px 0 0 6px;
                }
                .empty-review__icon{
                    width:46px; height:46px;
                    display:grid; place-items:center;
                    background:#f4f6fb;
                    border-radius:8px;
                    font-size:22px;
                    color:#3b5bdb;
                    flex-shrink:0;
                }
                .empty-review__title{
                    font-weight:800;
                    font-size:18px;
                    color:#222;
                    letter-spacing:-.3px;
                }
                .empty-review__desc{
                    margin-top:6px;
                    font-size:15px;
                    color:#555;
                    line-height:1.5;
                }
                .empty-review__desc span{
                    color:#3b5bdb;
                    font-weight:500;
                }
            </style>

            <!-- ë¦¬ë·°ë“¤ -->
            <div th:each="rv : ${rp != null ? rp.dtoList : T(java.util.Collections).emptyList()}">
                <div th:with="r=${rv?.rating} ?: 0"
                     th:text="${#strings.repeat('â˜…', r)} + ${#strings.repeat('â˜†', 5 - r)}">â˜…â˜…â˜…â˜…â˜†
                </div>

                <div style="margin-top:10px;">
                    <span th:text="*{product_name}">ìƒí’ˆëª…</span>
                    <span style="float:right;"
                          th:text="|${rv?.user_id} ${rv?.created_at}|">someId 2025-10-13</span>
                </div>

                <div style="display:flex; margin-top:5px; gap:15px; align-items:flex-start; padding-top:20px;">
                    <!-- ë¦¬ë·° ì¸ë„¤ì¼: ìƒí’ˆ ë©”ì¸ ì´ë¯¸ì§€(ì œí’ˆ ì´ë¯¸ì§€) ê³ ì • ì‚¬ìš© -->
                    <div class="rv-photo-wrap">
                        <img class="rv-photo"
                             th:with="mi=*{mainImage}"
                             th:src="${mi} != null ? @{|/${mi}|} : @{/images/placeholder.png}"
                             alt="ìƒí’ˆ ë©”ì¸ ì´ë¯¸ì§€">
                    </div>

                    <!-- ë¦¬ë·° ë‚´ìš© -->
                    <div style="color:gray; letter-spacing:0;" th:text="${rv?.content}">ë¦¬ë·° ë‚´ìš©</div>
                </div>
                <hr style="border:none; border-top:1px solid #ddd; margin-top:13px;">
            </div>

            <style>
                /* ë¦¬ë·° ì¸ë„¤ì¼ ê³µí†µ í”„ë ˆì„ */
                .rv-photo-wrap{
                    width:110px;          /* ì¸ë„¤ì¼ ë„ˆë¹„ (ì›í•˜ë©´ ì¡°ì •) */
                    aspect-ratio: 2 / 3;  /* ê³ ì • ë¹„ìœ¨: 2:3  (1/1, 3/4 ë“±ìœ¼ë¡œ ë³€ê²½ ê°€ëŠ¥) */
                    position:relative;
                    overflow:hidden;      /* ë„˜ì¹˜ëŠ” ë¶€ë¶„ì€ ìë¦„ */
                    border:1px solid #ddd;
                    border-radius:8px;
                    background:#f5f5f5;
                    flex:0 0 auto;
                }

                /* ì´ë¯¸ì§€ê°€ í”„ë ˆì„ì„ 100% ë®ë„ë¡ */
                .rv-photo{
                    position:absolute;
                    inset:0;              /* top/right/bottom/left: 0 */
                    width:100%;
                    height:100%;
                    object-fit:cover;     /* ë¹„ìœ¨ ìœ ì§€ + í”„ë ˆì„ ê½‰ ì±„ì›€ (ì˜ë¦¼ í—ˆìš©) */
                    object-position:center;
                    display:block;
                }

                /* ëª¨ë°”ì¼ í¬ê¸° ì¡°ì ˆ ì˜ˆì‹œ */
                @media (max-width: 768px){
                    .rv-photo-wrap{ width:90px; }
                }
            </style>
            <!-- í˜ì´ì§€ë„¤ì´ì…˜: uid ìœ ì§€ -->
            <div style="height:100px; margin-top:40px; display:flex; justify-content:center;">
                <input class="prev-page"
                       th:if="${rp != null and rp.prev}"
                       th:onclick="|location.href='@{/product/views(id=*{id}, rpg=${rp.start - 1}, rsize=${rp.size})}'|"
                       type="button" value="&lt; ì´ì „">

                <th:block th:if="${rp != null}" th:each="num : ${#numbers.sequence(rp.start, rp.end)}">
                    <input th:class="${num == rp.pg ? 'current' : 'num'}"
                           th:onclick="|location.href='@{/product/views(id=*{id}, rpg=${num}, rsize=${rp.size})}'|"
                           th:value="${num}" type="button"/>
                </th:block>

                <input class="next-page"
                       th:if="${rp != null and rp.next}"
                       th:onclick="|location.href='@{/product/views(id=*{id}, rpg=${rp.end + 1}, rsize=${rp.size})}'|"
                       type="button" value="ë‹¤ìŒ &gt;">
            </div>
        </div>

        <style>
            .current { border: 1px solid #333; background-color: #333; color: white; height: 30px; width: 30px; margin-right: 7px; line-height: 1; }
            .num { cursor: pointer; border: 1px solid #ddd; color: #555; height: 30px; width: 30px; margin-right: 7px; line-height: 1; }
            .euro-nav__list { max-height: 0; overflow: hidden; transition: max-height 0.15s ease; }
            .euro-nav__group.open .euro-nav__list { max-height: 500px; }

            /* ìƒí’ˆì •ë³´ ì˜ì—­ ëŒ€í‘œ ì´ë¯¸ì§€ ë°•ìŠ¤ */
            .product-info-image{
                width:100%;
                aspect-ratio: 3 / 2;     /* í•„ìš”í•˜ë©´ 16/9, 4/5 ë“±ìœ¼ë¡œ ë°”ê¾¸ì„¸ìš” */
                overflow:hidden;
                background:#f0f0f0;      /* ë¡œë”©/ì—¬ë°± ìƒ‰ */
                display:flex;
                align-items:center;
                justify-content:center;
            }
            .product-info-image img{
                width:100%;
                height:100%;
                object-fit:cover;        /* ë¹„ìœ¨ ìœ ì§€í•˜ë©° ê½‰ ì±„ìš°ê¸°(ì˜ë¦¼ í—ˆìš©) */
                object-position:center;
                display:block;
            }

            /* ëª¨ë°”ì¼ì—ì„œ ì„¸ë¡œí˜• ë¹„ìœ¨ì´ ë” ë³´ê¸° ì¢‹ê²Œ í•˜ê³  ì‹¶ë‹¤ë©´ */
            @media (max-width: 768px){
                .product-info-image{ aspect-ratio: 4 / 5; }
            }
        </style>
    </div>
</div>

<div th:replace="~{main/footer.html}"></div>
</body>
</html>
