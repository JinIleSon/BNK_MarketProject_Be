<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>register</title>
    <style>
        body {
            font-family: "Noto Sans KR", sans-serif;
            background: #fff;
            color: #333;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 760px;
            margin: 50px auto;
            padding: 0 16px;
        }

        h2 {
            text-align: center;
            font-size: 28px;
            margin-bottom: 30px;
        }

        form label {
            display: block;
            margin: 15px 0 8px;
            font-weight: bold;
        }

        form input[type="text"],
        form input[type="password"],
        form input[type="email"],
        form input[type="date"],
        form input[type="tel"],
        form select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            font-size: 14px;
        }

        .radio-group {
            margin: 10px 0;
        }

        .radio-group label {
            margin-right: 20px;
            font-weight: normal;
        }

        .address-box {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }

        .address-box input {
            flex: 1;
        }

        .address-box button {
            padding: 12px 20px;
            background: #333;
            color: #fff;
            border: none;
            cursor: pointer;
        }

        .btn-area {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .btn-area button {
            width: 49%;
            padding: 8px;
            font-size: 16px;
            cursor: pointer;
        }

        .btn-cancel {
            background: #fff;
            border: 1px solid #333;
        }

        .btn-submit {
            background: #333;
            color: #fff;
            border: none;
        }

        .btn-submit:disabled {
            background: #bbb;
            cursor: not-allowed;
            color: #fff;
            opacity: .9;
        }

        .btn-verify {
            background: #333;
            color: #fff;
            outline: none;
            border: none;
            box-shadow: none;
            padding: 10px 12px;
            cursor: pointer;
            height: 44px;
        }

        .success {
            color: green;
            font-size: 13px;
            margin-top: 4px;
        }

        .error {
            color: red;
            font-size: 13px;
            margin-top: 4px;
        }

        /* =========================
       íšŒì›ì¸ì¦ ì „ìš©(ë„¤ì„ìŠ¤í˜ì´ìŠ¤)
       ========================= */
        .auth-group {
            margin: 6px 0 16px;
        }

        .auth-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .auth-row .auth-field {
            flex: 1 1 auto;
            min-width: 0;
        }

        /* ì…ë ¥ì¹¸ ìœ ì—° í­ */
        .auth-row .auth-btn {
            flex: 0 0 120px;
            width: 120px;
        }

        /* ë²„íŠ¼ ê³ ì • í­ */

        .auth-tip {
            font-size: 13px;
            color: #666;
            margin: 6px 0 0;
        }

        /* ì¸ì¦ë²ˆí˜¸ ì…ë ¥ ì¤„ (ì…ë ¥ì¹¸ ê°€ë³€ + ë²„íŠ¼ ê³ ì •) */
        .auth-verify-line {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 8px;
        }

        .auth-verify-line input {
            flex: 1 1 auto;
        }

        .auth-verify-line .auth-btn {
            flex: 0 0 120px;
            width: 120px;
            height: 44px;
        }

        .hidden {
            display: none;
        }
    </style>
</head>

<body>
<div th:replace="~{main/header.html}"></div>

    <div class="container">
        <h2>íšŒì›ê°€ì…</h2>

        <form id="signupForm" novalidate>
            <!-- íšŒì›êµ¬ë¶„ -->
            <label>íšŒì›êµ¬ë¶„ *</label>
            <div class="radio-group">
                <label><input type="radio" name="memberType" value="user" checked> ì¼ë°˜íšŒì›</label>
            </div>

            <!-- íšŒì›ì¸ì¦ (ì´ë©”ì¼ + íœ´ëŒ€í° ë‘˜ ë‹¤ í•„ìš”) -->
            <label>íšŒì›ì¸ì¦ *</label>

            <!-- ì´ë©”ì¼ ì¸ì¦ -->
            <div class="auth-group" id="emailAuth">
                <div class="auth-row">
                    <input type="email" id="email" class="auth-field" placeholder="ì´ë©”ì¼ ì…ë ¥ (example@domain.com)"
                        autocomplete="email">
                    <button type="button" id="btnSendEmail" class="btn-verify auth-btn">ì´ë©”ì¼ ì¸ì¦</button>
                </div>
                <div id="emailVerifyWrap" class="auth-verify-line hidden">
                    <input type="text" id="emailCode" inputmode="numeric" pattern="[0-9]*"
                        placeholder="ì´ë©”ì¼ë¡œ ë°›ì€ ì¸ì¦ë²ˆí˜¸ ì…ë ¥">
                    <button type="button" id="btnCheckEmail" class="btn-verify auth-btn">í™•ì¸</button>
                </div>
                <p id="emailStatus" class="error">ì´ë©”ì¼ ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
            </div>

            <!-- íœ´ëŒ€í° ì¸ì¦ -->
            <div class="auth-group" id="phoneAuth">
                <div class="auth-row">
                    <input type="tel" id="phone" class="auth-field" placeholder="íœ´ëŒ€í° ë²ˆí˜¸ ì…ë ¥ (í•˜ì´í”ˆ ì—†ì´)" inputmode="tel"
                        maxlength="11" autocomplete="tel">
                    <button type="button" id="btnSendSms" class="btn-verify auth-btn">íœ´ëŒ€í° ì¸ì¦</button>
                </div>
                <div id="smsVerifyWrap" class="auth-verify-line hidden">
                    <input type="text" id="smsCode" inputmode="numeric" pattern="[0-9]*" placeholder="ë¬¸ìë¡œ ë°›ì€ ì¸ì¦ë²ˆí˜¸ ì…ë ¥">
                    <button type="button" id="btnCheckSms" class="btn-verify auth-btn">í™•ì¸</button>
                </div>
                <p id="phoneStatus" class="error">íœ´ëŒ€í° ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
            </div>

            <!-- ì•„ì´ë”” -->
            <label for="userid">ì•„ì´ë”” *</label>
            <input type="text" id="userid" name="userid" placeholder="ì˜ë¬¸/ìˆ«ì 4~16ì" required>
            <div style="margin-top:8px;">
                <button type="button" id="btnCheckId" class="btn-verify">ì¤‘ë³µí™•ì¸</button>
            </div>
            <p id="idResult" class=""></p>

            <!-- ë¹„ë°€ë²ˆí˜¸ -->
            <label for="password">ë¹„ë°€ë²ˆí˜¸ *</label>
            <input type="password" id="password" name="password" placeholder="ì˜ë¬¸/ìˆ«ì/íŠ¹ìˆ˜ë¬¸ì 2ê°€ì§€ ì´ìƒ, 10~16ì" required>

            <label for="confirmPassword">ë¹„ë°€ë²ˆí˜¸ í™•ì¸ *</label>
            <input type="password" id="confirmPassword" name="confirmPassword" required>
            <p id="pwResult" class=""></p>

            <!-- ì´ë¦„ -->
            <label for="name">ì´ë¦„ *</label>
            <input type="text" id="name" name="name" placeholder="ì´ë¦„ ì…ë ¥" required>
            <p id="nameResult" class=""></p>

            <!-- ì„±ë³„ -->
            <label>ì„±ë³„</label>
            <div class="radio-group">
                <label><input type="radio" name="gender" value="M"> ë‚¨ì</label>
                <label><input type="radio" name="gender" value="F"> ì—¬ì</label>
            </div>

            <!-- ìƒë…„ì›”ì¼ -->
            <label for="birth">ìƒë…„ì›”ì¼ *</label>
            <input type="date" id="birth" name="birth" required>
            <p id="birthResult" class=""></p>

            <!-- ì£¼ì†Œ -->
            <label>ì£¼ì†Œ</label>
            <div class="address-box">
                <input type="text" id="postcode" placeholder="ìš°í¸ë²ˆí˜¸" readonly required>
                <button type="button" id="btnFindAddr" onclick="execDaumPostcode()">ì£¼ì†Œì°¾ê¸°</button>
            </div>
            <input type="text" id="address" placeholder="ê¸°ë³¸ì£¼ì†Œ" readonly required>
            <input type="text" id="detailAddress" placeholder="ìƒì„¸ì£¼ì†Œ">

            <!-- ë²„íŠ¼ -->
            <div class="btn-area">
                <button type="button" class="btn-cancel" th:onclick="|location.href='@{/main/main/page}'|">ì·¨ì†Œ</button>
                <button type="submit" id="btnSubmit" class="btn-submit" disabled>ê°€ì…í•˜ê¸°</button>
            </div>
        </form>
    </div>

    <div th:replace="~{main/footer.html}"></div>

    <!-- Daum ì£¼ì†Œ API -->
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

    <script th:inline="javascript">
        // ì»¨í…ìŠ¤íŠ¸ íŒ¨ìŠ¤ ì–»ê¸°
        const ctx = /*[[@{/}]]*/ '';
        // ---------- ìƒíƒœ ----------
        let emailVerified = false;
        let phoneVerified = false;
        let emailCode = null;
        let smsCode = null;

        // ---------- DOM ----------
        const form = document.getElementById("signupForm");
        const btnSubmit = document.getElementById("btnSubmit");

        const elUserId = document.getElementById("userid");
        const elPw = document.getElementById("password");
        const elPw2 = document.getElementById("confirmPassword");
        const elName = document.getElementById("name");
        const elBirth = document.getElementById("birth");

        const idResult = document.getElementById("idResult");
        const pwResult = document.getElementById("pwResult");
        const nameResult = document.getElementById("nameResult");
        const birthResult = document.getElementById("birthResult");

        const emailInput = document.getElementById("email");
        const phoneInput = document.getElementById("phone");
        const emailStatus = document.getElementById("emailStatus");
        const phoneStatus = document.getElementById("phoneStatus");
        const emailVerifyWrap = document.getElementById("emailVerifyWrap");
        const smsVerifyWrap = document.getElementById("smsVerifyWrap");

        // ---------- ìœ í‹¸: ìœ íš¨ì„± ----------
        function validateUserId() {
            const v = elUserId.value.trim();
            const ok = /^[A-Za-z0-9]{4,16}$/.test(v);
            if (!v) { idResult.textContent = "ì•„ì´ë””ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤."; idResult.className = "error"; }
            else if (!ok) { idResult.textContent = "ì•„ì´ë””ëŠ” ì˜ë¬¸/ìˆ«ì 4~16ìì—¬ì•¼ í•©ë‹ˆë‹¤."; idResult.className = "error"; }
            else { idResult.textContent = "ì‚¬ìš© ê°€ëŠ¥í•œ í˜•ì‹ì…ë‹ˆë‹¤."; idResult.className = "success"; }
            return ok;
        }

        function validatePassword() {
            const p1 = elPw.value;
            const p2 = elPw2.value;
            const lenOK = /^.{10,16}$/.test(p1);
            const types = [/[A-Za-z]/.test(p1), /[0-9]/.test(p1), /[^A-Za-z0-9]/.test(p1)];
            const typeOK = (types.filter(Boolean).length >= 2);
            let ok = lenOK && typeOK;

            if (!p1) { pwResult.textContent = "ë¹„ë°€ë²ˆí˜¸ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤."; pwResult.className = "error"; return false; }
            if (!ok) { pwResult.textContent = "ì˜ë¬¸/ìˆ«ì/íŠ¹ìˆ˜ë¬¸ì ì¤‘ 2ê°€ì§€ ì´ìƒ í¬í•¨, 10~16ì"; pwResult.className = "error"; }
            else if (p2 && p1 !== p2) { pwResult.textContent = "ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."; pwResult.className = "error"; ok = false; }
            else if (p2 && p1 === p2) { pwResult.textContent = "ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•©ë‹ˆë‹¤ âœ…"; pwResult.className = "success"; }
            else { pwResult.textContent = ""; pwResult.className = ""; }
            return ok;
        }

        function validateName() {
            const v = elName.value.trim();
            const ok = v.length > 0;
            if (!ok) { nameResult.textContent = "ì´ë¦„ì€ í•„ìˆ˜ì…ë‹ˆë‹¤."; nameResult.className = "error"; }
            else { nameResult.textContent = ""; nameResult.className = ""; }
            return ok;
        }

        function validateBirth() {
            const v = elBirth.value;
            let ok = !!v;
            if (!ok) { birthResult.textContent = "ìƒë…„ì›”ì¼ì€ í•„ìˆ˜ì…ë‹ˆë‹¤."; birthResult.className = "error"; return false; }
            const today = new Date();
            const b = new Date(v + "T00:00:00");
            if (b > today) { birthResult.textContent = "ìƒë…„ì›”ì¼ì€ ì˜¤ëŠ˜ ì´í›„ì¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."; birthResult.className = "error"; ok = false; }
            else { birthResult.textContent = ""; birthResult.className = ""; }
            return ok;
        }

        function validateEmailField() { return /.+@.+\..+/.test(emailInput.value.trim()); }
        function validatePhoneField() { return /^01[0-9]{8,9}$/.test(phoneInput.value.trim()); }

        function updateSubmitState() {
            const allValid =
                emailVerified &&
                // phoneVerified &&
                validateUserId() &&
                validatePassword() &&
                validateName() &&
                validateBirth();
            btnSubmit.disabled = !allValid;
        }

        // ---------- ì¸ì¦(ìˆ˜ì •) ----------
        const pseudoSend = () => new Promise(res => setTimeout(res, 500));

        document.getElementById("btnSendEmail").addEventListener("click", async () => {
            const email = emailInput.value.trim();

            console.log("email: " + email);

            if (!validateEmailField()) {
                emailStatus.textContent = "ì´ë©”ì¼ í˜•ì‹ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.";
                emailStatus.className = "error";
                return;
            }

            try {
                const res = await fetch(`${ctx}email/send`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ email })
                });

                    console.log("email: " + email);

                if (res.ok) {
                    emailVerifyWrap.classList.remove("hidden");
                    emailStatus.textContent = "ì¸ì¦ë²ˆí˜¸ë¥¼ ì´ë©”ì¼ë¡œ ì „ì†¡í–ˆìŠµë‹ˆë‹¤.";
                    emailStatus.className = "success";
                } else {
                    emailStatus.textContent = "ì´ë©”ì¼ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
                    emailStatus.className = "error";
                }
            } catch (err) {
                console.error(err);
                emailStatus.textContent = "ì„œë²„ ì˜¤ë¥˜ë¡œ ì „ì†¡ ì‹¤íŒ¨.";
                emailStatus.className = "error";
            }
        });


        document.getElementById("btnCheckEmail").addEventListener("click", async () => {
            const input = document.getElementById("emailCode").value.trim();
            if (!input) {
                emailStatus.textContent = "ì¸ì¦ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.";
                emailStatus.className = "error";
                return;
            }

            try {
                const res = await fetch(`${ctx}email/code`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ code: input })
                    // ë§Œì•½ ë°±ì—”ë“œê°€ ë‹¤ë¥¸ í¬íŠ¸/ë„ë©”ì¸ì´ë¼ë©´ ì•„ë˜ì²˜ëŸ¼ ì ˆëŒ€ê²½ë¡œ + credentials í•„ìš”í•  ìˆ˜ ìˆìŒ:
                    // credentials: 'include'
                });

                const body = await res.json();

                if (res.ok && body.isMatched) {
                    emailVerified = true;
                    emailStatus.textContent = "ì´ë©”ì¼ ì¸ì¦ ì™„ë£Œ";
                    emailStatus.className = "success";
                } else {
                    emailVerified = false;
                    emailStatus.textContent = "ì¸ì¦ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
                    emailStatus.className = "error";
                }
            } catch (err) {
                console.error(err);
                emailVerified = false;
                emailStatus.textContent = "ì„œë²„ ì˜¤ë¥˜ë¡œ ê²€ì¦ ì‹¤íŒ¨.";
                emailStatus.className = "error";
            }

            updateSubmitState();
        });

        // sms ì¸ì¦ ë¶€ë¶„, sms ì•ˆë ì‹œ MOCKìœ¼ë¡œ ë˜ë„ë¡
        // ===========================
        // ğŸ“± SMS ì¸ì¦ (Solapi + ë¬¸ìì—´ ëª¨ë‘ ëŒ€ì‘)
        // ===========================
        document.getElementById("btnSendSms").addEventListener("click", async () => {
            const phone = phoneInput.value.trim();

            if (!validatePhoneField()) {
                phoneStatus.textContent = "íœ´ëŒ€í° ë²ˆí˜¸ë¥¼ ì •í™•íˆ ì…ë ¥í•´ ì£¼ì„¸ìš”.";
                phoneStatus.className = "error";
                return;
            }

            try {
                const res = await fetch(`${location.origin}/NICHIYA/api/sms/send`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ phoneNumber: phone })
                });

                const raw = await res.text(); // âœ… í•œ ë²ˆë§Œ ì½ê¸°
                let data;

                try {
                    data = JSON.parse(raw); // âœ… JSONì´ë©´ íŒŒì‹±ë¨
                } catch {
                    data = raw; // âœ… ë¬¸ìì—´ ê·¸ëŒ€ë¡œ ìœ ì§€
                }

                console.log("ğŸ“± ì„œë²„ ì‘ë‹µ:", data);

                if (
                    res.ok &&
                    (data.success === true || (typeof data === "string" && data.includes("ì¸ì¦ë²ˆí˜¸ ì „ì†¡ ì™„ë£Œ")))
                ) {
                    const codeMatch = typeof data === "string" ? data.match(/\d{4,6}/) : null;
                    smsCode = codeMatch ? codeMatch[0] : null;

                    smsVerifyWrap.classList.remove("hidden");
                    phoneStatus.textContent = "ì¸ì¦ë²ˆí˜¸ë¥¼ ì „ì†¡í–ˆìŠµë‹ˆë‹¤. ë¬¸ìë©”ì‹œì§€ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.";
                    phoneStatus.className = "success";

                    if (smsCode) console.log("ğŸ“± ë°œì†¡ëœ ì¸ì¦ë²ˆí˜¸:", smsCode);
                } else {
                    phoneStatus.textContent = "ë¬¸ì ì „ì†¡ ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
                    phoneStatus.className = "error";
                }
            } catch (err) {
                console.error("ğŸš¨ SMS ì „ì†¡ ì˜¤ë¥˜:", err);
                phoneStatus.textContent = "ì„œë²„ ì˜¤ë¥˜ë¡œ ì „ì†¡ ì‹¤íŒ¨.";
                phoneStatus.className = "error";
            }
        });


        // ===========================
        // ğŸ” ì¸ì¦ë²ˆí˜¸ í™•ì¸
        // ===========================
        document.getElementById("btnCheckSms").addEventListener("click", async () => {
            const input = document.getElementById("smsCode").value.trim();

            if (!input) {
                phoneStatus.textContent = "ì¸ì¦ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.";
                phoneStatus.className = "error";
                return;
            }

            try {
                const res = await fetch(`${location.origin}/NICHIYA/api/sms/verify`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        phoneNumber: phoneInput.value.trim(), // âœ… ì„ì‹œ ì €ì¥ì„ ìœ„í•œ
                        code: input
                    })
                });

                const raw = await res.text(); // âœ… í•œ ë²ˆë§Œ ì½ê¸°
                let data;

                try {
                    data = JSON.parse(raw); // âœ… JSONì´ë©´ íŒŒì‹±
                } catch {
                    data = raw; // âœ… ë¬¸ìì—´ ê·¸ëŒ€ë¡œ
                }

                console.log("âœ… ì¸ì¦ ì‘ë‹µ:", data);

                if (
                    res.ok &&
                    ((data.matched === true) || (typeof data === "string" && data.includes("ì¸ì¦ ì„±ê³µ")))
                ) {
                    phoneVerified = true;
                    phoneStatus.textContent = "íœ´ëŒ€í° ì¸ì¦ ì™„ë£Œ âœ…";
                    phoneStatus.className = "success";
                } else {
                    phoneVerified = false;
                    phoneStatus.textContent = "ì¸ì¦ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
                    phoneStatus.className = "error";
                }
            } catch (err) {
                console.error("ğŸš¨ ì¸ì¦ í™•ì¸ ì˜¤ë¥˜:", err);
                phoneVerified = false;
                phoneStatus.textContent = "ì„œë²„ ì˜¤ë¥˜ë¡œ ê²€ì¦ ì‹¤íŒ¨.";
                phoneStatus.className = "error";
            }

            updateSubmitState();
        });



        // ---------- ê¸°íƒ€ ì´ë²¤íŠ¸ ----------

        document.getElementById("btnCheckId").addEventListener("click", async () => {
            const id = elUserId.value.trim();
            if (!validateUserId()) {
                idResult.textContent = "ì•„ì´ë”” í˜•ì‹ì„ í™•ì¸í•˜ì„¸ìš”.";
                idResult.className = "error";
                return;
            }

            try {
                const res = await fetch(`${ctx}user/check-id?user_id=${encodeURIComponent(id)}`);
                const body = await res.json();
                if (res.ok && body.available) {
                    idResult.textContent = "ì‚¬ìš© ê°€ëŠ¥í•œ ì•„ì´ë””ì…ë‹ˆë‹¤.";
                    idResult.className = "success";
                } else {
                    idResult.textContent = "ì´ë¯¸ ì‚¬ìš©ì¤‘ì¸ ì•„ì´ë””ì…ë‹ˆë‹¤.";
                    idResult.className = "error";
                }
            } catch (e) {
                console.error(e);
                idResult.textContent = "ì„œë²„ ì˜¤ë¥˜";
                idResult.className = "error";
            }
            updateSubmitState();
        });

        elUserId.addEventListener("input", updateSubmitState);
        elPw.addEventListener("input", updateSubmitState);
        elPw2.addEventListener("input", updateSubmitState);
        elName.addEventListener("input", updateSubmitState);
        elBirth.addEventListener("change", updateSubmitState);
        emailInput.addEventListener("input", () => { emailVerified = false; emailStatus.textContent = "ì´ë©”ì¼ ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤."; emailStatus.className = "error"; updateSubmitState(); });
        phoneInput.addEventListener("input", () => { phoneVerified = false; phoneStatus.textContent = "íœ´ëŒ€í° ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤."; phoneStatus.className = "error"; updateSubmitState(); });

        // ---------- Daum ì£¼ì†Œ ----------
        function execDaumPostcode() {
            new daum.Postcode({
                oncomplete: function (data) {
                    document.getElementById("postcode").value = data.zonecode;
                    document.getElementById("address").value = data.address;
                }
            }).open();
        }
        window.execDaumPostcode = execDaumPostcode;

        // ---------- ì œì¶œ ----------
        form.addEventListener("submit",async function (e) {
            e.preventDefault();

            const okNow =
                emailVerified &&
                //phoneVerified &&
                validateUserId() &&
                validatePassword() &&
                validateName() &&
                validateBirth();

            if (!okNow) {

                alert("í•„ìˆ˜ ì¸ì¦/ì…ë ¥ í•­ëª©ì„ ì™„ë£Œí•´ ì£¼ì„¸ìš”.");
                updateSubmitState();
                return;
            }

            const payload = {
                userId: elUserId.value.trim(),
                password: elPw.value,
                name: elName.value.trim(),
                gender: document.querySelector('input[name="gender"]:checked')?.value || null,
                birth: elBirth.value,
                email: emailInput.value.trim(),
                phone: phoneInput.value.trim(),
                postcode: document.getElementById("postcode").value,
                address: document.getElementById("address").value,
                detailAddress: document.getElementById("detailAddress").value,

                // ğŸ”½ ì¶”ê°€: íšŒì› êµ¬ë¶„ ê°’ ì „ì†¡
                role: document.querySelector('input[name="memberType"]:checked')?.value || "user"
            };

            try {
                const res = await fetch(`${ctx}user/register`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });
                const body = await res.json();
                if (res.ok && body.ok) {
                    alert("íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    //location.href = "/welcome";

                // âœ… ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™ ì—¬ë¶€ í™•ì¸
                if (confirm("ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                    // âœ… í™•ì¸ í´ë¦­ ì‹œ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
                    location.href = `${ctx}member/login`;
                } else {
                    // âŒ ì·¨ì†Œ í´ë¦­ ì‹œ í™˜ì˜ í˜ì´ì§€ë¡œ ì´ë™ (ë˜ëŠ” ë©”ì¸ ë“±)
                    location.href = `${ctx}member/join`;
                }
                } else {
                    alert("íšŒì›ê°€ì… ì‹¤íŒ¨: " + (body.error || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
                }
            } catch (err) {
                console.error(err);
                alert("ì„œë²„ ì˜¤ë¥˜ë¡œ ê°€ì… ì‹¤íŒ¨");
            }
        });
        function onCheckIdClick() {
            const id = elUserId.value.trim();
            if (!validateUserId()) { idResult.textContent = "ì•„ì´ë”” í˜•ì‹ì„ í™•ì¸í•˜ì„¸ìš”."; idResult.className = "error"; return; }

            (async () => {
                try {
                    const res = await fetch(`${ctx}user/check-id?user_id=${encodeURIComponent(id)}`);
                    const ct = res.headers.get('content-type') || '';
                    const text = await res.text();

                    if (!ct.includes('application/json')) {
                        console.error('Non-JSON', res.status, text.slice(0,200));
                        throw new Error(`Non-JSON response ${res.status}`);
                    }
                    const body = JSON.parse(text);

                    if (res.ok && body.available) {
                        idResult.textContent = "ì‚¬ìš© ê°€ëŠ¥í•œ ì•„ì´ë””ì…ë‹ˆë‹¤.";
                        idResult.className = "success";
                    } else {
                        idResult.textContent = "ì´ë¯¸ ì‚¬ìš©ì¤‘ì¸ ì•„ì´ë””ì…ë‹ˆë‹¤.";
                        idResult.className = "error";
                    }
                } catch (e) {
                    console.error(e);
                    idResult.textContent = "ì„œë²„ ì˜¤ë¥˜";
                    idResult.className = "error";
                }
            })();
        }

        // ì¤‘ë³µ ë°”ì¸ë”© ë°©ì§€
        if (!window.__boundCheckId) {
            document.getElementById("btnCheckId").addEventListener("click", onCheckIdClick);
            window.__boundCheckId = true;
        }
    </script>
</body>

</html>