<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>아이디 찾기</title>
    <style>
        :root {
            --black: #111;
            --gray: #777;
            --light: #f4f5f7;
            --primary: #111;
            --accent: #3F97F6
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            margin: 0
        }

        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Pretendard, Apple SD Gothic Neo, Malgun Gothic, Noto Sans KR, sans-serif;
            color: var(--black);
            background: #fff
        }

        .wrap {
            max-width: 760px;
            margin: 48px auto;
            padding: 0 20px
        }

        h1 {
            font-size: 40px;
            letter-spacing: -.02em;
            margin: 0 0 24px;
            text-align: center
        }

        .desc {
            color: #555;
            text-align: center;
            line-height: 1.6;
            margin-bottom: 28px
        }

        .card {
            background: #fff;
            border: 1px solid #e6e6e6;
            padding: 28px 24px
        }

        .row {
            margin-bottom: 18px
        }

        label {
            display: block;
            font-weight: 600;
            margin: 0 0 8px
        }

        .field {
            width: 100%;
            height: 48px;
            padding: 0 14px;
            border: 1px solid #ddd;
            outline: none
        }

        .field:focus {
            border-color: #222;
            box-shadow: 0 0 0 3px rgba(0, 0, 0, .06)
        }

        .helper {
            font-size: 13px;
            color: #888;
            margin-top: 6px
        }

        .actions {
            display: flex;
            gap: 10px;
            margin-top: 24px
        }

        .btn {
            flex: 1 1 0;
            height: 50px;
            border: 1px solid #111;
            background: #111;
            color: #fff;
            font-weight: 700;
            cursor: pointer
        }

        .btn.secondary {
            background: #fff;
            color: #111
        }

        .btn:disabled {
            opacity: .5;
            cursor: not-allowed
        }

        .inline {
            display: flex;
            gap: 10px;
            align-items: center
        }

        .sub-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px
        }

        .hidden {
            display: none
        }

        .select {
            width: 100%;
            height: 48px;
            border: 1px solid #ddd;
            padding: 0 12px
        }

        .bar {
            height: 1px;
            background: #eee;
            margin: 20px 0
        }

        .radio-line {
            display: flex;
            gap: 18px;
            align-items: center
        }

        /* ★ 추가 */
        .radio-line .item {
            display: flex;
            gap: 8px;
            align-items: center
        }

        /* ★ 추가 */

        .row-email {
            margin: 10px 0 18px 0
        }

        .row-phone {
            margin: 10px 0 18px 0
        }

        /* ★ 추가 */

        /* 접근성용 시각적 숨김 */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 1, 1);
            white-space: nowrap;
            border: 0;
        }

        /* 인증번호 입력: 입력칸 가변, 버튼 고정 */
        #emailVerifyGroup .inline,
        #phoneVerifyGroup .inline {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: nowrap;
            /* ★ 수정 */
        }

        #emailVerifyGroup .inline .field,
        #phoneVerifyGroup .inline .field {
            flex: 1 1 auto;
            width: auto;
            /* ★ 수정 */
        }

        #emailVerifyGroup .inline .btn,
        #phoneVerifyGroup .inline .btn {
            flex: 0 0 120px;
            width: 120px;
            height: 48px;
            border-radius: 0;
            white-space: nowrap;
            /* ★ 수정 */
        }
    </style>
</head>


<body>
<div th:replace="~{main/header.html}"></div>
    <div class="wrap">
        <h1>아이디 찾기</h1>
        <p class="desc">이메일 또는 휴대폰 인증으로 아이디를 찾을 수 있습니다.</p>

        <div class="card">
            <!-- 회원유형 -->
            <div class="row">
                <label for="memberType">회원유형</label>
                <select id="memberType" class="select" aria-label="회원유형">
                    <option value="personal">일반회원</option>
                    <option value="business">판매자회원</option>
                </select>
            </div>

            <!-- 인증 방식 (이메일/휴대폰) ★ 추가 -->
            <div class="row">
                <label>인증 방식</label>
                <div class="radio-line" role="radiogroup" aria-label="인증 방식">
                    <label class="item"><input type="radio" name="method" value="email" checked> 이메일</label>
                    <label class="item"><input type="radio" name="method" value="phone"> 휴대폰 인증</label>
                </div>
            </div>

            <!-- 이름 입력 -->
            <div class="row">
                <label for="name">이름</label>
                <input id="name" class="field" type="text" placeholder="이름을 입력하세요" autocomplete="name" required>
            </div>

            <div class="bar" aria-hidden="true"></div>

            <!-- 이메일 인증 -->
            <section id="emailSection" aria-label="이메일 인증">
                <div class="row">
                    <label for="email">이메일로 찾기</label>
                    <input id="email" class="field" type="email" placeholder="example@domain.com" autocomplete="email">
                    <p class="helper">이름과 이메일이 모두 입력되어야 인증번호를 전송합니다.</p>
                </div>
                <div class="sub-actions">
                    <button id="sendEmailCode" class="btn" type="button" disabled>인증번호 전송</button>
                </div>
                <div id="emailVerifyGroup" class="row-email hidden">
                    <label class="sr-only" for="emailCode">인증번호</label>
                    <div class="inline">
                        <input id="emailCode" class="field" type="text" inputmode="numeric" pattern="[0-9]*"
                            placeholder="전송받은 인증번호 입력">
                        <button id="verifyEmailCode" class="btn" type="button">확인</button>
                    </div>
                </div>
            </section>

            <!-- 휴대폰 인증 ★ 추가 -->
            <section id="phoneSection" class="hidden" aria-label="휴대폰 인증">
                <div class="row">
                    <label for="phone">휴대폰 번호로 찾기</label>
                    <input id="phone" class="field" type="tel" inputmode="tel" placeholder="01012345678" maxlength="11">
                    <p class="helper">이름과 휴대폰 번호가 모두 입력되어야 인증번호를 전송합니다. 하이픈(-) 없이 숫자만 입력하세요.</p>
                </div>
                <div class="sub-actions">
                    <button id="sendSmsCode" class="btn" type="button" disabled>인증번호 전송</button>
                </div>
                <div id="phoneVerifyGroup" class="row-phone hidden">
                    <label class="sr-only" for="smsCode">인증번호</label>
                    <div class="inline">
                        <input id="smsCode" class="field" type="text" inputmode="numeric" pattern="[0-9]*"
                            placeholder="전송받은 인증번호 입력">
                        <button id="verifySmsCode" class="btn" type="button">확인</button>
                    </div>
                </div>
            </section>

            <div class="actions">
                <button id="cancelBtn" class="btn secondary" type="button" onclick="location.href='/NICHIYA/member/findresultId'">취소</button>
                <button id="nextBtn" class="btn" type="button" disabled>다음</button>
            </div>
        </div>
    </div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const $  = s => document.querySelector(s);
        const $$ = s => Array.from(document.querySelectorAll(s));

        // CSRF 헤더 (스프링 시큐리티 사용시)
        function csrfHeaders() {
            const token  = document.querySelector('meta[name="_csrf"]')?.content;
            const header = document.querySelector('meta[name="_csrf_header"]')?.content || 'X-CSRF-TOKEN';
            return token ? { [header]: token } : {};
        }

        const state = { method: 'email', emailVerified: false, phoneVerified: false };

        const emailSection = $('#emailSection');
        const phoneSection = $('#phoneSection');
        const nextBtn      = $('#nextBtn');

        const isValidEmail = v => /.+@.+\..+/.test((v||'').trim());
        const isValidPhone = v => /^01[0-9]{8,9}$/.test((v||'').trim());
        const nameOK       = () => ($('#name')?.value.trim().length || 0) >= 2;

        function toggleSections() {
            if (state.method === 'email') {
                emailSection.classList.remove('hidden');
                phoneSection.classList.add('hidden');
            } else {
                phoneSection.classList.remove('hidden');
                emailSection.classList.add('hidden');
            }
            updateSendButtons();
            updateNextAvailability();
        }

        function updateSendButtons() {
            const nameOk  = nameOK();
            const emailOk = isValidEmail($('#email').value);
            const phoneOk = isValidPhone($('#phone').value);
            $('#sendEmailCode').disabled = !(nameOk && emailOk);
            $('#sendSmsCode').disabled   = !(nameOk && phoneOk);
        }

        function validateBasic() {
            if (!nameOK()) return false;
            if (state.method === 'email') {
                return isValidEmail($('#email').value) && state.emailVerified;
            } else {
                return isValidPhone($('#phone').value) && state.phoneVerified;
            }
        }
        function updateNextAvailability(){ nextBtn.disabled = !validateBasic(); }

        // 라디오 전환
        $$('input[name="method"]').forEach(r => r.addEventListener('change', e => {
            state.method = e.target.value;
            toggleSections();
        }));

        // 입력 변화
        ['#name','#email','#phone','#emailCode','#smsCode'].forEach(sel => {
            const el = $(sel); if (!el) return;
            el.addEventListener('input', () => { updateSendButtons(); updateNextAvailability(); });
        });

        // ========== 이메일 인증 ==========
        $('#sendEmailCode').addEventListener('click', async () => {
            if (!nameOK()) return alert('이름을 입력해 주세요.');
            const email = $('#email').value.trim();
            if (!isValidEmail(email)) return alert('이메일 형식이 올바르지 않습니다.');

            try {
                const res = await fetch('/NICHIYA/email/send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...csrfHeaders() },
                    body: JSON.stringify({ email })
                });
                if (res.ok) {
                    $('#emailVerifyGroup').classList.remove('hidden');
                    alert('인증번호를 이메일로 전송했습니다.');
                } else {
                    alert('이메일 전송에 실패했습니다.');
                }
            } catch (e) {
                console.error(e); alert('서버 오류로 전송 실패했습니다.');
            }
        });

        $('#verifyEmailCode').addEventListener('click', async () => {
            const code = $('#emailCode').value.trim();
            if (!code) return alert('인증번호를 입력하세요.');
            try {
                const res = await fetch('/NICHIYA/email/code', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...csrfHeaders() },
                    body: JSON.stringify({ code })
                });
                const data = await res.json().catch(()=>({}));
                if (res.ok && data.isMatched) {
                    state.emailVerified = true;
                    updateNextAvailability();
                    alert('이메일 인증이 완료되었습니다.');
                } else {
                    alert('인증번호가 일치하지 않습니다.');
                }
            } catch (e) {
                console.error(e); alert('서버 오류로 검증 실패.');
            }
        });

        // ========== 휴대폰 인증 (실제 API 사용) ==========
        $('#sendSmsCode').addEventListener('click', async () => {
            if (!nameOK()) return alert('이름을 입력해 주세요.');
            const phone = $('#phone').value.trim();
            if (!isValidPhone(phone)) return alert('휴대폰 번호를 정확히 입력해 주세요.');

            try {
                const res = await fetch('/NICHIYA/api/sms/send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...csrfHeaders() },
                    body: JSON.stringify({ phoneNumber: phone })
                });
                const data = await res.json().catch(()=>({}));
                if (res.ok && data.ok === true) {
                    $('#phoneVerifyGroup').classList.remove('hidden');
                    alert('인증번호를 전송했습니다. 문자메시지를 확인하세요.');
                } else {
                    alert(data.message || '문자 전송 실패. 다시 시도해주세요.');
                }
            } catch (e) {
                console.error(e); alert('서버 오류로 전송 실패.');
            }
        });

        $('#verifySmsCode').addEventListener('click', async () => {
            const phone = $('#phone').value.trim();
            const code  = $('#smsCode').value.trim();
            if (!code) return alert('인증번호를 입력하세요.');
            try {
                const res = await fetch('/NICHIYA/api/sms/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...csrfHeaders() },
                    body: JSON.stringify({ phoneNumber: phone, code })
                });
                const data = await res.json().catch(()=>({}));
                if (res.ok && data.ok === true) {
                    state.phoneVerified = true;
                    updateNextAvailability();
                    alert('휴대폰 인증이 완료되었습니다.');
                } else {
                    alert(data.message || '인증번호가 일치하지 않습니다.');
                }
            } catch (e) {
                console.error(e); alert('서버 오류로 검증 실패.');
            }
        });

        // ========== 다음: 사용자/판매자 구분해서 아이디 조회 후 결과 페이지로 ==========
        nextBtn.addEventListener('click', async () => {
            if (!validateBasic()) return alert('이름과 연락처 입력 및 인증을 완료해 주세요.');

            const memberType = $('#memberType').value;        // 'personal' | 'business'
            const isSeller   = memberType === 'business';
            const url        = isSeller ? '/NICHIYA/seller/find-id' : '/NICHIYA/user/find-id';

            const payload = {
                name  : $('#name').value.trim(),
                method: state.method,
                email : state.method === 'email' ? $('#email').value.trim() : '',
                phone : state.method === 'phone' ? $('#phone').value.trim() : ''
            };

            try {
                const res  = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...csrfHeaders() },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();

                if (res.ok && data.ok) {
                    // 결과 저장 후 결과 페이지로 이동
                    const result = isSeller
                        ? { ok: true, type: 'seller',  sellerId: data.sellerId, name: data.name, email: data.email, created_at: data.created_at }
                        : { ok: true, type: 'user',    userId  : data.userId,   name: data.name, email: data.email, created_at: data.created_at };

                    localStorage.setItem('findUserResult', JSON.stringify(result));
                    location.href = '/NICHIYA/member/findresultId';
                } else {
                    alert(data.message || '해당 정보로 가입된 사용자를 찾을 수 없습니다.');
                }
            } catch (e) {
                console.error(e); alert('서버 오류가 발생했습니다.');
            }
        });

        // 초기 표시
        toggleSections();
        updateSendButtons();
        updateNextAvailability();
    });
</script>



<div th:replace="~{main/footer.html}"></div>

</body>

</html>