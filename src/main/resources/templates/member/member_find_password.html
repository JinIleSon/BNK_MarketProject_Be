<!DOCTYPE html>
<html lang="ko">

<head>
    <!-- CSRF í† í°ì´ ìˆì„ ë•Œë§Œ ë©”íƒ€ íƒœê·¸ ë Œë” -->
    <meta th:if="${_csrf != null}" name="_csrf" th:content="${_csrf.token}"/>
    <meta th:if="${_csrf != null}" name="_csrf_header" th:content="${_csrf.headerName}"/>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°</title>
    <style>
        :root {
            --black: #111;
            --gray: #777;
            --light: #f4f5f7;
            --primary: #111;
            --accent: #3F97F6
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            margin: 0
        }

        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Pretendard, Apple SD Gothic Neo, Malgun Gothic, Noto Sans KR, sans-serif;
            color: var(--black);
            background: #fff
        }

        .wrap {
            max-width: 760px;
            margin: 48px auto;
            padding: 0 20px
        }

        h1 {
            font-size: 40px;
            letter-spacing: -.02em;
            margin: 0 0 24px;
            text-align: center
        }

        .desc {
            color: #555;
            text-align: center;
            line-height: 1.6;
            margin-bottom: 28px
        }

        .card {
            background: #fff;
            border: 1px solid #e6e6e6;
            padding: 28px 24px
        }

        .row {
            margin-bottom: 18px
        }

        label {
            display: block;
            font-weight: 600;
            margin: 0 0 8px
        }

        .field {
            width: 100%;
            height: 50px;
            padding: 0 14px;
            border: 1px solid #ddd;
            outline: none
        }

        .field:focus {
            border-color: #222;
            box-shadow: 0 0 0 3px rgba(0, 0, 0, .06)
        }

        .helper {
            font-size: 13px;
            color: #888;
            margin-top: 6px
        }

        .actions {
            display: flex;
            gap: 10px;
            margin-top: 24px
        }

        .btn {
            flex: 1 1 0;
            height: 50px;
            border: 1px solid #111;
            background: #111;
            color: #fff;
            font-weight: 700;
            cursor: pointer
        }

        .btn.secondary {
            background: #fff;
            color: #111
        }

        .btn:disabled {
            opacity: .5;
            cursor: not-allowed
        }

        .inline {
            display: flex;
            gap: 10px;
            align-items: center
        }

        .radio-line {
            display: flex;
            gap: 18px;
            align-items: center
        }

        .radio-line .item {
            display: flex;
            gap: 8px;
            align-items: center
        }

        .sub-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px
        }

        .hidden {
            display: none
        }

        .select {
            width: 100%;
            height: 50px;
            border: 1px solid #ddd;
            padding: 0 12px
        }

        .bar {
            height: 1px;
            background: #eee;
            margin: 20px 0
        }

        .row-email {
            margin: 10px 0 18px 0
        }

        .row-phone {
            margin: 10px 0 18px 0
        }

        /* ì¸ì¦ë²ˆí˜¸ ì…ë ¥ ì¤„: ì…ë ¥ì¹¸ ê°€ë³€ + ë²„íŠ¼ ê³ ì •, ë†’ì´ 50pxë¡œ í†µì¼ */
        #emailVerifyGroup .inline,
        #phoneVerifyGroup .inline {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: nowrap
        }

        #emailVerifyGroup .inline .field,
        #phoneVerifyGroup .inline .field {
            flex: 1 1 auto;
            width: auto
        }

        #emailVerifyGroup .inline .btn,
        #phoneVerifyGroup .inline .btn {
            flex: 0 0 120px;
            width: 120px;
            height: 50px;
            border-radius: 0;
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            line-height: 1;
        }
    </style>
</head>

<body>
<div th:replace="~{main/header.html}"></div>
    <div class="wrap">
        <h1>ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°</h1>
        <p class="desc">ì´ë©”ì¼ ë˜ëŠ” íœ´ëŒ€í° ì¸ì¦ìœ¼ë¡œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì¬ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

        <div class="card">
            <!-- ì¸ì¦ ë‹¨ê³„ -->
            <section id="verifySection" aria-label="ì¸ì¦ ë‹¨ê³„">
                <!-- íšŒì›ìœ í˜• -->
                <div class="row">
                    <label for="memberType">íšŒì›ìœ í˜•</label>
                    <select id="memberType" class="select" aria-label="íšŒì›ìœ í˜•">
                        <option value="personal">ì¼ë°˜íšŒì›</option>
                        <option value="business">íŒë§¤ìíšŒì›</option>
                    </select>
                </div>

                <!-- ì¸ì¦ ë°©ì‹ -->
                <div class="row">
                    <label>ì¸ì¦ ë°©ì‹</label>
                    <div class="radio-line" role="radiogroup" aria-label="ì¸ì¦ ë°©ì‹">
                        <label class="item"><input type="radio" name="method" value="email" checked> ì´ë©”ì¼</label>
                        <label class="item"><input type="radio" name="method" value="phone"> íœ´ëŒ€í° ì¸ì¦</label>
                    </div>
                </div>

                <!-- ì•„ì´ë”” -->
                <div class="row">
                    <label for="userid">ì•„ì´ë””</label>
                    <input id="userid" class="field" type="text" placeholder="ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”" autocomplete="username"
                        required>
                </div>

                <div class="bar" aria-hidden="true"></div>

                <!-- ì´ë©”ì¼ ì¸ì¦ -->
                <section id="emailSection" aria-label="ì´ë©”ì¼ ì¸ì¦">
                    <div class="row">
                        <label for="email">ì´ë©”ì¼ë¡œ ì°¾ê¸°</label>
                        <input id="email" class="field" type="email" placeholder="example@domain.com"
                            autocomplete="email">
                        <p class="helper">ì•„ì´ë””ì™€ ì´ë©”ì¼ì´ ëª¨ë‘ ì…ë ¥ë˜ì–´ì•¼ ì¸ì¦ë²ˆí˜¸ë¥¼ ì „ì†¡í•©ë‹ˆë‹¤.</p>
                    </div>

                    <div class="sub-actions">
                        <button id="sendEmailCode" class="btn" type="button" disabled>ì¸ì¦ë²ˆí˜¸ ì „ì†¡</button>
                    </div>

                    <div id="emailVerifyGroup" class="row-email hidden">
                        <label class="sr-only" for="emailCode">ì¸ì¦ë²ˆí˜¸</label>
                        <div class="inline">
                            <input id="emailCode" class="field" type="text" inputmode="numeric" pattern="[0-9]*"
                                placeholder="ì „ì†¡ë°›ì€ ì¸ì¦ë²ˆí˜¸ ì…ë ¥">
                            <button id="verifyEmailCode" class="btn" type="button">í™•ì¸</button>
                        </div>
                    </div>
                </section>

                <!-- íœ´ëŒ€í° ì¸ì¦ -->
                <section id="phoneSection" class="hidden" aria-label="íœ´ëŒ€í° ì¸ì¦">
                    <div class="row">
                        <label for="phone">íœ´ëŒ€í° ë²ˆí˜¸ë¡œ ì°¾ê¸°</label>
                        <input id="phone" class="field" type="tel" inputmode="tel" maxlength="11"
                            placeholder="01012345678">
                        <p class="helper">ì•„ì´ë””ì™€ íœ´ëŒ€í° ë²ˆí˜¸ê°€ ëª¨ë‘ ì…ë ¥ë˜ì–´ì•¼ ì¸ì¦ë²ˆí˜¸ë¥¼ ì „ì†¡í•©ë‹ˆë‹¤. í•˜ì´í”ˆ ì—†ì´ ìˆ«ìë§Œ ì…ë ¥.</p>
                    </div>

                    <div class="sub-actions">
                        <button id="sendSmsCode" class="btn" type="button" disabled>ì¸ì¦ë²ˆí˜¸ ì „ì†¡</button>
                    </div>

                    <div id="phoneVerifyGroup" class="row-phone hidden">
                        <label class="sr-only" for="smsCode">ì¸ì¦ë²ˆí˜¸</label>
                        <div class="inline">
                            <input id="smsCode" class="field" type="text" inputmode="numeric" pattern="[0-9]*"
                                placeholder="ì „ì†¡ë°›ì€ ì¸ì¦ë²ˆí˜¸ ì…ë ¥">
                            <button id="verifySmsCode" class="btn" type="button">í™•ì¸</button>
                        </div>
                    </div>
                </section>

                <div class="actions">
                    <button id="cancelBtn" class="btn secondary" type="button" onclick="history.back()">ì·¨ì†Œ</button>
                    <button id="nextBtn" class="btn" type="button" disabled>ë‹¤ìŒ</button>
                </div>
            </section>
        </div>
    </div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // 0) ìœ í‹¸ & ìƒíƒœ
        const $  = s => document.querySelector(s);
        const $$ = s => Array.from(document.querySelectorAll(s));

        const state = { method: 'email', emailCode: null, smsCode: null, emailVerified: false, phoneVerified: false };

        const nextBtn = $('#nextBtn');
        const emailSection = $('#emailSection');
        const phoneSection = $('#phoneSection');

        // CSRF(ì“°ëŠ” ê²½ìš°ë§Œ)
        function csrf() {
            const token  = document.querySelector('meta[name="_csrf"]')?.content;
            const header = document.querySelector('meta[name="_csrf_header"]')?.content || 'X-CSRF-TOKEN';
            return token ? { header, token } : null;
        }

        function toggleSections() {
            const emailSection = $('#emailSection');
            const phoneSection = $('#phoneSection');
            if (!emailSection || !phoneSection) return;

            if (state.method === 'email') {
                emailSection.classList.remove('hidden');
                phoneSection.classList.add('hidden');
            } else {
                phoneSection.classList.remove('hidden');
                emailSection.classList.add('hidden');
            }
            updateSendButtons();
            updateNextAvailability();
        }

        function updateSendButtons() {
            const emailBtn = $('#sendEmailCode');
            const smsBtn = $('#sendSmsCode');
            if (emailBtn) emailBtn.disabled = !$('#email')?.value;
            if (smsBtn) smsBtn.disabled = !/^01[0-9]{8,9}$/.test($('#phone')?.value ?? '');
        }

        function updateNextAvailability() {
            const nextBtn = $('#nextBtn');
            if (!nextBtn) return;

            let enabled = false;
            if (state.method === 'email') {
                const email = $('#email')?.value.trim() ?? '';
                const name = $('#name')?.value.trim() ?? '';
                enabled = email && name && state.emailVerified;
            } else {
                const phone = $('#phone')?.value.trim() ?? '';
                const name = $('#name')?.value.trim() ?? '';
                enabled = phone && name && state.phoneVerified;
            }

            nextBtn.disabled = !enabled;
        }

        // 1) ìœ íš¨ì„±
        const isValidEmail = v => /.+@.+\..+/.test(v.trim());
        const isValidPhone = v => /^01[0-9]{8,9}$/.test(v.trim());
        const idOK = () => $('#userid').value.trim().length >= 3;

        function updateSendButtons() {
            const emailBtn = $('#sendEmailCode');
            const smsBtn   = $('#sendSmsCode');

            if (state.method === 'email') {
                if (emailBtn) emailBtn.disabled = !(idOK() && isValidEmail($('#email').value));
                if (smsBtn)   smsBtn.disabled   = true;
            } else {
                if (smsBtn)   smsBtn.disabled   = !(idOK() && isValidPhone($('#phone').value));
                if (emailBtn) emailBtn.disabled = true;
            }
        }

        function validateBasic() {
            if (!idOK()) return false;
            if (state.method === 'email') {
                return isValidEmail($('#email').value) && state.emailVerified;
            } else {
                return isValidPhone($('#phone').value) && state.phoneVerified;
            }
        }
        function updateNextAvailability() { nextBtn.disabled = !validateBasic(); }

        function toggleSectionsByMethod() {
            if (state.method === 'email') {
                emailSection.classList.remove('hidden');
                phoneSection.classList.add('hidden');
            } else {
                phoneSection.classList.remove('hidden');
                emailSection.classList.add('hidden');
            }
            updateSendButtons();
            updateNextAvailability();
        }

        // 2) ì´ë²¤íŠ¸ ë°”ì¸ë”©
        $$('input[name="method"]').forEach(r => r.addEventListener('change', e => {
            state.method = e.target.value;
            toggleSectionsByMethod();
        }));

        ['#userid', '#email', '#phone', '#emailCode', '#smsCode'].forEach(sel => {
            const el = $(sel); if (!el) return;
            el.addEventListener('input', () => { updateSendButtons(); updateNextAvailability(); });
        });

        // ì´ë©”ì¼ ì¸ì¦ë²ˆí˜¸ ì „ì†¡
        $('#sendEmailCode').addEventListener('click', async () => {
            if (!(idOK() && isValidEmail($('#email').value))) return;

            try {
                const res = await fetch("/NICHIYA/email/send", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ email: $('#email').value.trim() })
                });
                if (res.ok) {
                    $('#emailVerifyGroup').classList.remove('hidden');
                    alert("ì¸ì¦ë²ˆí˜¸ë¥¼ ì´ë©”ì¼ë¡œ ì „ì†¡í–ˆìŠµë‹ˆë‹¤.");
                } else {
                    alert("ì´ë©”ì¼ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
                }
            } catch (err) {
                console.error(err);
                alert("ì„œë²„ ì˜¤ë¥˜ë¡œ ì „ì†¡ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
        });

        // ì´ë©”ì¼ ì¸ì¦ë²ˆí˜¸ í™•ì¸
        $('#verifyEmailCode').addEventListener('click', async () => {
            const code = $('#emailCode').value.trim();
            if (!code) return alert("ì¸ì¦ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

            try {
                const res = await fetch("/NICHIYA/email/code", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ code })
                });
                const data = await res.json();
                if (res.ok && data.isMatched) {
                    state.emailVerified = true;
                    updateNextAvailability();
                    alert("ì´ë©”ì¼ ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                } else {
                    alert("ì¸ì¦ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                }
            } catch (err) {
                console.error(err);
                alert("ì„œë²„ ì˜¤ë¥˜ë¡œ ê²€ì¦ ì‹¤íŒ¨.");
            }
        });

        // SMS ì „ì†¡/í™•ì¸ (mock)
        // $('#sendSmsCode').addEventListener('click', async () => {
        //     if (!idOK() || !isValidPhone($('#phone').value)) return;
        //     await new Promise(r => setTimeout(r, 400));
        //     state.smsCode = String(Math.floor(100000 + Math.random() * 900000));
        //     console.log('[DEV] sms code:', state.smsCode);
        //     $('#phoneVerifyGroup').classList.remove('hidden');
        //     alert('íœ´ëŒ€í°ìœ¼ë¡œ ì¸ì¦ë²ˆí˜¸ë¥¼ ì „ì†¡í–ˆìŠµë‹ˆë‹¤.');
        // });
        // $('#verifySmsCode').addEventListener('click', () => {
        //     const ok = $('#smsCode').value.trim() === state.smsCode;
        //     if (ok) { state.phoneVerified = true; alert('íœ´ëŒ€í° ì¸ì¦ ì™„ë£Œ'); }
        //     else alert('ì¸ì¦ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        //     updateNextAvailability();
        // });

        // ===========================
// ğŸ“± SMS ì¸ì¦ë²ˆí˜¸ ì „ì†¡ (Solapi + Mock ëŒ€ì‘)
// ===========================
        $('#sendSmsCode').addEventListener('click', async () => {
            const phone = $('#phone').value.trim();
            if (!phone || !/^01[0-9]{8,9}$/.test(phone)) {
                alert('íœ´ëŒ€í° ë²ˆí˜¸ë¥¼ ì •í™•íˆ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }

            try {
                const res = await fetch('/NICHIYA/api/sms/send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phoneNumber: phone })
                });

                const raw = await res.text();
                let data;
                try { data = JSON.parse(raw); } catch { data = raw; }

                console.log('ğŸ“¤ SMS ì „ì†¡ ì‘ë‹µ:', data);

                if (
                    res.ok &&
                    (data.success === true || (typeof data === 'string' && (data.includes('ì¸ì¦') || data.includes('ì „ì†¡'))))
                ) {
                    $('#phoneVerifyGroup').classList.remove('hidden');
                    alert('ì¸ì¦ë²ˆí˜¸ë¥¼ ì „ì†¡í–ˆìŠµë‹ˆë‹¤. ë¬¸ìë©”ì‹œì§€ë¥¼ í™•ì¸í•˜ì„¸ìš”.');

                    // mock ì½”ë“œ í™•ì¸ìš© (ê°œë°œì ì½˜ì†”ì—ë§Œ ì¶œë ¥)
                    const codeMatch = typeof data === 'string' ? data.match(/\d{4,6}/) : null;
                    if (codeMatch) console.log('ğŸ“± ë°œì†¡ëœ ì¸ì¦ë²ˆí˜¸:', codeMatch[0]);
                } else {
                    alert('ë¬¸ì ì „ì†¡ ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                }
            } catch (err) {
                console.error('ğŸš¨ SMS ì „ì†¡ ì˜¤ë¥˜:', err);
                alert('ì„œë²„ ì˜¤ë¥˜ë¡œ ì „ì†¡ ì‹¤íŒ¨.');
            }
        });

// ===========================
// ğŸ” ì¸ì¦ë²ˆí˜¸ í™•ì¸ (Solapi + Mock ëŒ€ì‘)
// ===========================
        $('#verifySmsCode').addEventListener('click', async () => {
            const phone = $('#phone').value.trim();
            const code = $('#smsCode').value.trim();
            if (!code) return alert('ì¸ì¦ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');

            try {
                const res = await fetch('/NICHIYA/api/sms/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phoneNumber: phone, code })
                });

                const raw = await res.text();
                let data;
                try { data = JSON.parse(raw); } catch { data = raw; }

                console.log('âœ… ì¸ì¦ ì‘ë‹µ:', data);

                if (
                    res.ok &&
                    ((data.matched === true) || (typeof data === 'string' && data.includes('ì¸ì¦ ì„±ê³µ')))
                ) {
                    state.phoneVerified = true;
                    updateNextAvailability();
                    alert('íœ´ëŒ€í° ì¸ì¦ ì™„ë£Œ âœ…');
                } else {
                    state.phoneVerified = false;
                    alert('ì¸ì¦ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }
            } catch (err) {
                console.error('ğŸš¨ ì¸ì¦ í™•ì¸ ì˜¤ë¥˜:', err);
                alert('ì„œë²„ ì˜¤ë¥˜ë¡œ ê²€ì¦ ì‹¤íŒ¨.');
            }
        });



        // 3) â€œë‹¤ìŒâ€ = ì„ì‹œ ë¹„ë°€ë²ˆí˜¸ ë°œê¸‰
        nextBtn.addEventListener('click', async()=>{
            if(!validateBasic())return alert('ì¸ì¦ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.');
            const payload={
                userId:$('#userid').value.trim(),method:state.method,
                email:state.method==='email'?$('#email').value.trim():"",
                phone:state.method==='phone'?$('#phone').value.trim():""
            };
            try{
                const res=await fetch('/NICHIYA/member/issue-temp-password',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
                const data=await res.json();
                if(res.ok&&data.ok){alert('ì„ì‹œ ë¹„ë°€ë²ˆí˜¸: '+data.tempPassword);location.href='/NICHIYA/member/login';}
                else alert(data.message||'ë°œê¸‰ ì‹¤íŒ¨.');
            }catch(e){alert('ì„œë²„ ì˜¤ë¥˜.');}
        });

        toggleSections();

    });
</script>


<div th:replace="~{main/footer.html}"></div>
</body>

</html>