<div th:replace="~{admin/_header.html}"></div>

    <main style="display: flex; justify-content: center; border-top:1px solid #e2e2e2;">
        <div>
        <aside class="euro-nav" aria-label="관리자 사이드 메뉴" style="">
            <section class="euro-nav__group">
            <h4 class="euro-nav__title" style="">환경설정</h4>
            <ul class="euro-nav__list">
                <li class="euro-nav__item"><a href="#">기본설정</a></li>
                <li class="euro-nav__item"><a href="#">배너관리</a></li>
                <li class="euro-nav__item"><a href="#">약관관리</a></li>
                <li class="euro-nav__item"><a href="#">카테고리</a></li>
                <li class="euro-nav__item"><a href="#">버전관리</a></li>
            </ul>
            </section>
            <section class="euro-nav__group">
            <h4 class="euro-nav__title" style="">상점관리</h4>
            <ul class="euro-nav__list">
                <li class="euro-nav__item"><a href="/admin/store_list.html">상점목록</a></li>
                <li class="euro-nav__item is-active"><a href="/admin/sale_status.html">매출현황</a></li>
            </ul>
            </section>

            <section class="euro-nav__group">
            <h4 class="euro-nav__title" style="">회원관리</h4>
            <ul class="euro-nav__list">
                <li class="euro-nav__item"><a href="/admin/member_list.html">회원목록</a></li>
                <li class="euro-nav__item"><a href="/admin/point_management.html">포인트관리</a></li>
            </ul>
            </section>

            <section class="euro-nav__group">
            <h4 class="euro-nav__title" style="">상품관리</h4>
            <ul class="euro-nav__list">
                <li class="euro-nav__item"><a href="#">상품목록</a></li>
                <li class="euro-nav__item"><a href="#">상품등록</a></li>
            </ul>
            </section>

            <section class="euro-nav__group">
            <h4 class="euro-nav__title" style="">주문관리</h4>
            <ul class="euro-nav__list">
                <li class="euro-nav__item"><a href="#">주문현황</a></li>
                <li class="euro-nav__item"><a href="#">배송현황</a></li>
            </ul>
            </section>

            <section class="euro-nav__group">
            <h4 class="euro-nav__title" style="">쿠폰관리</h4>
            <ul class="euro-nav__list">
                <li class="euro-nav__item"><a href="#">쿠폰목록</a></li>
                <li class="euro-nav__item"><a href="#">쿠폰발급현황</a></li>
            </ul>
            </section>

            <section class="euro-nav__group">
            <h4 class="euro-nav__title" style="">고객센터</h4>
            <ul class="euro-nav__list">
                <li class="euro-nav__item"><a href="/admin/announcement_list.html">공지사항</a></li>
                <li class="euro-nav__item"><a href="/admin/questions_list.html">자주묻는질문</a></li>
                <li class="euro-nav__item"><a href="#">문의하기</a></li>
                <li class="euro-nav__item"><a href="#">채용하기</a></li>
            </ul>
            </section>
        </aside>
        </div>
        <div style="border-left:1px solid #e2e2e2;"></div>
            <div style="margin-left:40px; width:900px; height:1000px; border:none; padding:20px; box-sizing:border-box; font-family:'Noto Sans KR', sans-serif;">

            <!-- 제목 + 경로 -->
            <div style="display: flex;">
                    <div style="font-size: 20px; font-weight: 800; margin-top:16px; margin-bottom:5px;">매출현황</div>
                    <div style="margin-left: auto; margin-top:auto; margin-bottom:4px;font-size: 12px;">HOME > 상점관리 > <span style="font-weight: 800;">매출현황</span></div>
                </div>
                <hr style="border:none; border-top:1px solid gray; margin-top:0px;">
                <div style="padding-left:10px;">
                <div style="display: flex; align-items: center; margin-top: 25px; margin-bottom:20px;">
                    <form action="" method="post" style="display: flex; ">
                        <select name="select" id="" style="width:82px; height:28px; padding-left:5px; margin-right:3px; border:1px solid #bfbfbf; font-size: 10px !important;">
                            <option value="name">일별</option>
                            <option value="code">주간</option>
                            <option value="seller">한달</option>
                        </select>
                    </form>
                </div>

            <!-- 2. 테이블 -->
            <table style="width:100%; border-collapse:collapse; text-align:center; font-size:14px;">
            <thead>
                <tr style="border-top:2px solid #000; border-bottom:1px solid #ccc; background:#fafafa; height:50px;">
                <th style="padding:8px; width:61px;">번호</th>
                <th style="width:180px;">상호명</th>
                <th style="width:140px;">사업자등록번호</th>
                <th style="width:81px;">주문건수</th>
                <th style="width:81px;">결제완료</th>
                <th style="width:61px;">배송중</th>
                <th style="width:81px;">배송완료</th>
                <th style="width:81px;">주문합계</th>
                <th style="width:81px;">매출합계</th>
                </tr>
            </thead>
            <tbody>
                <tr style="border-bottom:1px solid #e2e2e2; height:70px;vertical-align: middle;"
                    th:each="admin, stat:${pageResponseDTO.dtoList}">
                    <td th:text="${pageResponseDTO.startNo - stat.index}">5</td>
                    <td th:text="${admin.brand_name}">(주) 다니와</td>
                    <td th:text="${admin.biz_registration_number}">112-12-12345</td>
                    <td th:text="${admin.order_count}">103</td>
                    <td th:text="${admin.completed_count}">90</td>
                    <td th:text="${admin.shipping_count}">56</td>
                    <td th:text="${admin.delivered_count}">52</td>
                    <td th:text="${admin.order_total}">12,870,600</td>
                    <td th:text="${admin.sales_total}">10,870,600</td>
                </tr>

            </tbody>
            </table>
                    <div style=" height: 100px; margin-top:40px; display: flex; justify-content: center;">
                        <input th:if="${pageResponseDTO.prev}"
                               th:onclick="|location.href='@{/admin/sales/list(pg=${pageResponseDTO.start - 1})}'|"
                               type="button" class="prev-page" value="< 이전">

                        <th:block th:each="num:${#numbers.sequence(pageResponseDTO.start, pageResponseDTO.end)}">
                            <input th:onclick="|location.href='@{/admin/sales/list(pg=${num})}'|"
                                   th:class="${num == pageResponseDTO.pg ? 'current' : 'num'}"
                                   type="button"
                                   th:value="${num}" />
                        </th:block>

                        <input th:if="${pageResponseDTO.next}"
                               th:onclick="|location.href='@{/admin/sales/list(pg=${pageResponseDTO.end + 1})}'|"
                               type="button" class="next-page" value="다음 >" style="">
                    </div>
            </div>
        </div>
        </div>
    </main>

    <style>
        .current{
            border:1px solid #333;
            background-color: #333;
            color: white;
            height: 30px;
            width: 30px;
            margin-right:7px;
            line-height:1;
        }
        .num {
            cursor: pointer;
            border:1px solid #ddd;
            color: #555;
            height: 30px;
            width: 30px;
            margin-right:7px;
            line-height:1;
        }
        .euro-nav__list {
            max-height: 0;                /* 기본은 접힘 */
            overflow: hidden;             /* 안 보이게 */
            transition: max-height 0.15s ease;
        }

            .euro-nav__group.open .euro-nav__list {
            max-height: 500px;            /* 펼쳐졌을 때 (충분히 크게 설정) */
        }
    </style>
    <script>
        // 아코디언: 클릭 시 높이를 실제 내용 높이로 애니메이션
  document.querySelectorAll('.euro-nav__title').forEach(title => {
    title.style.cursor = 'pointer'; // 클릭 가능 시각화(선택)
    title.addEventListener('click', () => {
      const group = title.parentElement;
      const list  = group.querySelector('.euro-nav__list');

      const isOpen = group.classList.contains('open');

      if (isOpen) {
        // 닫기: 현재 높이를 고정 -> 0으로
        list.style.maxHeight = list.scrollHeight + 'px';
        // 강제 리플로우로 트랜지션 시작점 확정
        list.offsetHeight; 
        list.style.maxHeight = '0px';
        group.classList.remove('open');
      } else {
        // 열기: 0 -> 내용 높이
        group.classList.add('open');
        list.style.maxHeight = list.scrollHeight + 'px';

        // 애니메이션 끝나면 inline max-height 제거(자연스런 레이아웃)
        const onEnd = (e) => {
          if (e.propertyName === 'max-height') {
            list.style.maxHeight = 'none';
            list.removeEventListener('transitionend', onEnd);
          }
        };
        list.addEventListener('transitionend', onEnd);
      }
    });
  });

  const groups = document.querySelectorAll('.euro-nav__group');
  document.querySelectorAll('.euro-nav__title').forEach(title => {
    title.addEventListener('click', () => {
      groups.forEach(g => {
        if (g !== title.parentElement && g.classList.contains('open')) {
          const l = g.querySelector('.euro-nav__list');
          l.style.maxHeight = l.scrollHeight + 'px';
          l.offsetHeight;
          l.style.maxHeight = '0px';
          g.classList.remove('open');
        }
      });
    }, {capture:true});
  });
        // ---- 유틸 ----
        function fmt(n){ return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ','); }
        function num(t){ return +String(t).replace(/[^\d.-]/g,'') || 0; }
        function rint(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
        function byRatio(baseRatio, total, cap){
            const jitter = 0.8 + Math.random()*0.4; // 0.8~1.2
            return Math.min(cap, Math.max(0, Math.round(total*(baseRatio*jitter))));
        }

        (function(){
            const tbody = document.querySelector('table tbody');
            if(!tbody) return;
            const rows = Array.from(tbody.querySelectorAll('tr'));
            if(rows.length === 0) return;

            // ---- 1) 기준 찾기 (해당 페이지 내 첫 '비어있지 않은' 행, 없으면 localStorage) ----
            let base = null;
            for(const tr of rows){
                const tds = tr.children;
                const o = num(tds[3].textContent);
                const c = num(tds[4].textContent);
                const s = num(tds[5].textContent);
                const d = num(tds[6].textContent);
                const ot = num(tds[7].textContent);
                const st = num(tds[8].textContent);
                const hasData = o>0 || c>0 || s>0 || d>0 || ot>0 || st>0;
                if(hasData){
                    base = {o:o, c:c, s:s, d:d, ot:ot, st:st};
                    break;
                }
            }

            // localStorage 키
            const LS_KEY = 'sales_baseline_v1';
            if(!base){
                try{
                    const saved = JSON.parse(localStorage.getItem(LS_KEY)||'null');
                    if(saved) base = saved;
                }catch(e){}
            }

            // 기준이 없으면 안전한 디폴트
            if(!base){
                base = {o:50, c:30, s:10, d:25, ot:500000, st:400000};
            }

            // ---- 2) 기준에서 비율/단가 계산 ----
            const ratioComp = base.o ? base.c/base.o : 0.5;
            const ratioShip = base.o ? base.s/base.o : 0.2;
            const ratioDeli = base.o ? base.d/base.o : 0.6;
            const unitOT = base.o ? base.ot/base.o : 10000;
            const unitST = base.o ? base.st/base.o :  8000;

            // ---- 3) 모든 행(첫 행 포함) 채우기 ----
            rows.forEach(tr=>{
                const tds = tr.children;
                let order = num(tds[3].textContent);
                let comp  = num(tds[4].textContent);
                let ship  = num(tds[5].textContent);
                let deli  = num(tds[6].textContent);
                let otot  = num(tds[7].textContent);
                let stot  = num(tds[8].textContent);

                if(order === 0) order = rint(1, 99);
                if(comp  === 0) comp  = byRatio(ratioComp, order, 99);
                if(deli  === 0) deli  = byRatio(ratioDeli, order, 99);
                if(ship  === 0) ship  = byRatio(ratioShip, order, 99);

                // 논리 보정
                if(comp > order) comp = order;
                if(deli > order) deli = order;
                if(ship + deli > order) ship = Math.max(0, order - deli);

                // 금액(1,000,000 미만)
                if(otot === 0){
                    let est = Math.round(order * unitOT * (0.8 + Math.random()*0.4));
                    if(est >= 1000000){ est = Math.floor(est * (999000/est)); }
                    otot = Math.max(1000, Math.min(999000, est));
                }
                if(stot === 0){
                    let est = Math.round(order * unitST * (0.8 + Math.random()*0.4));
                    if(est >= 1000000){ est = Math.floor(est * (999000/est)); }
                    stot = Math.max(1000, Math.min(999000, est));
                }

                tds[3].textContent = order;
                tds[4].textContent = comp;
                tds[5].textContent = ship;
                tds[6].textContent = deli;
                tds[7].textContent = fmt(otot);
                tds[8].textContent = fmt(stot);
            });

            // ---- 4) 기준 저장(페이지에 기준 행이 있었다면) ----
            try{
                if(base && base.o>0){
                    localStorage.setItem(LS_KEY, JSON.stringify(base));
                }
            }catch(e){}
        })();
        // ====== 정렬 기능 (활성 컬럼만 화살표 표시 + hover 스타일) ======
        (function(){
            const table = document.querySelector('table');
            if(!table) return;
            const tbody = table.querySelector('tbody');
            const headers = table.querySelectorAll('thead th');

            // 정렬 가능한 컬럼
            const labels = { 3:'주문건수', 7:'주문합계', 8:'매출합계' };

            // 초기 라벨 저장
            const baseTexts = {};
            Object.keys(labels).forEach(i => {
                baseTexts[i] = headers[i].textContent.trim();
                headers[i].classList.add('sortable'); // hover 스타일 적용
            });

            let sortState = { col: null, asc: true };
            const toNum = v => parseFloat(String(v).replace(/[^\d.-]/g,'')) || 0;

            headers.forEach((th, idx) => {
                if(!(idx in labels)) return;
                th.title = `${labels[idx]} 기준으로 정렬`;

                th.addEventListener('click', () => {
                    const rows = Array.from(tbody.querySelectorAll('tr'));
                    const asc = sortState.col === idx ? !sortState.asc : false;
                    sortState = { col: idx, asc };

                    rows.sort((a,b)=>{
                        const A = toNum(a.children[idx].textContent);
                        const B = toNum(b.children[idx].textContent);
                        return asc ? A - B : B - A;
                    });
                    rows.forEach(tr => tbody.appendChild(tr));

                    // 헤더 상태 초기화
                    headers.forEach((h,i)=>{
                        if(i in labels){
                            h.style.backgroundColor = '';
                            h.textContent = baseTexts[i];
                        }
                    });

                    // 현재 정렬 중인 컬럼 표시
                    th.style.backgroundColor = '#f0f0f0';
                    th.textContent = `${labels[idx]} ${asc ? '▲' : '▼'}`;
                });
            });
        })();
        /* ----------------------------- 데이터 채우기 함수 ----------------------------- */
        function fillSalesData(mode){
            // mode : '일별' | '주간' | '한달'
            const tbody = document.querySelector('table tbody');
            if(!tbody) return;
            const rows = Array.from(tbody.querySelectorAll('tr'));

            // 각 모드별 범위 지정
            let range = {};
            switch(mode){
                case '주간':
                    range = { orderMin:100, orderMax:999, moneyMin:1_000_000, moneyMax:10_000_000 };
                    break;
                case '한달':
                    range = { orderMin:1000, orderMax:9999, moneyMin:10_000_000, moneyMax:100_000_000 };
                    break;
                default: // 일별
                    range = { orderMin:1, orderMax:99, moneyMin:1_000, moneyMax:999_000 };
            }

            rows.forEach(tr=>{
                const tds = tr.children;

                let order = rint(range.orderMin, range.orderMax);
                let comp  = rint(Math.floor(order*0.3), order);
                let ship  = rint(Math.floor(order*0.1), Math.floor(order*0.3));
                let deli  = rint(Math.floor(order*0.3), order);

                // 논리 보정
                if(comp > order) comp = order;
                if(deli > order) deli = order;
                if(ship + deli > order) ship = Math.max(0, order - deli);

                // 금액
                const otot = rint(range.moneyMin, range.moneyMax);
                const stot = rint(Math.floor(otot*0.7), otot);

                // 테이블 반영
                tds[3].textContent = order;
                tds[4].textContent = comp;
                tds[5].textContent = ship;
                tds[6].textContent = deli;
                tds[7].textContent = fmt(otot);
                tds[8].textContent = fmt(stot);
            });
        }

        /* ----------------------------- select 변경 시 반응 ----------------------------- */
        (function(){
            const select = document.querySelector('select[name="select"]');
            if(!select) return;

            // 페이지 로드 시 기본값(일별)
            fillSalesData('일별');

            select.addEventListener('change', ()=>{
                const mode = select.options[select.selectedIndex].textContent.trim();
                fillSalesData(mode);
            });
        })();
    </script>
<style>
    /* --- 정렬 가능한 헤더 hover 효과 --- */
    th.sortable {
        cursor: pointer;
        transition: background-color 0.2s ease, color 0.2s ease;
    }
    th.sortable:hover {
        background-color: #f2f2f2;
        color: #000;
    }
</style>
<div th:replace="~{admin/_footer.html}"></div>