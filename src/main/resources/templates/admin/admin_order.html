<div th:replace="~{admin/_noneStickyHeader.html}"></div>
<body th:data-ctx="@{/}">
    <main style="border-top:1px solid #e2e2e2; display: flex; justify-content: center; ">
        <div>
            <aside class="euro-nav" aria-label="관리자 사이드 메뉴" style="">
                <section class="euro-nav__group">
                    <h4 class="euro-nav__title" style="">환경설정</h4>
                    <ul class="euro-nav__list">
                        <li class="euro-nav__item"><a href="#">기본설정</a></li>
                        <li class="euro-nav__item"><a href="#">배너관리</a></li>
                        <li class="euro-nav__item"><a href="#">약관관리</a></li>
                        <li class="euro-nav__item"><a href="#">카테고리</a></li>
                        <li class="euro-nav__item"><a href="#">버전관리</a></li>
                    </ul>
                </section>

                <section class="euro-nav__group">
                    <h4 class="euro-nav__title" style="">상점관리</h4>
                    <ul class="euro-nav__list">
                        <li class="euro-nav__item"><a th:href="@{/admin/shop/list}">상점목록</a></li>
                        <li class="euro-nav__item"><a th:href="@{/admin/sales/list}">매출현황</a></li>
                    </ul>
                </section>

                <section class="euro-nav__group">
                    <h4 class="euro-nav__title" style="">회원관리</h4>
                    <ul class="euro-nav__list">
                        <li class="euro-nav__item"><a th:href="@{/admin/member/list}">회원목록</a></li>
                        <li class="euro-nav__item"><a th:href="@{/admin/point/list}">포인트관리</a></li>
                    </ul>
                </section>

                <section class="euro-nav__group">
                    <h4 class="euro-nav__title" style="">상품관리</h4>
                    <ul class="euro-nav__list">
                        <li class="euro-nav__item"><a th:href="@{/admin/product/list}">상품목록</a></li>
                        <li class="euro-nav__item"><a th:href="@{/admin/productReg/list}">상품등록</a></li>
                    </ul>
                </section>

                <section class="euro-nav__group">
                    <h4 class="euro-nav__title" style="">주문관리</h4>
                    <ul class="euro-nav__list">
                        <li class="euro-nav__item is-active"><a th:href="@{/admin/order/list}">주문현황</a></li>
                        <li class="euro-nav__item"><a th:href="@{/admin/delivery/list}">배송현황</a></li>
                    </ul>
                </section>

                <section class="euro-nav__group">
                    <h4 class="euro-nav__title" style="">쿠폰관리</h4>
                    <ul class="euro-nav__list">
                        <li class="euro-nav__item"><a th:href="@{/admin/coupon/list}">쿠폰목록</a></li>
                        <li class="euro-nav__item"><a th:href="@{/admin/couponsnow/list}">쿠폰발급현황</a></li>
                    </ul>
                </section>

                <section class="euro-nav__group">
                    <h4 class="euro-nav__title" style="">고객센터</h4>
                    <ul class="euro-nav__list">
                        <li class="euro-nav__item"><a th:href="@{/admin/announcement/list}">공지사항</a></li>
                        <li class="euro-nav__item"><a th:href="@{/admin/FAQ/list}">자주묻는질문</a></li>
                        <li class="euro-nav__item"><a th:href="@{/admin/inquiry/list}">문의하기</a></li>
                        <li class="euro-nav__item"><a th:href="@{/admin/employ/list}">채용하기</a></li>
                    </ul>
                </section>
            </aside>
        </div>
        <div style="width:940px; border-left:1px solid #e2e2e2;">
            <div style="margin-left:60px;">
                <div style="display: flex;">
                    <div style="font-size: 20px; font-weight: 800; margin-top:16px; margin-bottom:5px;">주문현황</div>
                    <div style="margin-left: auto; margin-top:auto; margin-bottom:4px;font-size: 12px;">HOME > 주문관리 > <span style="font-weight: 800;">주문현황</span></div>
                </div>
                <hr style="border:none; border-top:1px solid gray; margin-top:0px;">
                <div style="padding-left:10px;">
                <div style="display: flex; align-items: center; margin-top: 25px; margin-bottom:20px;">
                    <form th:action="@{/admin/order/search}" method="get" style="display: flex; ">
                        <select name="searchType" id="" style="width:82px; height:28px; padding-left:5px; margin-right:3px; border:1px solid #bfbfbf; font-size: 10px !important;">
                            <option value="order_code">주문번호</option>
                            <option value="userId">주문자</option>
                            <option value="name">주문자명</option>
                        </select>
                        <input type="text" name="keyword" placeholder="검색어입력" style="width:140px; height:28px; padding-left:10px; margin-right:3px; border:1px solid #bfbfbf; font-size: 10px !important;">
                        <input type="submit" value="검색" style="width:50px; height:28px; color:white; background-color: black; border:none; font-size: 12px !important;">
                    </form>
                </div>
                <table style="border-collapse: collapse; width:100%; font-size:12px; text-align: center; ">
                    <tr style="border-top:1px solid gray; height:50px; border-bottom:1px solid #e2e2e2;">
                        <th style="width:124px;">주문번호</th>
                        <th style="width:64px;">주문자</th>
                        <th style="width:79px;">주문자명</th>
                        <th style="width:79px;">주문건수</th>
                        <th style="width:79px;">주문합계</th>
                        <th style="width:79px;">결제수단</th>
                        <th style="width:79px;">주문상태</th>
                        <th style="width:180px;">주문일</th>
                        <th style="width:103px;">배송</th>
                    </tr>
                    <tr th:each="admin, stat:${pageResponseDTO.dtoList}"
                            style="border-bottom:1px solid #e2e2e2; height:70px;vertical-align: middle;">
                        <td
                        ><a href="#" style="font-weight: 800;" th:text="${admin.order_code}"
                        class="order-link" th:attr="data-order-no=${admin.order_code},
                                                    data-detail-url=@{/admin/order/detail}"
                        >10121211341</a></td>
                        <td th:text="${admin.userId}">abc123</td>
                        <td th:text="${admin.user_name}">김유신</td>
                        <td th:text="${admin.orders_count}">2</td>
                        <td th:text="${admin.total_amount}">102,900</td>
                        <td th:text="${admin.method}">신용카드</td>
                        <td th:text="${admin.status}"
                            th:style="${admin.status == '결제완료' ? 'color:#4cbf6e' :
                            (admin.status == '결제대기' ? 'color:#cae7a4' :
                            (admin.status == '주문취소' ? 'color:red' : 'color:gray'))}"
                            style="color:#8bd8a7">결제완료</td>
                        <td th:text="${admin.created_at}">0000-00-00 00:00:00</td>
                        <td>
                            <button style="cursor:pointer;height:30px; border: 1px solid #e2e2e2;"
                            class="ship-btn"
                            th:attr="
                            data-order-no=${admin.order_code},
                            data-recipient=${admin.recipient},
                            data-zip=${admin.postcode},
                            data-addr1=${admin.user_address},
                            data-addr2=${admin.detail_address}
                            ">배송하기</button>
                        </td>
                    </tr>
                </table>
                    <div style=" height: 100px; margin-top:40px; display: flex; justify-content: center;">
                        <input th:if="${pageResponseDTO.prev}"
                               th:onclick="|location.href='@{/admin/order/list(pg=${pageResponseDTO.start - 1})}'|"
                               type="button" class="prev-page" value="< 이전">

                        <th:block th:each="num:${#numbers.sequence(pageResponseDTO.start, pageResponseDTO.end)}">
                            <input th:onclick="|location.href='@{/admin/order/list(pg=${num})}'|"
                                   th:class="${num == pageResponseDTO.pg ? 'current' : 'num'}"
                                   type="button"
                                   th:value="${num}" />
                        </th:block>

                        <input th:if="${pageResponseDTO.next}"
                               th:onclick="|location.href='@{/admin/order/list(pg=${pageResponseDTO.end + 1})}'|"
                               type="button" class="next-page" value="다음 >" style="">
                    </div>
                    <style>
                        .current{
                            border:1px solid #333;
                            background-color: #333;
                            color: white;
                            height: 30px;
                            width: 30px;
                            margin-right:7px;
                            line-height:1;
                        }
                        .num {
                            cursor: pointer;
                            border:1px solid #ddd;
                            color: #555;
                            height: 30px;
                            width: 30px;
                            margin-right:7px;
                            line-height:1;
                        }
                    </style>
                <!-- 주문상세 콘텐츠 템플릿: '첫번째 사진' 영역 그대로 -->
<template id="orderDetailTemplate">
  <!-- ↓↓↓ 여기부터 기존 “첫번째 사진” 영역 전체를 그대로 붙여넣기 ↓↓↓ -->
  <div style="font-size:18px; margin-bottom:10px; font-weight: 800;">상품정보</div>
  <table style="border-collapse: collapse; border:none; width:1270px; text-align: center; ">
    <form action="" method="">
      <tr style="height:50px;border-top: 4px solid black; border-bottom: 1px solid #dddddd;">
        <td style="width:60px;"></td>
        <td style="">상품번호</td>
        <td style="">상품명</td>
        <td style="">판매자</td>
        <td style="">가격</td>
        <td style="">할인</td>
        <td style="">수량</td>
        <td style="">배송비</td>
        <td style="">결제금액</td>
      </tr>
      <tr style=" border-bottom: 1px solid #dddddd;">
        <td style="display: flex;">
          <div style="margin:10px;width:80px; height:75px; background-color: #dddddd;">
            <img src="#" alt="이미지">
          </div>
        </td>
        <td style="">120120021</td>
        <td>OOO</td>
        <td>(주)상호명</td>
        <td style="">24,000</td>
        <td style="">-1,200</td>
        <td style="">3</td>
        <td style="">0</td>
        <td style="">68,400</td>
      </tr>
      <tr style=" border-bottom: 1px solid #dddddd;">
        <td style="display: flex;">
          <div style="margin:10px;width:80px; height:75px; background-color: #dddddd;">
            <img src="#" alt="이미지">
          </div>
        </td>
        <td style="">114514328</td>
        <td>OOO</td>
        <td>(주)상호명</td>
        <td style="">35,000</td>
        <td style="">-3,500</td>
        <td style="">1</td>
        <td style="">3,000</td>
        <td style="">34,500</td>
      </tr>
    </form>
  </table>

  <div style="border:1px solid #f2f2f2; width:300px;margin-left:970px; height:148px; padding:20px; background-color: #f2f2f2;">
    <div style="padding-left:7px;padding-right:7px;">
      <div style="margin-bottom:6px;">
        <div>총 상품금액<span style="float:right;">107,000 원</span></div>
      </div>
      <div style="margin-bottom:6px;">
        <div>총 할인금액<span style="float:right;">-7,100 원</span></div>
      </div>
      <div style="margin-bottom:6px;">
        <div>배송비<span style="float:right;">3,000 원</span></div>
      </div>
      <div style="margin-bottom:6px;">
        <div>총 결제금액<span style="float:right; color:red;">102,900 원</span></div>
      </div>
    </div>
  </div>

  <div style="display: flex; margin-top:14px; margin-bottom:10px;">
    <div style="font-size:18px; "><b>결제정보</b></div>
  </div>
  <div style="border-top:4px solid; width:1270px;  display: flex; border-bottom: 1px solid #dddddd;">
    <div style=" width:150px; padding:17px; background-color: #f2f2f2;">
      <div style="margin-bottom:6px;">주문정보</div>
      <div style="margin-bottom:6px;">결제방법</div>
      <div style="margin-bottom:6px;">주문자</div>
      <div style="margin-bottom: 6px;">연락처</div>
      <div style="">결제상태</div>
    </div>
    <div style="padding-left:19px;  display: flex; justify-content: center; flex-direction:column;">
      <div style="margin-bottom:7px;">10121211341</div>
      <div style="margin-bottom:7px;">신용카드 / 1234 **** **** 4432</div>
      <div style="margin-bottom:7px;">김유신</div>
      <div style="margin-bottom:4px;">010-1234-1234</div>
      <div style="margin-bottom:4px; color:#4cbf6e;">결제완료</div>
    </div>
    <div style="display: flex; align-items: end; margin-left: auto;">
      <div style="width:210px; margin-right:45px; margin-bottom:8px;"><span>총 결제금액</span><span style="float:right;">원</span><span style="color:red; float:right;">102,900</span></div>
    </div>
  </div>

  <div style="display: flex; margin-top:14px;margin-bottom:10px; ">
    <div style="font-size:18px;"><b>배송정보</b></div>
  </div>
  <div style="border-top:4px solid; width:1270px;  display: flex; border-bottom: 1px solid #dddddd; margin-bottom:0;">
    <div style=" width:150px; padding:17px; background-color: #f2f2f2;">
      <div style="margin-bottom:6px;">수취인</div>
      <div style="margin-bottom:6px;">연락처</div>
      <div>배송지 주소</div>
    </div>
    <div style="padding-left:19px;  display: flex; justify-content: center; flex-direction:column;">
      <div style="margin-bottom:7px;">김유신</div>
      <div style="margin-bottom:7px;">010-1234-1234</div>
      <div>부산 부산진구 123-11 10층</div>
    </div>
  </div>

  <!-- ↑↑↑ 여기까지 기존 영역 그대로 ↑↑↑ -->
</template>

            </div>
        </div>
        </div>
        <div id="orderDetailModal" class="order-modal__overlay" aria-hidden="true">
  <div class="order-modal" role="dialog" aria-modal="true" aria-labelledby="orderModalTitle">
    <div class="order-modal__head">
  <span id="orderModalTitle" style="font-size: 20px;">주문상세</span>
  <span id="orderModalNo" class="order-id"></span>
  <button type="button" class="order-modal__close" id="orderModalClose" aria-label="닫기"></button>
</div>
    <div class="order-modal__body" id="orderModalBody">
    </div>
  </div>
</div>
<!-- ▼ 배송입력 모달 콘텐츠 템플릿 -->
<template id="shipFormTemplate">
  <div class="ship-form__wrap">
    <!-- 제목 라인은 모달 헤더에서 렌더링하므로 여기엔 폼만 -->
    <form th:action="@{/admin/delivery/register}" method="post">
      <table class="ship-form__table">
        <colgroup>
          <col style="width:140px">
          <col style="width:9">
        </colgroup>
        <tbody>
          <tr>
            <th style="font-size: 14px;">주문번호</th>
            <td><input type="text" name="order_code" class="ipt" id="sf-orderNo" readonly style="" required></td>
          </tr>
          <tr>
            <th style="font-size: 14px;">수령인</th>
            <td><input type="text" name="recipient" class="ipt" id="sf-recipient" placeholder="홍길동" required style="outline: none;"></td>
          </tr>
          <tr>
            <th style="font-size: 14px;">우편번호</th>
            <td><input type="text" name="zipcode" class="ipt" id="sf-zip" placeholder="12345" required style="outline: none;"></td>
          </tr>
          <tr>
            <th style="font-size: 14px;">기본주소</th>
            <td><input type="text" name="address" class="ipt" id="sf-addr1" placeholder="부산광역시 부산진구 부전동 123" required style="outline: none;"></td>
          </tr>
          <tr>
            <th style="font-size: 14px;">상세주소</th>
            <td><input type="text" name="address2" class="ipt" id="sf-addr2" placeholder="OO 빌딩 3층 301호" required style="outline: none;"></td>
          </tr>
          <tr>
            <th style="font-size: 14px;">택배사</th>
            <td>
              <select class="delicom" name="delicom" style="padding-left:6px; outline: none; height:33px; border: 1px solid #d0d0d0;" required>
                <option>택배사선택</option>
                <option value="대한통운">대한통운</option>
                <option value="한진택배">한진택배</option>
                <option value="우체국">우체국</option>
                <option value="로젠택배">로젠택배</option>
                <option value="경동택배">경동택배</option>
              </select>
            </td>
          </tr>
          <tr>
            <th style="font-size: 14px;">운송장번호</th>
            <td><input type="text" name="invoice" class="ipt" required placeholder="발급받은 택배 송장번호 입력(11자리)" style="outline: none;"></td>
          </tr>
          <tr>
            <th style="font-size: 14px;">기타</th>
            <td><textarea class="txt" name="note" id="sf-etc" required placeholder="기타정보입력" style="resize:none; outline: none;" ></textarea></td>
          </tr>
        </tbody>
      </table>
      <div class="ship-form__actions" style="display: flex; justify-content: center;">
        <button type="submit" class="btn-primary" id="shipSubmitBtn" style="background-color: black !important; font-weight:300;">등록하기</button>
      </div>
    </form>
  </div>
</template>
<!-- ▼ 배송입력 모달 -->
<div id="shipModal" class="order-modal__overlay ship-modal" aria-hidden="true">
  <div class="order-modal" role="dialog" aria-modal="true" aria-labelledby="shipModalTitle">
    <!-- 세번째 이미지 스타일의 머리 -->
    <div class="ship-modal__head">
      <div class="ship-head__title">
        <span id="shipModalTitle" style="font-size: 20px">배송입력</span>
        <span id="shipModalOrderNo" class="ship-head__order"></span>
      </div>
      <button type="button" class="order-modal__close" id="shipModalClose" aria-label="닫기"></button>
    </div>
    <div class="order-modal__body" id="shipModalBody"></div>
  </div>
</div>


    </main>

    <style>
        .euro-nav__list {
            max-height: 0;                /* 기본은 접힘 */
            overflow: hidden;             /* 안 보이게 */
            transition: max-height 0.15s ease;
        }

            .euro-nav__group.open .euro-nav__list {
            max-height: 500px;            /* 펼쳐졌을 때 (충분히 크게 설정) */
        }
        /* 주문상세 모달 */
        /* 중앙 정렬 */
        .order-modal__overlay{
            position:fixed; inset:0;
            background:rgba(0,0,0,.35);
            display:none;
            align-items:center;          /* flex-start → center */
            justify-content:center;      /* 이미 center였지만 명시 */
            z-index:1200;
            padding:24px;                /* 화면 가장자리와 여백 */
        }
        .order-modal__overlay.show{ display:flex; }

        .order-modal{
            width:min(1200px, 80vw);
            background:#fff; border:1px solid #ddd;
            box-shadow:0 20px 50px rgba(0,0,0,.2);
            margin:0;                    /* 24px auto → 0 (중앙정렬을 위해) */
            display:flex; flex-direction:column;
            /* (선택) 화면보다 커질 때 대비
            max-height: calc(100vh - 48px);
            */
        }
        /* ===== 배송입력(#shipModal) 전용 사이즈/레이아웃 ===== */
        #shipModal .order-modal{
          width: min(520px, 70vw);   /* 주문상세(700px)보다 작게 */
        }

        .order-modal__head{
            display:flex; align-items:center; gap:8px;
            padding:14px 18px; border-bottom:1px solid #eee; font-weight:700;
        }
        .order-id { margin-left:20px; font-weight:600; } 
        /* 내부 스크롤 제거 */
        .order-modal__body{
            padding:18px;
            overflow:visible;           /* auto → visible */
        }
        .order-modal__close{
            margin-left:auto; background:none; border:0; cursor:pointer;
            width:36px; height:36px; position:relative;
        }
        .order-modal__close:before,
        .order-modal__close:after{
            content:""; position:absolute; left:8px; right:8px; top:17px; height:2px; background:#000;
        }
        .order-modal__close:before{ transform:rotate(45deg); }
        .order-modal__close:after{ transform:rotate(-45deg); }
        /* 모달 본문 안에서는 고정폭 없애고 100%로 */
        .order-modal__body table{ width:100% !important; }

        /* 템플릿에 있던 width:1270px 같은 고정폭 무시 */
        .order-modal__body [style*="width:1270px"]{ width:100% !important; }

        /* 우측 합계 박스: margin-left 고정 → 자동 오른쪽 정렬 */
        .order-modal__body [style*="margin-left:970px"]{
        margin-left:auto !important; 
        }

        /* 이미지/박스가 넘치지 않도록 */
        .order-modal__body img{ max-width:100%; height:auto; display:block; }
        .order-modal__body > *{ max-width:100%; box-sizing:border-box; }

        /* 테이블은 화면 좁을 때 줄바꿈에 대비 */
        .order-modal__body table{ table-layout:auto; }
        /* ▼ 배송입력 폼 스타일 */
.ship-form__table{
  width:100%;
  border-top:1px solid #e5e5e5;
  border-bottom:1px solid #e5e5e5;
  border-collapse:collapse;
  margin-top:12px;
  background:#fff;
}
.ship-form__table th{
  background:#f4f4f4;
  text-align:left;
  padding:12px 14px;
  border-bottom:1px solid #e9e9e9;
  font-weight:600;
  color:#333;
  vertical-align:middle;
}
.ship-form__table td{
  padding:10px 12px;
  border-bottom:1px solid #e9e9e9;
}
.ipt,.sel,.txt{
  width:100%;
  height:32px;
  border:1px solid #d0d0d0;
  padding:0 10px;
  box-sizing:border-box;
  font-size:14px;
}
.txt{ height:100px; padding:10px; resize:vertical; }
.ship-form__actions{
  display:flex; justify-content:flex-start;
  padding-top:16px;
}
.btn-primary{
  min-width:120px; height:36px; border:none; cursor:pointer;
  background:#2ba44e; color:#fff; font-weight:600;
}

/* ▼ 배송입력 모달 헤더(세번째 이미지 느낌) */
.ship-modal__head{
  display:flex; align-items:center; gap:8px;
  padding:14px 18px; border-bottom:1px solid #e5e5e5; font-weight:700;
}
.ship-head__title{ display:flex; align-items:center; gap:16px; }
.ship-head__order{ margin-left:10px; font-weight:600; color:#111; letter-spacing:0.02em; }

/* 주문상세에서 썼던 공통 헤더와 충돌 없도록 유지 */
        /* 배송 컬럼 상태표시/비활성 버튼 */
        .badge-cancel{
            display:inline-block;
            padding:6px 7px;
            border:1px solid #f0b7b7;
            background:#fdecec;
            color:#c44;
            font-size:12px;
        }
        .btn-disabled{
            cursor:not-allowed !important;
            opacity:.55;
            background:#eee !important;
            color:#999 !important;
            border-color:#ddd !important;
        }
    </style>
    <script>
        // 아코디언: 클릭 시 높이를 실제 내용 높이로 애니메이션
  document.querySelectorAll('.euro-nav__title').forEach(title => {
    title.style.cursor = 'pointer'; // 클릭 가능 시각화(선택)
    title.addEventListener('click', () => {
      const group = title.parentElement;
      const list  = group.querySelector('.euro-nav__list');

      const isOpen = group.classList.contains('open');

      if (isOpen) {
        // 닫기: 현재 높이를 고정 -> 0으로
        list.style.maxHeight = list.scrollHeight + 'px';
        // 강제 리플로우로 트랜지션 시작점 확정
        list.offsetHeight; 
        list.style.maxHeight = '0px';
        group.classList.remove('open');
      } else {
        // 열기: 0 -> 내용 높이
        group.classList.add('open');
        list.style.maxHeight = list.scrollHeight + 'px';

        // 애니메이션 끝나면 inline max-height 제거(자연스런 레이아웃)
        const onEnd = (e) => {
          if (e.propertyName === 'max-height') {
            list.style.maxHeight = 'none';
            list.removeEventListener('transitionend', onEnd);
          }
        };
        list.addEventListener('transitionend', onEnd);
      }
    });
  });

  const groups = document.querySelectorAll('.euro-nav__group');
  document.querySelectorAll('.euro-nav__title').forEach(title => {
    title.addEventListener('click', () => {
      groups.forEach(g => {
        if (g !== title.parentElement && g.classList.contains('open')) {
          const l = g.querySelector('.euro-nav__list');
          l.style.maxHeight = l.scrollHeight + 'px';
          l.offsetHeight;
          l.style.maxHeight = '0px';
          g.classList.remove('open');
        }
      });
    }, {capture:true});
  });

  // 주문상세 모달 열기/닫기
  const orderModalOverlay = document.getElementById('orderDetailModal');
  const orderModalClose   = document.getElementById('orderModalClose');
  const orderModalBody    = document.getElementById('orderModalBody');
  const orderTpl          = document.getElementById('orderDetailTemplate');


  function closeOrderModal(){
    orderModalOverlay.classList.remove('show');
    orderModalOverlay.setAttribute('aria-hidden', 'true');
    document.body.style.overflow='';
  }
  orderModalClose.addEventListener('click', closeOrderModal);
  orderModalOverlay.addEventListener('click', (e)=>{
    if(e.target === orderModalOverlay) closeOrderModal();
  });
  window.addEventListener('keydown', (e)=>{
    if(e.key === 'Escape' && orderModalOverlay.classList.contains('show')) closeOrderModal();
  });
        // 컨텍스트(/NICHIYA) 끝 슬래시 제거
        const CTX = (document.body.dataset.ctx || '').replace(/\/$/, '');

        function buildImageSrc(url){
            // 1) null/빈값이면 기본이미지
            if(!url) return `${CTX}/images/no-image.png`;

            // 2) 절대 URL(http/https)이면 그대로
            if(/^https?:\/\//i.test(url)) return url;

            // 3) 윈도우 경로 -> 웹 경로
            let s = String(url).trim().replace(/\\/g, '/');

            // 4) 이미 '/images/...' 로 시작하면 그 뒤만 사용
            //    또는 '.../images/...' 가 포함돼 있으면 그 뒤만 사용
            const idx = s.toLowerCase().lastIndexOf('/images/');
            if (idx !== -1) s = s.substring(idx + '/images/'.length);

            // 5) 디렉토리까지 섞여 있어도 맨 마지막 파일명만 사용
            s = s.split('/').filter(Boolean).pop();

            // 6) 최종 경로
            return `${CTX}/images/${s}`;
        }

        // 통화/숫자 포맷터
        const cur = new Intl.NumberFormat('ko-KR');
        // 할인 표기: 0이면 '-' 없이
        const fmtDiscount = v => {
            const n = Number(v) || 0;
            return (n > 0 ? '-' : '') + cur.format(n);
        };

        // 주문상세 모달 열고 내용 주입 (컨트롤러: GET /admin/order/detail?order_code=...)
        async function openOrderModal(orderNo, aEl){
            // 헤더 셋업
            document.getElementById('orderModalTitle').textContent = '주문상세';
            document.getElementById('orderModalNo').textContent = orderNo || '';

            // URL 생성 (data-detail-url 우선)
            const base = (aEl && aEl.dataset.detailUrl) ? aEl.dataset.detailUrl : '/admin/order/detail';
            const url  = `${base}?order_code=${encodeURIComponent(orderNo)}`;

            // 1) 데이터 가져오기 (컨트롤러에 맞춤)
            let rows = [];
            try{
                const res = await fetch(url, {
                    headers: { 'Accept': 'application/json' },
                    credentials: 'same-origin'       // 쿠키/세션 포함
                });

                // 디버깅용
                console.log('[order detail]', res.status, url, res.headers.get('content-type'));

                // JSON 아닌 응답(예: 로그인/에러 HTML) 방어
                const ct = res.headers.get('content-type') || '';
                if (!res.ok || !ct.includes('application/json')) {
                    throw new Error(`Bad response: ${res.status} ${ct}`);
                }

                rows = await res.json();
            }catch(e){
                console.error('order detail fetch error:', e);
                rows = [];
            }

            if(!Array.isArray(rows) || rows.length === 0){
                orderModalBody.innerHTML = `<div style="padding:12px;">주문 상세 데이터를 가져오지 못했습니다.</div>`;
                orderModalOverlay.classList.add('show');
                orderModalOverlay.setAttribute('aria-hidden','false');
                document.body.style.overflow = 'hidden';
                return;
            }

            // 2) 합계 계산
            let totalProduct = 0, totalDiscount = 0, totalDeli = 0, totalPay = 0;
            rows.forEach(r=>{
                totalProduct  += (r.price || 0) * (r.quantity || 0);
                totalDiscount += (r.discount || 0) * (r.quantity || 0);
                totalDeli     += (r.delichar || 0);            // ← 소문자
                totalPay      += (r.total_amount || 0);
            });

            const head = rows[0];

            // 품목 행
            const itemRowsHtml = rows.map(r => `
  <tr style="border-bottom:1px solid #dddddd;">
    <td style="display:flex;">
      <div style="margin:10px;width:80px;height:75px; background:#dddddd;">
        <img src="${buildImageSrc(r.url)}"
         alt=""
         style="width:100%;height:100%;object-fit:cover;">
      </div>
    </td>
    <td>${r.product_code ?? ''}</td>
    <td>${r.product_name ?? ''}</td>     <!-- ← 소문자 -->
    <td>${r.suname ?? ''}</td>
    <td>${cur.format(Number(r.price) || 0)}</td>
    <td>${fmtDiscount(r.discount)}</td>
    <td>${r.quantity ?? 0}</td>
    <td>${cur.format(Number(r.delichar) || 0)}</td>  <!-- ← 소문자 -->
    <td>${cur.format(Number(r.total_amount) || 0)}</td>
  </tr>
`).join('');

            // 4) 본문 렌더
            orderModalBody.innerHTML = `
    <div style="font-size:18px; margin-bottom:10px; font-weight:800;">상품정보</div>
    <table style="border-collapse:collapse; width:100%; text-align:center;">
      <tr style="height:50px;border-top:4px solid #000;border-bottom:1px solid #ddd;">
        <td style="width:60px;"></td>
        <td>상품번호</td>
        <td>상품명</td>
        <td>판매자</td>
        <td>가격</td>
        <td>할인</td>
        <td>수량</td>
        <td>배송비</td>
        <td>결제금액</td>
      </tr>
      ${itemRowsHtml}
    </table>

    <div style="border:1px solid #f2f2f2; max-width:300px; margin-left:auto; padding:20px; background:#f2f2f2;">
      <div style="padding-left:7px;padding-right:7px;">
        <div style="margin-bottom:6px;">총 상품금액<span style="float:right;">${cur.format(totalProduct)} 원</span></div>
        <div style="margin-bottom:6px;">총 할인금액<span style="float:right;">${fmtDiscount(totalDiscount)} 원</span></div>
        <div style="margin-bottom:6px;">배송비<span style="float:right;">${cur.format(totalDeli)} 원</span></div>
        <div style="margin-bottom:6px;">총 결제금액<div style="float:right;"><span style="color:red;">${cur.format(totalPay)}</span> 원</div></div>
      </div>
    </div>

    <div style="display:flex;margin-top:14px;margin-bottom:10px;">
      <div style="font-size:18px;"><b>결제정보</b></div>
    </div>
    <div style="border-top:4px solid; width:100%; display:flex; border-bottom:1px solid #ddd;">
      <div style="width:150px; padding:17px; background:#f2f2f2;">
        <div style="margin-bottom:6px;">주문정보</div>
        <div style="margin-bottom:6px;">결제방법</div>
        <div style="margin-bottom:6px;">주문자</div>
        <div style="margin-bottom:6px;">연락처</div>
        <div>결제상태</div>
      </div>
      <div style="padding-left:19px; display:flex; flex-direction:column;padding-top:14px;">
        <div style="margin-bottom:7px;">${head.order_code}</div>
        <div style="margin-bottom:7px;">${head.method || ''}</div>   <!-- ← 소문자 -->
        <div style="margin-bottom:7px;">${head.name || ''}</div>
        <div style="margin-bottom:4px;">${head.phone || ''}</div>    <!-- ← 소문자 -->
        <div style="margin-bottom:4px; color:${head.status==='결제완료' ? '#4cbf6e' : '#333'};">
          ${head.status || ''}                                       <!-- ← 소문자 -->
        </div>
      </div>
      <div style="display:flex; align-items:end; margin-left:auto;">
        <div style="width:210px; margin-right:45px; margin-bottom:8px;">
          <span>총 결제금액</span>
          <span style="float:right;">원</span>
          <span style="color:red; float:right;">${cur.format(totalPay)}</span>
        </div>
      </div>
    </div>

    <div style="display:flex; margin-top:14px; margin-bottom:10px; ">
      <div style="font-size:18px;"><b>배송정보</b></div>
    </div>
    <div style="border-top:4px solid; width:100%; display:flex; border-bottom:1px solid #ddd;">
      <div style="width:150px; padding:17px; background:#f2f2f2;">
        <div style="margin-bottom:6px;">수취인</div>
        <div style="margin-bottom:6px;">연락처</div>
        <div>배송지 주소</div>
      </div>
      <div style="padding-left:19px; display:flex; flex-direction:column; padding-top: 15px;">
<div style="margin-bottom:7px;">${head.recipient || ''}</div>
<div style="margin-bottom:7px;">${head.ruphone || ''}</div>
<div>${head.address || ''}</div>
      </div>
    </div>
  `;

            // 주문합계 컬럼 값 업데이트
            const orderRow = document.querySelector(`a.order-link[data-order-no="${orderNo}"]`)?.closest('tr');
            if (orderRow) {
                // 5번째 셀(주문합계 위치)에 접근
                const sumCell = orderRow.querySelectorAll('td')[4];
                if (sumCell) {
                    sumCell.textContent = cur.format(totalPay); // 숫자 포맷 후 표시
                }
            }

            // 5) 모달 표시
            orderModalOverlay.classList.add('show');
            orderModalOverlay.setAttribute('aria-hidden','false');
            document.body.style.overflow = 'hidden';
        }

        // 주문번호(a.order-link) 클릭 시 상세 열기
        document.querySelectorAll('a.order-link').forEach(a=>{
            a.addEventListener('click', (e)=>{
                e.preventDefault();
                const orderNo = a.getAttribute('data-order-no') || a.textContent.trim();
                if(!orderNo) return;
                openOrderModal(orderNo, a);
            });
        });
// ▼ 배송입력 모달 핸들러
const shipModalOverlay = document.getElementById('shipModal');
const shipModalBody    = document.getElementById('shipModalBody');
const shipModalClose   = document.getElementById('shipModalClose');
const shipTpl          = document.getElementById('shipFormTemplate');

function openShipModal(orderNo, prefill){
  document.getElementById('shipModalTitle').textContent = '배송입력';
  document.getElementById('shipModalOrderNo').textContent = orderNo ? orderNo : '';

  // 폼 붙이기
  shipModalBody.innerHTML = '';
  if (shipTpl){
    const node = shipTpl.content.cloneNode(true);
    shipModalBody.appendChild(node);

    // 폼 채우기
    const $ = sel => shipModalBody.querySelector(sel);
    $('#sf-orderNo').value   = orderNo || '';
    $('#sf-recipient').value = prefill?.recipient || '';
    $('#sf-zip').value       = prefill?.zip || '';
    $('#sf-addr1').value     = prefill?.addr1 || '';
    $('#sf-addr2').value     = prefill?.addr2 || '';
    $('#sf-etc').value       = prefill?.etc || '';
  }

  shipModalOverlay.classList.add('show');
  shipModalOverlay.setAttribute('aria-hidden','false');
  document.body.style.overflow='hidden';
}

function closeShipModal(){
  shipModalOverlay.classList.remove('show');
  shipModalOverlay.setAttribute('aria-hidden','true');
  document.body.style.overflow='';
}
shipModalClose.addEventListener('click', closeShipModal);
shipModalOverlay.addEventListener('click', (e)=>{ if(e.target === shipModalOverlay) closeShipModal(); });
window.addEventListener('keydown', (e)=>{ if(e.key === 'Escape' && shipModalOverlay.classList.contains('show')) closeShipModal(); });

// ▼ “결제완료” 행에서만 ‘배송하기’ 클릭 시 배송입력 모달 열기
document.querySelectorAll('table tr').forEach(tr=>{
  const btn = tr.querySelector('button.ship-btn'); // class 선택자 사용 권장
  if(!btn) return;

  btn.addEventListener('click', async (e)=>{
    e.preventDefault();

    const tds = tr.querySelectorAll('td');
    if (tds.length < 7) return;

    const orderNo = btn.dataset.orderNo || (tds[0].textContent || '').trim();
    const status  = (tds[6].textContent || '').trim();

      // 상태별 동작
      if (status === '주문취소') {
          // 버튼은 decorateShipColumnByStatus()에서 배지로 교체되지만, 혹시 남아있어도 클릭 무시
          return;
      }

      if (status === '결제대기') {
          alert('결제가 완료되어야 합니다.');
          return;
      }
      if (status !== '결제완료') return;

      // 기본은 data-* 값 사용
      let prefill = {
          recipient: btn.dataset.recipient || '',
          zip:       btn.dataset.zip || '',
          addr1:     btn.dataset.addr1 || '',
          addr2:     btn.dataset.addr2 || ''
      };
      // 값이 하나라도 비어있으면 상세 API로 채움
      if (!prefill.recipient || !prefill.zip || !prefill.addr1 || !prefill.addr2) {
          try {
              const base = btn.closest('tr')?.querySelector('a.order-link')?.dataset.detailUrl || '/admin/order/detail';
              const res  = await fetch(`${base}?order_code=${encodeURIComponent(orderNo)}`, {
                  headers: { 'Accept': 'application/json' },
                  credentials: 'same-origin'
              });
              if (res.ok && (res.headers.get('content-type')||'').includes('application/json')) {
                  const rows = await res.json();
                  const head = rows && rows[0] ? rows[0] : {};
                  prefill = {
                      recipient: prefill.recipient || head.recipient || '',
                      zip:       prefill.zip       || head.postcode  || '',
                      addr1:     prefill.addr1     || head.user_address || head.address || '',
                      addr2:     prefill.addr2     || head.detail_address || ''
                  };
              }
          } catch(err) {
              console.error('fallback fetch fail', err);
          }
      }

      openShipModal(orderNo, prefill);

  });
});
        // ========== 캐시 ==========
        const orderCache = new Map(); // orderNo -> { rows, totalPay }

        // 합계 계산 헬퍼 (openOrderModal과 동일 로직)
        function calcTotals(rows){
            let totalPay = 0, totalProduct = 0, totalDiscount = 0, totalDeli = 0;
            rows.forEach(r=>{
                totalProduct  += (r.price || 0) * (r.quantity || 0);
                totalDiscount += (r.discount || 0) * (r.quantity || 0);
                totalDeli     += (r.delichar || 0);
                totalPay      += (r.total_amount || 0);
            });
            return { totalPay, totalProduct, totalDiscount, totalDeli };
        }

        // 주문 상세 데이터 가져오기
        async function fetchOrderRows(orderNo, baseUrl){
            const url = `${baseUrl}?order_code=${encodeURIComponent(orderNo)}`;
            const res = await fetch(url, {
                headers: { 'Accept': 'application/json' },
                credentials: 'same-origin'
            });
            const ct = res.headers.get('content-type') || '';
            if(!res.ok || !ct.includes('application/json')) throw new Error('bad response');
            return await res.json();
        }

        // 페이지 로드 시 테이블의 "주문합계" 채우기
        async function preloadOrderSums(){
            const links = document.querySelectorAll('a.order-link');
            const jobs = Array.from(links).map(async a=>{
                const orderNo = a.dataset.orderNo || a.textContent.trim();
                const base    = a.dataset.detailUrl || '/admin/order/detail';
                const tr      = a.closest('tr');
                const sumCell = tr?.querySelectorAll('td')[4]; // 5번째 셀 = 주문합계
                if(!orderNo || !sumCell) return;

                try{
                    // 캐시 있으면 사용
                    let cache = orderCache.get(orderNo);
                    let rows;
                    if(cache?.rows){
                        rows = cache.rows;
                    }else{
                        rows = await fetchOrderRows(orderNo, base);
                    }
                    const { totalPay } = calcTotals(rows);
                    orderCache.set(orderNo, { rows, totalPay });

                    // 셀 반영
                    sumCell.textContent = cur.format(totalPay);
                }catch(err){
                    console.error('preload sum fail:', orderNo, err);
                    // 실패 시 기존 값 유지 (혹은 sumCell.textContent = '-';)
                }
            });

            // 모두 처리
            await Promise.allSettled(jobs);
        }
        /** 각 행의 주문상태를 읽어 배송 컬럼 UI를 정리 */
        function decorateShipColumnByStatus(){
            document.querySelectorAll('table tr').forEach(tr=>{
                const tds = tr.querySelectorAll('td');
                if (tds.length < 9) return; // 데이터 행만

                const statusText = (tds[6].textContent || '').trim();
                const shipCell   = tds[8];
                const btn        = shipCell.querySelector('button.ship-btn');

                // 주문취소: 버튼 대신 "주문취소" 배지로 교체
                if (statusText === '주문취소') {
                    if (btn) shipCell.removeChild(btn);
                    if (!shipCell.querySelector('.badge-cancel')) {
                        const badge = document.createElement('span');
                        badge.className = 'badge-cancel';
                        badge.textContent = '주문취소';
                        shipCell.appendChild(badge);
                    }
                    return;
                }

                // 결제대기: 버튼은 유지하되 비활성화 스타일 & 안내
                if (statusText === '결제대기') {
                    if (btn) {
                        btn.classList.add('btn-disabled');
                        btn.title = '결제가 완료되어야 합니다.';
                        // 키보드 접근성 위해 aria-disabled
                        btn.setAttribute('aria-disabled', 'true');
                    }
                    return;
                }

                // 결제완료 외 기타 상태는 기본 유지
            });
        }

        // DOM 준비 후 1회 적용 (페이지 진입 시)
        document.addEventListener('DOMContentLoaded', decorateShipColumnByStatus);
        // DOM 준비되면 실행
        document.addEventListener('DOMContentLoaded', preloadOrderSums);
    </script>
<div th:replace="~{admin/_footer.html}"></div>
</body>
