<div th:replace="~{admin/_header.html}"></div>
<meta name="_csrf" th:content="${_csrf.token}">
<meta name="_csrf_header" th:content="${_csrf.headerName}">
<style>
  /* ì¹´ë“œ */
  .tree-card{
    width: 540px;
    border: 1px solid #d9d9d9;
    background: #fff;
    padding: 10px 10px 6px;
  }

  /* ì•ˆë‚´ ë°°ë„ˆ */
  .helper{
    margin-top: 10px;
    background: #fff7cc;
    color:#444;
    font-size:12px;
    padding:10px;
    border:1px solid #f0e2a6;
  }

  /* íŠ¸ë¦¬ ê³µí†µ */
  .level-1,.level-2{list-style:none;margin:0;padding:0}
  .level-2{padding-left:22px}
  .node>.row,.leaf>.row{
    display:flex;align-items:center;gap:8px;
    padding:6px 8px;background:#fff;
    border:1px solid #d9d9d9;border-top:none;
  }
  .node:first-child>.row{border-top:1px solid #d9d9d9}
  .node>.row:hover,.leaf>.row:hover{background:#f7f9fc}

  /* í† ê¸€(â–¶/â–¼) */
  .toggle{
    width:22px;height:22px;line-height:20px;text-align:center;
    border:1px solid #cfcfcf;background:#fff;cursor:pointer;
    font-size:12px;flex-shrink:0;
  }

  /* ì´ë¦„ */
  .name[contenteditable="true"]{
    flex:1;min-width:0;padding:2px 4px;outline:1px dashed transparent
  }
  .name[contenteditable="true"]:focus{outline-color:#c7d2fe;background:#fff}

  /* ë²„íŠ¼ */
  .btn-add{border:1px solid #cbd5e1;background:#fff;color:#555;font-size:12px;cursor:pointer;padding:4px 8px}
  .btn-red{border:1px solid #ff6b6b;color:#ff4d4f;background:#fff;font-size:12px;padding:2px 6px;flex-shrink:0}

  /* ì ‘í˜ ì²˜ë¦¬ */
  .level-2.collapsed{display:none}

  /* í•˜ë‹¨(1ì°¨ì¶”ê°€/ì €ì¥) */
  .card-footer{
    margin-top:8px;display:flex;justify-content:space-between;align-items:center;
  }
  .save-btn{padding:8px 14px;background:#7d8fb3;color:#fff;border:none;cursor:pointer}

  /* 1ì°¨ ì¶”ê°€ ì¤„ */
  .add-l1-row .row{
    display:flex;align-items:center;gap:8px;
    padding:6px 8px;border:1px dashed #cbd5e1;background:#fafcff
  }

</style>

<main style="display:flex;justify-content:center;border-top:1px solid #e2e2e2;">
  <div>

      <aside class="euro-nav" aria-label="ê´€ë¦¬ì ì‚¬ì´ë“œ ë©”ë‰´" style="">
          <section class="euro-nav__group">
              <h4 class="euro-nav__title" style="">í™˜ê²½ì„¤ì •</h4>
              <ul class="euro-nav__list">
                  <li class="euro-nav__item"><a href="#">ê¸°ë³¸ì„¤ì •</a></li>
                  <li class="euro-nav__item"><a href="#">ë°°ë„ˆê´€ë¦¬</a></li>
                  <li class="euro-nav__item"><a href="#">ì•½ê´€ê´€ë¦¬</a></li>
                  <li class="euro-nav__item is-active"><a href="#">ì¹´í…Œê³ ë¦¬</a></li>
                  <li class="euro-nav__item"><a href="#">ë²„ì „ê´€ë¦¬</a></li>
              </ul>
          </section>

          <section class="euro-nav__group">
              <h4 class="euro-nav__title" style="">ìƒì ê´€ë¦¬</h4>
              <ul class="euro-nav__list">
                  <li class="euro-nav__item"><a th:href="@{/admin/shop/list}">ìƒì ëª©ë¡</a></li>
                  <li class="euro-nav__item"><a th:href="@{/admin/sales/list}">ë§¤ì¶œí˜„í™©</a></li>
              </ul>
          </section>

          <section class="euro-nav__group">
              <h4 class="euro-nav__title" style="">íšŒì›ê´€ë¦¬</h4>
              <ul class="euro-nav__list">
                  <li class="euro-nav__item"><a th:href="@{/admin/member/list}">íšŒì›ëª©ë¡</a></li>
                  <li class="euro-nav__item"><a th:href="@{/admin/point/list}">í¬ì¸íŠ¸ê´€ë¦¬</a></li>
              </ul>
          </section>

          <section class="euro-nav__group">
              <h4 class="euro-nav__title" style="">ìƒí’ˆê´€ë¦¬</h4>
              <ul class="euro-nav__list">
                  <li class="euro-nav__item"><a th:href="@{/admin/product/list}">ìƒí’ˆëª©ë¡</a></li>
                  <li class="euro-nav__item"><a th:href="@{/admin/productReg/list}">ìƒí’ˆë“±ë¡</a></li>
              </ul>
          </section>

          <section class="euro-nav__group">
              <h4 class="euro-nav__title" style="">ì£¼ë¬¸ê´€ë¦¬</h4>
              <ul class="euro-nav__list">
                  <li class="euro-nav__item"><a th:href="@{/admin/order/list}">ì£¼ë¬¸í˜„í™©</a></li>
                  <li class="euro-nav__item"><a th:href="@{/admin/delivery/list}">ë°°ì†¡í˜„í™©</a></li>
              </ul>
          </section>

          <section class="euro-nav__group">
              <h4 class="euro-nav__title" style="">ì¿ í°ê´€ë¦¬</h4>
              <ul class="euro-nav__list">
                  <li class="euro-nav__item"><a th:href="@{/admin/coupon/list}">ì¿ í°ëª©ë¡</a></li>
                  <li class="euro-nav__item"><a th:href="@{/admin/couponsnow/list}">ì¿ í°ë°œê¸‰í˜„í™©</a></li>
              </ul>
          </section>

          <section class="euro-nav__group">
              <h4 class="euro-nav__title" style="">ê³ ê°ì„¼í„°</h4>
              <ul class="euro-nav__list">
                  <li class="euro-nav__item"><a th:href="@{/admin/announcement/list}">ê³µì§€ì‚¬í•­</a></li>
                  <li class="euro-nav__item"><a th:href="@{/admin/FAQ/list}">ìì£¼ë¬»ëŠ”ì§ˆë¬¸</a></li>
                  <li class="euro-nav__item"><a th:href="@{/admin/inquiry/list}">ë¬¸ì˜í•˜ê¸°</a></li>
                  <li class="euro-nav__item"><a th:href="@{/admin/employ/list}">ì±„ìš©í•˜ê¸°</a></li>
              </ul>
          </section>
      </aside>
  </div>

  <div style="border-left:1px solid #e2e2e2;"></div>

  <div style="margin-left:40px; width:900px; height:1000px;">
    <section class="category-admin">
      <div class="page-head" style="border-bottom: 3px solid #cfcfcf;">
        <div class="title"><b>ì¹´í…Œê³ ë¦¬</b></div>
        <div class="breadcrumbs">HOME &gt; í™˜ê²½ì„¤ì • &gt; <b>ì¹´í…Œê³ ë¦¬</b></div>
      </div>

      <div class="div-gray" style="margin-bottom: 10px;">
        ì‡¼í•‘ëª° ë©”ì¸, ìƒí’ˆ í˜ì´ì§€ ì‚¬ì´ë“œ ì¹´í…Œê³ ë¦¬ ë©”ë‰´ ì…ë‹ˆë‹¤
      </div>

      <div class="panel">
        <div class="panel-head"></div>

        <div class="tree-card">
          <div class="tree-wrap" aria-label="ì¹´í…Œê³ ë¦¬ í¸ì§‘">
            <ul class="level-1" id="level1"><!-- JS ë Œë” --></ul>

            <div class="card-footer">
              <li class="node add-l1-row" style="list-style:none;width:auto;">
                <div class="row">
                  <button class="btn-add add-l1" type="button">+</button>
                  <span class="name" style="pointer-events:none;">1ì°¨ ì¹´í…Œê³ ë¦¬ ì¶”ê°€</span>
                </div>
              </li>
              <button id="saveBtn" class="save-btn" type="button">ìˆ˜ì •í•˜ê¸°</button>
            </div>
          </div>

          <div class="helper">
            ì¹´í…Œê³ ë¦¬ ë©”ë‰´ ìˆœì„œë¥¼ ë³€ê²½í•  ë•Œ ë“œë˜ê·¸ ì•¤ ë“œë¡­ìœ¼ë¡œ ì´ë™ í›„ <b>ìˆ˜ì •í•˜ê¸°</b>ë¥¼ í´ë¦­í•˜ì„¸ìš”.
          </div>
          <span class="save-hint" id="saveHint" aria-live="polite"></span>
        </div>

      </div>
    </section>
  </div>
</main>

<script th:inline="javascript">
  // ===== ê³µí†µ =====
  const CSRF_TOKEN  = document.querySelector('meta[name="_csrf"]')?.content;
  const CSRF_HEADER = document.querySelector('meta[name="_csrf_header"]')?.content;
  const API_BASE = /*[[@{/}]]*/ '';

  // ì‚­ì œ ì¶”ì  / ìŠ¤ëƒ…ìƒ·
  let initialIdSet = new Set();   // ì„œë²„ì—ì„œ ì²˜ìŒ ë°›ì•„ì˜¨ id ì§‘í•©(ì‹ ê·œ ìƒì„± ì œì™¸)
  const deletedIds = new Set();   // ê°œë³„ ì‚­ì œ í´ë¦­ì‹œ ê¸°ë¡(ë³´ì¡° ìˆ˜ë‹¨) â€” ìµœì¢…ì€ ìŠ¤ëƒ…ìƒ·ìœ¼ë¡œ ê³„ì‚°

  // ===== í…œí”Œë¦¿ =====
  function nodeTemplate(id, text){
    return `
      <li class="node" data-id="${id}" draggable="true">
        <div class="row" style="border:1px solid #cfcfcf;">
          <button class="drag-handle" type="button">â–¶</button>
          <span class="name" contenteditable="true">${text}</span>
          <button class="btn-red btn-del" data-scope="l1" type="button">ì‚­ì œ</button>
        </div>
        <ul class="level-2 droppable"></ul>
      </li>`;
  }

  function leafTemplate(id, text){
    return `
      <li class="leaf" data-id="${id}" draggable="true">
        <div class="row">
          <span class="name" contenteditable="true">${text}</span>
          <button class="btn-red btn-del" data-scope="l2" type="button">ì‚­ì œ</button>
        </div>
      </li>`;
  }

  function renderNodeHtml(id, name) {
    return `
    <li class="node" data-id="${id}" draggable="true">
      <div class="row" style="border: 1px solid #cfcfcf;">
        <button class="drag-handle" type="button">â–¶</button>
        <span class="name" contenteditable="true">${name}</span>
        <button class="btn-red btn-del" data-scope="l1" type="button">ì‚­ì œ</button>
      </div>
      <ul class="level-2 droppable"></ul>
    </li>`;
  }

  function renderLeafHtml(id, name) {
    return `
    <li class="leaf" data-id="${id}" draggable="true">
      <div class="row">
        <span class="name" contenteditable="true">${name}</span>
        <button class="btn-red btn-del" data-scope="l2" type="button">ì‚­ì œ</button>
      </div>
    </li>`;
  }

  function groupByParent(list){
    const map = {};
    list.forEach(cat=>{
      const pid = cat.parentId || 0;
      if (!map[pid]) map[pid] = [];
      map[pid].push(cat);
    });
    return map;
  }

  // ===== Drag & Drop =====
  let dragEl = null;

  function onDragStart(e){
    dragEl = e.currentTarget;
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/plain', dragEl.dataset.id || '');
    requestAnimationFrame(()=> dragEl.classList.add('ghost'));
  }
  function onDragEnd(){
    dragEl?.classList.remove('ghost');
    document.querySelectorAll('.drag-over').forEach(el=>el.classList.remove('drag-over'));
    dragEl = null;
  }
  function onDragOverRow(e){
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    e.currentTarget.classList.add('drag-over');
  }
  function onDragLeaveRow(e){
    e.currentTarget.classList.remove('drag-over');
  }
  function onDropRow(e){
    e.preventDefault();
    const targetLi = e.currentTarget.closest('li');
    if (!dragEl || !targetLi || dragEl === targetLi) return;

    if (dragEl.classList.contains('node') && targetLi.classList.contains('node')) {
      targetLi.parentNode.insertBefore(dragEl, targetLi);
    } else if (dragEl.classList.contains('leaf') && targetLi.classList.contains('leaf')) {
      targetLi.parentNode.insertBefore(dragEl, targetLi);
    }
    onDragLeaveRow(e);
  }
  function onDragOverList(e){
    e.preventDefault();
    e.currentTarget.classList.add('drag-over');
  }
  function onDragLeaveList(e){
    e.currentTarget.classList.remove('drag-over');
  }
  function onDropList(e){
    e.preventDefault();
    const list = e.currentTarget;
    if (!dragEl) return;

    if (dragEl.classList.contains('leaf') && list.classList.contains('level-2')) {
      const addRow = list.querySelector('.add-l2-row');
      if (addRow) list.insertBefore(dragEl, addRow);
      else list.appendChild(dragEl);
    }
    onDragLeaveList(e);
  }

  // ===== ë°”ì¸ë”© =====
  function wireNode(li){
    li.addEventListener('dragstart', onDragStart);
    li.addEventListener('dragend', onDragEnd);

    const row = li.querySelector('.row');
    if (row){
      row.addEventListener('dragover', onDragOverRow);
      row.addEventListener('dragleave', onDragLeaveRow);
      row.addEventListener('drop', onDropRow);
    }

    const del = li.querySelector('.btn-del');
    if (del){
      del.addEventListener('click', ()=>{
        const label = li.querySelector('.name')?.textContent.trim() || '';
        const id = li.dataset.id;
        if (confirm(`â€˜${label}â€™ë¥¼ ì‚­ì œí• ê¹Œìš”?`)) {
          if (id && !String(id).startsWith('n')) deletedIds.add(Number(id));
          li.remove();
        }
      });
    }

    const l2 = li.querySelector('.level-2');
    if (l2){
      l2.addEventListener('dragover', onDragOverList);
      l2.addEventListener('dragleave', onDragLeaveList);
      l2.addEventListener('drop', onDropList);
    }
  }

  function wireLeaf(li){
    li.addEventListener('dragstart', onDragStart);
    li.addEventListener('dragend', onDragEnd);

    const row = li.querySelector('.row');
    if (row){
      row.addEventListener('dragover', onDragOverRow);
      row.addEventListener('dragleave', onDragLeaveRow);
      row.addEventListener('drop', onDropRow);
    }

    const del = li.querySelector('.btn-del');
    if (del){
      del.addEventListener('click', ()=>{
        const label = li.querySelector('.name')?.textContent.trim() || '';
        const id = li.dataset.id;
        if (confirm(`â€˜${label}â€™ë¥¼ ì‚­ì œí• ê¹Œìš”?`)) {
          if (id && !String(id).startsWith('n')) deletedIds.add(Number(id));
          li.remove();
        }
      });
    }
  }

  // ===== API =====
  async function fetchCategories(){
    const res = await fetch(`${API_BASE}api/admin/categories`, {
      headers: CSRF_TOKEN && CSRF_HEADER ? { [CSRF_HEADER]: CSRF_TOKEN } : {}
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return res.json();
  }

  async function postJson(url, payload, method='POST'){
    const headers = { 'Content-Type': 'application/json' };
    if (CSRF_TOKEN && CSRF_HEADER) headers[CSRF_HEADER] = CSRF_TOKEN;
    const res = await fetch(url, { method, headers, body: JSON.stringify(payload), credentials:'same-origin' });
    if (!res.ok){
      const t = await res.text();
      throw new Error(`HTTP ${res.status}. body=${t.slice(0,200)}`);
    }
    const ct = res.headers.get('content-type') || '';
    if (!ct.includes('application/json')){
      const t = await res.text();
      throw new Error(`Not JSON. content-type=${ct}, body=${t.slice(0,200)}`);
    }
    return res.json();
  }

  // ===== ì§ë ¬í™” =====
  function toNumId(id) {
    return (id && !String(id).startsWith('n')) ? Number(id) : null;
  }

  function serialize(){
    const result = [];
    const l1Nodes = Array.from(document.querySelectorAll('#level1 > .node:not(.add-l1-row)'));
    l1Nodes.forEach((node, idx1) => {
      const idRaw = node.dataset.id;
      const name  = node.querySelector('.name')?.textContent.trim() || '';
      result.push({ id: toNumId(idRaw), name, parentId: null, categoryNo: idx1 + 1 });
      const l2Leaves = Array.from(node.querySelectorAll('.level-2 > .leaf:not(.add-l2-row)'));
      l2Leaves.forEach((leaf, idx2) => {
        const cidRaw = leaf.dataset.id;
        const cname  = leaf.querySelector('.name')?.textContent.trim() || '';
        result.push({ id: toNumId(cidRaw), name: cname, parentId: toNumId(idRaw), categoryNo: idx2 + 1 });
      });
    });
    return result;
  }

  // ===== ë Œë”ë§ =====
  async function renderCategories(){
    const level1 = document.getElementById('level1');
    level1.querySelectorAll('.node:not(.add-l1-row)').forEach(n => n.remove());

    const data = await fetchCategories();
    const grouped = groupByParent(data);

    (grouped[0] || []).forEach(cat => {
      level1.insertAdjacentHTML('beforeend', renderNodeHtml(cat.id, cat.name));
    });

    (grouped[0] || []).forEach(cat => {
      const ul = level1.querySelector(`[data-id="${cat.id}"] .level-2`);
      (grouped[cat.id] || []).forEach(child => {
        ul.insertAdjacentHTML('beforeend', renderLeafHtml(child.id, child.name));
      });
      ul.insertAdjacentHTML('beforeend', `
        <li class="leaf add-l2-row">
          <div class="row">
            <button class="btn-add add-l2" type="button">+</button>
            <span class="name">2ì°¨ ì¹´í…Œê³ ë¦¬ ì¶”ê°€</span>
          </div>
        </li>`);
    });

    // ìŠ¤ëƒ…ìƒ·(ì„œë²„ì— ì¡´ì¬í•˜ëŠ” idë§Œ)
    initialIdSet = new Set(data.filter(c => c.id != null).map(c => Number(c.id)));

    // ë°”ì¸ë”©
    document.querySelectorAll('#level1 > .node:not(.add-l1-row)').forEach(wireNode);
    document.querySelectorAll('.leaf').forEach(wireLeaf);

    // add-l2 ë²„íŠ¼ ë°”ì¸ë”©
    level1.querySelectorAll('.add-l2').forEach(btn => {
      if (!btn.__wired){
        btn.__wired = true;
        btn.addEventListener('click', () => {
          const addRow = btn.closest('li.add-l2-row');
          if (!addRow) return;
          const ul = addRow.parentElement;
          const cid = 'n' + Date.now();
          addRow.insertAdjacentHTML('beforebegin', leafTemplate(cid, 'ìƒˆ 2ì°¨ ì¹´í…Œê³ ë¦¬'));
          wireLeaf(addRow.previousElementSibling);
        });
      }
    });
  }

  // ===== ì‹œì‘ =====
  document.addEventListener('DOMContentLoaded', async () => {
    let idSeq = 1000;

    // ì´ˆê¸° ë°”ì¸ë”© (ê¸°ì¡´ ë Œë” ì˜ì—­ì— í•­ëª©ì´ ìˆì„ ê²½ìš°)
    document.querySelectorAll('#level1 > .node:not(.add-l1-row)').forEach(wireNode);
    document.querySelectorAll('.leaf').forEach(wireLeaf);

    // 1ì°¨ ì¶”ê°€
    const addL1Btn = document.querySelector('.add-l1');
    if (addL1Btn){
      addL1Btn.addEventListener('click', ()=>{
        const ul = document.getElementById('level1');
        const nid = 'n' + (++idSeq);
        ul.insertAdjacentHTML('beforeend', nodeTemplate(nid, '1ì°¨ ì¹´í…Œê³ ë¦¬'));
        wireNode(ul.lastElementChild);
        // 2ì°¨ ì¶”ê°€ ë²„íŠ¼ í–‰ë„ ì¶”ê°€
        const l2 = ul.lastElementChild.querySelector('.level-2');
        l2.insertAdjacentHTML('beforeend', `
          <li class="leaf add-l2-row">
            <div class="row">
              <button class="btn-add add-l2" type="button">+</button>
              <span class="name">2ì°¨ ì¹´í…Œê³ ë¦¬ ì¶”ê°€</span>
            </div>
          </li>`);
        l2.querySelector('.add-l2').addEventListener('click', () => {
          const addRow = l2.querySelector('.add-l2-row');
          const cid = 'n' + (++idSeq);
          addRow.insertAdjacentHTML('beforebegin', leafTemplate(cid, 'ìƒˆ 2ì°¨ ì¹´í…Œê³ ë¦¬'));
          wireLeaf(addRow.previousElementSibling);
        });
      });
    }

    // ìµœì´ˆ ë Œë” (ì„œë²„ ë°ì´í„° ê¸°ì¤€)
    await renderCategories();

    // ì €ì¥(ì»¤ë°‹)
    const saveBtn = document.getElementById('saveBtn');
    if (saveBtn) {
      saveBtn.addEventListener('click', async () => {
        const categories = serialize();

        // í˜„ì¬ í™”ë©´ì— ë‚¨ì•„ ìˆëŠ” DB id (ì‹ ê·œ n*** ì œì™¸)
        const currentIdSet = new Set(categories.map(x => x.id).filter(id => id != null));

        // ìŠ¤ëƒ…ìƒ· ê¸°ë°˜ ì‚­ì œ ê³„ì‚°(ê°€ì¥ ì‹ ë¢°ë„ ë†’ìŒ)
        const deletedBySnapshot = [...initialIdSet].filter(id => !currentIdSet.has(id));

        // ë²„íŠ¼ ëˆ„ì  ê¸°ë¡ê³¼ í•©ì§‘í•©(í˜¹ì‹œ ëª¨ë¥¼ ëˆ„ë½ ëŒ€ë¹„)
        const deleted = Array.from(new Set([...deletedBySnapshot, ...deletedIds]));

        const payload = { deletedIds: deleted, categories };
        console.log('ğŸ“¤ payload ì „ì†¡:', payload);

        try {
          const result = await postJson(`${API_BASE}api/admin/categories/commit`, payload, 'PUT');
          console.log('âœ… ì €ì¥ ì„±ê³µ:', result);
          deletedIds.clear();
          await renderCategories(); // DB ê¸°ì¤€ ì¬ëœë”
        } catch (err) {
          console.error('ì €ì¥ ì‹¤íŒ¨:', err);
          alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n' + err.message);
        }
      });
    }

    // ì‚¬ì´ë“œ ì•„ì½”ë””ì–¸(ê¸°ì¡´ ì½”ë“œê°€ ìˆë‹¤ë©´ ê·¸ëŒ€ë¡œ ë‘ì…”ë„ ë©ë‹ˆë‹¤)
    document.querySelectorAll('.euro-nav__title').forEach((title) => {
      title.style.cursor = 'pointer';
      title.addEventListener('click', () => {
        const group = title.parentElement;
        const list  = group.querySelector('.euro-nav__list');
        const isOpen = group.classList.contains('open');
        if (isOpen) {
          list.style.maxHeight = list.scrollHeight + 'px'; list.offsetHeight;
          list.style.maxHeight = '0px'; group.classList.remove('open');
        } else {
          group.classList.add('open');
          list.style.maxHeight = list.scrollHeight + 'px';
          const onEnd = (e) => {
            if (e.propertyName === 'max-height') {
              list.style.maxHeight = 'none';
              list.removeEventListener('transitionend', onEnd);
            }
          };
          list.addEventListener('transitionend', onEnd);
        }
      }, { capture: true });
    });
  });
</script>


<div th:replace="~{admin/_footer.html}"></div>
